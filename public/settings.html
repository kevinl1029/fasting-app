<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Fasting Forecast</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #fcd34d 0%, #fb923c 50%, #ec4899 100%);
            min-height: 100vh;
            padding-bottom: 85px;
            overflow-x: hidden;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
        }

        .settings-card {
            background: white;
            border-radius: 20px;
            padding: 25px 30px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .page-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .page-subtitle {
            font-size: 16px;
            color: #6b7280;
        }

        .settings-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #f3f4f6;
        }

        .settings-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .section-icon {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            stroke: #6366f1;
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f9fafb;
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            flex: 1;
        }

        .setting-title {
            font-size: 16px;
            font-weight: 500;
            color: #1f2937;
        }

        .setting-description {
            font-size: 14px;
            color: #6b7280;
            margin-top: 2px;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: #d1d5db;
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            flex-shrink: 0;
        }

        .toggle-switch.active {
            background: #10b981;
        }

        .toggle-switch::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-switch.active::before {
            transform: translateX(26px);
        }

        /* Mealtime Configuration */
        .mealtime-list {
            margin-top: 15px;
        }

        .mealtime-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f9fafb;
            border-radius: 12px;
            margin-bottom: 12px;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .mealtime-item:hover {
            background: #f3f4f6;
            border-color: #e5e7eb;
        }

        .mealtime-name {
            flex: 1;
            font-size: 15px;
            font-weight: 500;
            color: #1f2937;
        }

        .mealtime-time {
            font-size: 16px;
            font-weight: 600;
            color: #6366f1;
            margin-right: 12px;
        }

        .mealtime-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-edit {
            background: #dbeafe;
            color: #2563eb;
        }

        .btn-edit:hover {
            background: #bfdbfe;
        }

        .btn-remove {
            background: #fee2e2;
            color: #dc2626;
        }

        .btn-remove:hover {
            background: #fecaca;
        }

        .btn-add {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin: 20px;
            max-width: 400px;
            width: 100%;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            transition: border-color 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #6366f1;
        }

        /* Input group styles for benefits preferences */
        .input-group {
            display: flex;
            align-items: center;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            transition: border-color 0.2s ease;
        }

        .input-group:focus-within {
            border-color: #6366f1;
        }

        .input-prefix, .input-suffix {
            padding: 12px;
            background: #f9fafb;
            color: #6b7280;
            font-weight: 500;
            font-size: 14px;
        }

        .input-prefix {
            border-right: 1px solid #e5e7eb;
            border-radius: 6px 0 0 6px;
        }

        .input-suffix {
            border-left: 1px solid #e5e7eb;
            border-radius: 0 6px 6px 0;
        }

        .input-group .form-input {
            border: none;
            border-radius: 0;
            flex: 1;
        }

        .input-group .form-input:focus {
            border: none;
            box-shadow: none;
        }

        /* Benefits preferences section styles */
        .benefits-prefs-section {
            margin-top: 16px;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .benefits-prefs-section.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .btn-secondary {
            flex: 1;
            padding: 12px;
            background: #f3f4f6;
            color: #374151;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .btn-primary {
            flex: 1;
            padding: 12px;
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        /* Status indicators */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-granted {
            background: #d1fae5;
            color: #065f46;
        }

        .status-denied {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-default {
            background: #fef3c7;
            color: #92400e;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            color: #6b7280;
            padding: 8px 12px;
            border-radius: 12px;
            min-width: 60px;
            transition: all 0.3s ease;
        }

        .nav-item:hover {
            color: #fb923c;
            transform: translateY(-2px);
        }

        .nav-item.active {
            color: #fb923c;
            background: rgba(251, 146, 60, 0.1);
        }

        .nav-item.nav-primary {
            transform: scale(1.1);
            background: linear-gradient(135deg, #fcd34d 0%, #fb923c 50%, #ec4899 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(251, 146, 60, 0.3);
        }

        .nav-item.nav-primary:hover {
            transform: scale(1.15) translateY(-2px);
            box-shadow: 0 6px 20px rgba(251, 146, 60, 0.4);
            color: white;
        }

        .nav-item.nav-primary.active {
            color: white;
            background: linear-gradient(135deg, #fcd34d 0%, #fb923c 50%, #ec4899 100%);
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
            stroke-width: 2;
        }

        .nav-primary .nav-icon {
            width: 28px;
            height: 28px;
        }

        .nav-label {
            font-size: 10px;
            font-weight: 500;
            text-align: center;
            line-height: 1.2;
        }

        .nav-primary .nav-label {
            font-size: 11px;
            font-weight: 600;
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }

            .settings-card {
                padding: 20px;
                margin: 15px 0;
            }

            .nav-item {
                padding: 6px 8px;
            }

            .nav-icon {
                width: 20px;
                height: 20px;
                margin-bottom: 2px;
            }

            .nav-primary .nav-icon {
                width: 24px;
                height: 24px;
            }

            .nav-label {
                font-size: 9px;
            }

            .nav-primary .nav-label {
                font-size: 10px;
            }

            body {
                padding-bottom: 75px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="settings-card">
            <div class="page-header">
                <h1 class="page-title">Settings</h1>
                <p class="page-subtitle">Customize your fasting experience</p>
            </div>

            <!-- Hunger Coach Settings -->
            <div class="settings-section">
                <h2 class="section-title">
                    <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                    </svg>
                    Hunger Coach
                </h2>

                <!-- Notifications Toggle -->
                <div class="setting-item">
                    <div class="setting-label">
                        <div class="setting-title">Hunger Support Notifications</div>
                        <div class="setting-description" id="notificationStatus">Get helpful tips during your typical meal times</div>
                    </div>
                    <div class="toggle-switch" id="notificationToggle" onclick="toggleNotifications()"></div>
                </div>

                <!-- Notification Permission Status -->
                <div class="setting-item" id="permissionStatus">
                    <div class="setting-label">
                        <div class="setting-title">Browser Permission</div>
                        <div class="setting-description">Required for notifications to work</div>
                    </div>
                    <div class="status-indicator" id="permissionIndicator">
                        Unknown
                    </div>
                </div>

                <!-- Notification Status -->
                <div class="setting-item" id="notificationActiveStatus">
                    <div class="setting-label">
                        <div class="setting-title">Active Fast Notifications</div>
                        <div class="setting-description" id="activeStatusDescription">No active fast detected</div>
                    </div>
                    <div class="status-indicator" id="activeStatusIndicator">
                        Inactive
                    </div>
                </div>

                <!-- Next Notification -->
                <div class="setting-item" id="nextNotificationStatus" style="display: none;">
                    <div class="setting-label">
                        <div class="setting-title">Next Scheduled Notification</div>
                        <div class="setting-description" id="nextNotificationTime">--</div>
                    </div>
                </div>

                <!-- Manual Test Button -->
                <!-- Development-only test button -->
                <div class="setting-item" id="testNotificationSection" style="display: none;">
                    <div class="setting-label">
                        <div class="setting-title">Test Notifications</div>
                        <div class="setting-description">Send a test notification to verify everything works</div>
                    </div>
                    <button class="btn-primary" id="testNotificationBtn" onclick="testNotification()" style="padding: 8px 16px; font-size: 14px;">
                        Test Now
                    </button>
                </div>
            </div>

            <!-- Mealtime Settings -->
            <div class="settings-section">
                <h2 class="section-title">
                    <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12,6 12,12 16,14"/>
                    </svg>
                    Meal Times
                </h2>

                <div class="setting-item">
                    <div class="setting-label">
                        <div class="setting-title">Your Typical Eating Schedule</div>
                        <div class="setting-description">Notifications will appear around these times to provide hunger support</div>
                    </div>
                </div>

                <div class="mealtime-list" id="mealtimeList">
                    <!-- Mealtime items will be populated here -->
                </div>

                <button class="btn-add" onclick="showAddMealModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Add Meal Time
                </button>
            </div>

            <!-- Benefits Tracking Preferences -->
            <div class="settings-section">
                <h2 class="section-title">
                    <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="m9 12 2 2 4-4"/>
                    </svg>
                    Benefits Tracking
                </h2>

                <div class="setting-item">
                    <div class="setting-label">
                        <div class="setting-title">Enable Benefits Tracking</div>
                        <div class="setting-description">Track money saved and time reclaimed from fasting</div>
                    </div>
                    <div class="setting-control">
                        <div class="toggle-switch" id="benefitsToggle" onclick="toggleBenefitsEnabled()"></div>
                    </div>
                </div>

                <div id="benefitsPreferences" class="benefits-prefs-section">
                    <div class="setting-item">
                        <div class="setting-label">
                            <div class="setting-title">Average Meal Cost</div>
                            <div class="setting-description">How much do you typically spend per meal?</div>
                        </div>
                        <div class="setting-control">
                            <div class="input-group">
                                <span class="input-prefix">$</span>
                                <input type="number" id="avgMealCost" class="form-input"
                                       min="0" max="1000" step="0.01" placeholder="10.00">
                            </div>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-label">
                            <div class="setting-title">Average Meal Duration</div>
                            <div class="setting-description">How long do you typically spend eating and preparing meals?</div>
                        </div>
                        <div class="setting-control">
                            <div class="input-group">
                                <input type="number" id="avgMealDuration" class="form-input"
                                       min="5" max="240" placeholder="30">
                                <span class="input-suffix">min</span>
                            </div>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-label">
                            <div class="setting-title">Benefits Preview</div>
                            <div class="setting-description" id="benefitsPreview">
                                Based on your settings: Skipping 1 meal saves $10.00 and 30 minutes
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Meal Modal -->
    <div class="modal" id="mealModal">
        <div class="modal-content">
            <h3 class="modal-title" id="modalTitle">Add Meal Time</h3>

            <form id="mealForm">
                <div class="form-group">
                    <label class="form-label" for="mealName">Meal Name</label>
                    <input type="text" id="mealName" class="form-input" placeholder="e.g., Breakfast, Lunch, Snack" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="mealTime">Time</label>
                    <input type="time" id="mealTime" class="form-input" required>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeMealModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Save Meal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="/schedule" class="nav-item" data-page="schedule">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
            <span class="nav-label">Schedule</span>
        </a>

        <a href="/dashboard" class="nav-item" data-page="dashboard">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="20" x2="18" y2="10"/>
                <line x1="12" y1="20" x2="12" y2="4"/>
                <line x1="6" y1="20" x2="6" y2="14"/>
            </svg>
            <span class="nav-label">Dashboard</span>
        </a>

        <a href="/timer" class="nav-item nav-primary" data-page="timer">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="13" r="9"/>
                <polyline points="12,7 12,13 16,15"/>
                <path d="M9,2 L15,2"/>
                <path d="M12,2 L12,6"/>
            </svg>
            <span class="nav-label">Timer</span>
        </a>

        <a href="/learning" class="nav-item" data-page="learning">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
            </svg>
            <span class="nav-label">Learning Hub</span>
        </a>

        <a href="/settings" class="nav-item active" data-page="settings">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"/>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
            </svg>
            <span class="nav-label">Settings</span>
        </a>
    </nav>

    <!-- Global Notification Manager -->
    <script src="/js/modules/hunger-coach.js"></script>
    <script src="/js/modules/global-notification-manager.js"></script>

    <script>
        // Settings state
        let userSettings = {
            hunger_coach_enabled: true,
            custom_mealtimes: [
                { name: 'Breakfast', time: '08:00' },
                { name: 'Lunch', time: '12:00' },
                { name: 'Dinner', time: '18:00' }
            ],
            // Benefits tracking preferences
            benefits_enabled: true,
            avg_meal_cost: 10.00,
            avg_meal_duration: 30,
            benefits_onboarded: false
        };

        let editingIndex = -1;
        // Session management - moved to initializeSettingsPage()
        // const sessionId = window.getSessionId();
        let sessionId = null; // Will be set when session is ready

        // Initialize page - moved to session ready callback
        // document.addEventListener('DOMContentLoaded', async () => {

        // New initialization function that waits for session
        async function initializeSettingsPage() {
            console.log('Initializing settings page with session ready');

            // Get session ID now that it's ready
            sessionId = window.getSessionId();
            console.log('Settings page using session ID:', sessionId);

            if (!sessionId) {
                console.error('No session ID available');
                alert('No session found. Please go through onboarding first.');
                window.location.href = '/';
                return;
            }

            // Show test button only in development
            const isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            if (isDevelopment) {
                const testSection = document.getElementById('testNotificationSection');
                if (testSection) {
                    testSection.style.display = 'flex';
                }
            }

            await loadUserSettings();
            updateUI();
            updateActiveNavItem();
        }

        // Load user settings from backend API
        async function loadUserSettings() {
            if (!sessionId) return;

            try {
                const response = await fetch(`/api/user/settings?sessionId=${sessionId}`);
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        // Merge loaded settings with defaults to ensure all properties exist
                        userSettings = {
                            ...userSettings,
                            hunger_coach_enabled: result.data.hunger_coach_enabled,
                            custom_mealtimes: result.data.custom_mealtimes || userSettings.custom_mealtimes,
                            avg_meal_cost: result.data.avg_meal_cost || userSettings.avg_meal_cost,
                            avg_meal_duration: result.data.avg_meal_duration || userSettings.avg_meal_duration,
                            benefits_enabled: result.data.benefits_enabled !== false, // Default to true
                            benefits_onboarded: result.data.benefits_onboarded || false
                        };
                    }
                } else {
                    console.error('Failed to load user settings:', response.status);
                    // Keep defaults if load fails
                }
            } catch (error) {
                console.error('Error loading user settings:', error);
                // Keep defaults if load fails
            }
        }

        // Save user settings to backend API
        async function saveUserSettings() {
            if (!sessionId) return;

            try {
                // Use the unified settings endpoint that supports both hunger coach and benefits
                const response = await fetch('/api/user/settings', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-session-id': sessionId
                    },
                    body: JSON.stringify({
                        hunger_coach_enabled: userSettings.hunger_coach_enabled,
                        custom_mealtimes: userSettings.custom_mealtimes,
                        avg_meal_cost: userSettings.avg_meal_cost,
                        avg_meal_duration: userSettings.avg_meal_duration,
                        benefits_enabled: userSettings.benefits_enabled,
                        benefits_onboarded: userSettings.benefits_onboarded
                    })
                });

                if (!response.ok) {
                    console.error('Failed to save user settings:', response.status);
                    alert('Failed to save settings. Please try again.');
                }
            } catch (error) {
                console.error('Error saving user settings:', error);
                alert('Failed to save settings. Please try again.');
            }
        }

        // Update UI based on current settings
        async function updateUI() {
            // Update notification toggle
            const toggle = document.getElementById('notificationToggle');
            toggle.classList.toggle('active', userSettings.hunger_coach_enabled);

            // Update notification status text
            const statusText = document.getElementById('notificationStatus');
            if (userSettings.hunger_coach_enabled) {
                statusText.textContent = 'Get helpful tips during your typical meal times';
            } else {
                statusText.textContent = 'Hunger notifications are disabled';
            }

            // Update permission status
            updatePermissionStatus();

            // Update notification status
            await updateNotificationStatus();

            // Update benefits preferences UI
            updateBenefitsUI();

            // Update mealtime list
            updateMealtimeList();
        }

        // Update browser permission status
        function updatePermissionStatus() {
            const permissionSection = document.getElementById('permissionStatus');
            const indicator = document.getElementById('permissionIndicator');

            if ('Notification' in window) {
                const permission = Notification.permission;
                indicator.className = 'status-indicator';

                switch (permission) {
                    case 'granted':
                        indicator.classList.add('status-granted');
                        indicator.textContent = 'Granted';
                        break;
                    case 'denied':
                        indicator.classList.add('status-denied');
                        indicator.textContent = 'Denied';
                        break;
                    default:
                        indicator.classList.add('status-default');
                        indicator.textContent = 'Not Set';
                }
            } else {
                permissionSection.style.display = 'none';
            }
        }

        // Update notification status
        async function updateNotificationStatus() {
            if (!globalNotificationManager) return;

            const status = await globalNotificationManager.getNotificationStatus();
            const activeIndicator = document.getElementById('activeStatusIndicator');
            const activeDescription = document.getElementById('activeStatusDescription');
            const nextNotificationSection = document.getElementById('nextNotificationStatus');
            const nextNotificationTime = document.getElementById('nextNotificationTime');

            // Update active fast status
            activeIndicator.className = 'status-indicator';
            if (status.hasActiveFast && status.isAvailable) {
                activeIndicator.classList.add('status-granted');
                activeIndicator.textContent = 'Active';
                activeDescription.textContent = `Notifications scheduled for ${status.scheduledCount} meal times`;
            } else if (status.hasActiveFast && !status.isAvailable) {
                activeIndicator.classList.add('status-denied');
                activeIndicator.textContent = 'Permission Needed';
                activeDescription.textContent = 'Active fast detected but notifications need permission';
            } else {
                activeIndicator.classList.add('status-default');
                activeIndicator.textContent = 'Inactive';
                activeDescription.textContent = 'No active fast detected';
            }

            // Update next notification time
            if (status.nextScheduled && status.hasActiveFast) {
                nextNotificationSection.style.display = 'flex';
                nextNotificationTime.textContent = status.nextScheduled.toLocaleString();
            } else {
                nextNotificationSection.style.display = 'none';
            }
        }

        // === DEBUGGING HELPERS ===

        // Add global debugging functions for console use
        window.debugNotifications = {
            // Check current notification status
            async getStatus() {
                const status = await globalNotificationManager.getNotificationStatus();
                console.table(status);
                return status;
            },

            // Check active fast state
            checkActiveFast() {
                const fast = globalNotificationManager.getActiveFastState();
                console.log('Active Fast:', fast);
                return fast;
            },

            // Clear notification history (for testing)
            clearHistory() {
                localStorage.removeItem('fasting_last_notification');
                console.log('âœ… Cleared notification history');
            },

            // Manually trigger notification check
            async triggerCheck() {
                console.log('ðŸ” Manually triggering notification check...');
                await globalNotificationManager.checkAndSendPendingNotifications();
            },

            // Show scheduled notifications
            showScheduled() {
                const scheduled = Array.from(globalNotificationManager.scheduledNotifications.values());
                console.log('ðŸ“… Scheduled Notifications:');
                console.table(scheduled);
                return scheduled;
            },

            // Force direct notifications (bypass service worker)
            forceDirectNotifications() {
                globalNotificationManager.serviceWorkerRegistration = null;
                console.log('ðŸ”„ Service worker disabled - notifications will use direct path');
            },

            // Re-enable service worker notifications
            async reEnableServiceWorker() {
                await globalNotificationManager.registerServiceWorker();
                console.log('ðŸ”„ Service worker re-enabled');
            },

            // Check service worker status
            async checkServiceWorker() {
                const reg = await navigator.serviceWorker.getRegistration();
                console.log('ðŸ”§ Service Worker Registration:', reg);
                console.log('ðŸ” Active:', reg?.active);
                console.log('ðŸ” Installing:', reg?.installing);
                console.log('ðŸ” Waiting:', reg?.waiting);
                return reg;
            },

            // Test both notification paths
            async testBothPaths() {
                console.log('ðŸ§ª Testing both notification paths...');

                // Test service worker path
                console.log('1ï¸âƒ£ Testing SERVICE WORKER path:');
                await window.debugNotifications.reEnableServiceWorker();
                await new Promise(resolve => setTimeout(resolve, 100)); // Brief wait

                const testMeal = { name: 'Test-SW', time: '00:00' };
                await globalNotificationManager.sendHungerNotification(testMeal);

                await new Promise(resolve => setTimeout(resolve, 2000)); // Wait 2 seconds

                // Test direct path
                console.log('2ï¸âƒ£ Testing DIRECT path:');
                window.debugNotifications.forceDirectNotifications();
                await new Promise(resolve => setTimeout(resolve, 100)); // Brief wait

                const testMeal2 = { name: 'Test-Direct', time: '00:00' };
                await globalNotificationManager.sendHungerNotification(testMeal2);

                console.log('âœ… Both tests completed');
            }
        };

        console.log('ðŸ”§ Debug tools available: window.debugNotifications');

        // Test notification function
        async function testNotification() {
            const testBtn = document.getElementById('testNotificationBtn');
            testBtn.textContent = 'Testing...';
            testBtn.disabled = true;

            try {
                // Request permission if needed
                if (!globalNotificationManager.isNotificationAvailable()) {
                    const granted = await globalNotificationManager.requestNotificationPermission();
                    if (!granted) {
                        alert('Please enable notifications in your browser settings to test.');
                        return;
                    }
                }

                // Send test notification
                const testMessage = 'ðŸ§ª Test: Hunger pangs are often habit signals â€” most waves pass within 15â€“20 minutes.';
                const testNotification = new Notification(testMessage, {
                    icon: '/favicon.svg',
                    badge: '/favicon.svg',
                    tag: 'hunger-coach-test',
                    requireInteraction: false,
                    silent: true
                });

                // Auto-close after 4 seconds
                setTimeout(() => {
                    testNotification.close();
                }, 4000);

                // Update UI
                updateUI();

                alert('Test notification sent! You should see it appear now.');

            } catch (error) {
                console.error('Error sending test notification:', error);
                alert('Failed to send test notification. Please check your browser settings.');
            } finally {
                testBtn.textContent = 'Test Now';
                testBtn.disabled = false;
            }
        }

        // Toggle notifications
        function toggleNotifications() {
            userSettings.hunger_coach_enabled = !userSettings.hunger_coach_enabled;

            // Request permission if enabling notifications
            if (userSettings.hunger_coach_enabled && 'Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(() => {
                    updateUI();
                    saveUserSettings();
                });
            } else {
                updateUI();
                saveUserSettings();
            }
        }

        // Update mealtime list
        function updateMealtimeList() {
            const list = document.getElementById('mealtimeList');
            list.innerHTML = '';

            userSettings.custom_mealtimes.forEach((meal, index) => {
                const item = document.createElement('div');
                item.className = 'mealtime-item';
                item.innerHTML = `
                    <div class="mealtime-name">${meal.name}</div>
                    <div class="mealtime-time">${formatTime(meal.time)}</div>
                    <div class="mealtime-actions">
                        <button class="btn-icon btn-edit" onclick="editMeal(${index})">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                        </button>
                        <button class="btn-icon btn-remove" onclick="removeMeal(${index})">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3,6 5,6 21,6"/>
                                <path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6m3,0V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"/>
                            </svg>
                        </button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        // Format time for display
        function formatTime(time24) {
            const [hours, minutes] = time24.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
            return `${displayHour}:${minutes} ${ampm}`;
        }

        // Show add meal modal
        function showAddMealModal() {
            editingIndex = -1;
            document.getElementById('modalTitle').textContent = 'Add Meal Time';
            document.getElementById('mealName').value = '';
            document.getElementById('mealTime').value = '';
            document.getElementById('mealModal').classList.add('active');
        }

        // Edit meal
        function editMeal(index) {
            editingIndex = index;
            const meal = userSettings.custom_mealtimes[index];
            document.getElementById('modalTitle').textContent = 'Edit Meal Time';
            document.getElementById('mealName').value = meal.name;
            document.getElementById('mealTime').value = meal.time;
            document.getElementById('mealModal').classList.add('active');
        }

        // Remove meal
        function removeMeal(index) {
            if (userSettings.custom_mealtimes.length <= 1) {
                alert('You must have at least one meal time configured.');
                return;
            }

            if (confirm('Remove this meal time?')) {
                userSettings.custom_mealtimes.splice(index, 1);
                updateUI();
                saveUserSettings();
            }
        }

        // Close meal modal
        function closeMealModal() {
            document.getElementById('mealModal').classList.remove('active');
            editingIndex = -1;
        }

        // Handle meal form submission
        document.getElementById('mealForm').addEventListener('submit', (e) => {
            e.preventDefault();

            const name = document.getElementById('mealName').value.trim();
            const time = document.getElementById('mealTime').value;

            if (!name || !time) {
                alert('Please fill in all fields.');
                return;
            }

            const mealData = { name, time };

            if (editingIndex >= 0) {
                userSettings.custom_mealtimes[editingIndex] = mealData;
            } else {
                userSettings.custom_mealtimes.push(mealData);
                // Sort mealtimes by time
                userSettings.custom_mealtimes.sort((a, b) => a.time.localeCompare(b.time));
            }

            updateUI();
            saveUserSettings();
            closeMealModal();
        });

        // Update active navigation item
        function updateActiveNavItem() {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('href') === '/settings') {
                    item.classList.add('active');
                }
            });
        }

        // Benefits Tracking Functions
        function updateBenefitsUI() {
            // Update benefits enabled toggle
            const benefitsToggle = document.getElementById('benefitsToggle');
            if (benefitsToggle) {
                benefitsToggle.classList.toggle('active', userSettings.benefits_enabled);
            }

            // Update benefits preferences section visibility
            const benefitsSection = document.getElementById('benefitsPreferences');
            if (benefitsSection) {
                benefitsSection.classList.toggle('disabled', !userSettings.benefits_enabled);
            }

            // Update meal cost input
            const mealCostInput = document.getElementById('avgMealCost');
            if (mealCostInput) {
                mealCostInput.value = userSettings.avg_meal_cost;
            }

            // Update meal duration input
            const mealDurationInput = document.getElementById('avgMealDuration');
            if (mealDurationInput) {
                mealDurationInput.value = userSettings.avg_meal_duration;
            }

            // Update benefits preview
            updateBenefitsPreview();
        }

        function updateBenefitsPreview() {
            const previewElement = document.getElementById('benefitsPreview');
            if (!previewElement) return;

            const cost = userSettings.avg_meal_cost;
            const duration = userSettings.avg_meal_duration;

            if (userSettings.benefits_enabled) {
                previewElement.textContent = `Based on your settings: Skipping 1 meal saves $${cost.toFixed(2)} and ${duration} minutes`;
            } else {
                previewElement.textContent = 'Benefits tracking is disabled';
            }
        }

        function toggleBenefitsEnabled() {
            userSettings.benefits_enabled = !userSettings.benefits_enabled;
            userSettings.benefits_onboarded = true; // Mark as onboarded when they interact
            updateUI();
            saveUserSettings();
        }

        function updateMealCost() {
            const input = document.getElementById('avgMealCost');
            if (!input) return;

            const value = parseFloat(input.value);
            if (!isNaN(value) && value >= 0 && value <= 1000) {
                userSettings.avg_meal_cost = value;
                userSettings.benefits_onboarded = true; // Mark as onboarded when they interact
                updateBenefitsPreview();
                saveUserSettings();
            }
        }

        function updateMealDuration() {
            const input = document.getElementById('avgMealDuration');
            if (!input) return;

            const value = parseInt(input.value);
            if (!isNaN(value) && value >= 5 && value <= 240) {
                userSettings.avg_meal_duration = value;
                userSettings.benefits_onboarded = true; // Mark as onboarded when they interact
                updateBenefitsPreview();
                saveUserSettings();
            }
        }

        // Add event listeners when page loads (but don't initialize session-dependent functionality)
        document.addEventListener('DOMContentLoaded', function() {
            // Benefits toggle is handled by onclick in HTML

            // Meal cost input
            const mealCostInput = document.getElementById('avgMealCost');
            if (mealCostInput) {
                mealCostInput.addEventListener('input', updateMealCost);
                mealCostInput.addEventListener('blur', updateMealCost);
            }

            // Meal duration input
            const mealDurationInput = document.getElementById('avgMealDuration');
            if (mealDurationInput) {
                mealDurationInput.addEventListener('input', updateMealDuration);
                mealDurationInput.addEventListener('blur', updateMealDuration);
            }

            // Handle URL hash for direct navigation to benefits section
            if (window.location.hash === '#benefits') {
                const benefitsSection = document.querySelector('.benefits-prefs-section');
                if (benefitsSection) {
                    benefitsSection.scrollIntoView({ behavior: 'smooth' });
                }
            }
        });
    </script>

    <!-- Session Management -->
    <script src="/js/modules/session-manager.js"></script>
    <script src="/js/modules/page-session-guard.js"></script>
    <script>
        // Initialize session management first
        const pageGuard = new window.FastingForecastPageSessionGuard();
        window.pageGuard = pageGuard; // Make it available globally for getSessionId()

        // Wait for session to be ready before continuing with page logic
        pageGuard.waitForReady().then(() => {
            console.log('Session manager ready for settings.html');

            // Now that session is ready, initialize the settings page
            console.log('Starting settings page initialization with session ready');
            initializeSettingsPage();
        });
    </script>
</body>
</html>