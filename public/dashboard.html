<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Fasting Forecast</title>
    <link rel="stylesheet" href="/css/navigation.css">
    <link rel="stylesheet" href="/css/modal.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #fcd34d 0%, #fb923c 50%, #ec4899 100%);
            min-height: 100vh;
            padding-bottom: 85px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
        }
        
        .dashboard-card {
            background: white;
            border-radius: 20px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            min-height: calc(100vh - 140px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .header {
            padding: 30px 30px 20px;
            text-align: center;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }
        
        .header p {
            color: #666;
            font-size: 0.95rem;
        }
        
        /* Active Fast Section */
        .active-fast-section {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.08), rgba(22, 163, 74, 0.06));
            border: 1px solid rgba(34, 197, 94, 0.15);
            border-radius: 16px;
            margin: 20px 30px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .active-fast-section.hidden {
            display: none;
        }

        /* General hidden class for cards */
        .hidden {
            display: none !important;
        }

        .active-fast-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(34, 197, 94, 0.15);
        }

        .active-fast-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #059669;
            margin: 0;
        }

        .fast-duration {
            font-size: 1rem;
            font-weight: 700;
            color: #047857;
            background: rgba(34, 197, 94, 0.1);
            padding: 4px 12px;
            border-radius: 8px;
        }

        /* Dashboard-specific card styles (inherit from timer cards but adapt for dashboard) */
        .active-fast-section .hunger-coach-card,
        .active-fast-section .benefits-card {
            margin: 16px 0 0 0;
            padding: 20px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.8));
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            min-height: 100px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .active-fast-section .hunger-coach-card:hover,
        .active-fast-section .benefits-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .active-fast-section .hunger-coach-card.expanded,
        .active-fast-section .benefits-card.expanded {
            min-height: 140px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        /* Sub-navigation tabs */
        .sub-nav {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        
        .sub-nav-item {
            flex: 1;
            padding: 16px 12px;
            text-align: center;
            background: none;
            border: none;
            color: #666;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .sub-nav-item:hover {
            color: #fb923c;
            background: rgba(251, 146, 60, 0.05);
        }
        
        .sub-nav-item.active {
            color: #fb923c;
            background: rgba(251, 146, 60, 0.1);
        }
        
        .sub-nav-item.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #fb923c;
            border-radius: 3px 3px 0 0;
        }
        
        .sub-nav-item.disabled {
            color: #ccc;
            cursor: not-allowed;
        }
        
        .sub-nav-item.disabled:hover {
            color: #ccc;
            background: none;
        }
        
        /* Content area */
        .content {
            flex: 1;
            overflow-y: auto;
        }
        
        .tab-content {
            display: none;
            padding: 0;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Log tab styles */
        .log-header {
            padding: 16px 30px 24px 30px;
            background: linear-gradient(135deg, rgba(252, 211, 77, 0.1) 0%, rgba(251, 146, 60, 0.05) 100%);
            border-bottom: 1px solid #f0f0f0;
        }

        .log-stats {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px 48px;
            margin-bottom: 12px;
            margin-top: 20px;
            flex-wrap: nowrap;
        }

        .log-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            min-width: 0;
        }

        .log-stat-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: #fb923c;
            white-space: nowrap;
        }

        .log-stat-label {
            font-size: 0.7rem;
            color: #666;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: center;
            line-height: 1.2;
            white-space: nowrap;
        }
        
        .add-fast-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #fcd34d 0%, #fb923c 50%, #ec4899 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .add-fast-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(251, 146, 60, 0.3);
        }

        .log-controls {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .log-filters {
            display: flex;
            gap: 8px;
            background: white;
            padding: 4px;
            border-radius: 12px;
            border: 1px solid #f0f0f0;
            box-shadow: 0 8px 18px rgba(15, 23, 42, 0.08);
        }

        .log-filter-btn {
            flex: 1;
            border: none;
            background: transparent;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .log-filter-btn:hover:not(.active) {
            background: rgba(251, 146, 60, 0.1);
            color: #fb923c;
        }

        .log-filter-btn.active {
            background: linear-gradient(135deg, #f97316 0%, #ec4899 100%);
            color: white;
            box-shadow: 0 8px 18px rgba(236, 72, 153, 0.3);
        }

        .log-action {
            position: relative;
            display: flex;
            justify-content: center;
        }

        .log-action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .log-action-btn svg {
            display: block;
        }

        .log-action-chevron {
            font-size: 0.8rem;
            margin-left: auto;
        }

        .log-action-menu {
            position: absolute;
            top: calc(100% + 6px);
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.25);
            box-shadow: 0 24px 40px rgba(15, 23, 42, 0.22);
            padding: 6px;
            min-width: 200px;
            z-index: 30;
        }

        .log-action-menu-item {
            width: 100%;
            background: transparent;
            border: none;
            text-align: left;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            color: #1f2937;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .log-action-menu-item:hover {
            background: rgba(251, 146, 60, 0.14);
            color: #fb923c;
        }

        .chart-card {
            margin: 20px 16px;
            background: white;
            border-radius: 18px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
            padding: 20px 24px;
        }

        .chart-card-header {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 16px;
        }

        .chart-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .insight-info {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 26px;
            height: 26px;
            min-width: 26px;
            border-radius: 999px;
            background: #eff6ff;
            color: #2563eb;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: background 0.2s;
        }

        .insight-info:hover {
            background: #dbeafe;
        }

        .insight-info:active {
            background: #bfdbfe;
        }

        .insight-tooltip {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: rgba(15, 23, 42, 0.97);
            color: #fff;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 0.85rem;
            line-height: 1.5;
            width: max-content;
            max-width: 280px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 1000;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.25);
            font-weight: 400;
        }

        .insight-tooltip.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .insight-tooltip::before {
            content: '';
            position: absolute;
            top: -6px;
            right: 8px;
            width: 12px;
            height: 12px;
            background: rgba(15, 23, 42, 0.97);
            transform: rotate(45deg);
        }

        .chart-card-header h3 {
            font-size: 1.2rem;
            font-weight: 700;
            color: #0f172a;
        }

        .chart-subtitle {
            font-size: 0.9rem;
            color: #64748b;
            margin-top: 4px;
        }

        .chart-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .chart-toggle {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            color: #475569;
            font-weight: 600;
            cursor: pointer;
        }

        .chart-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .chart-expand-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border: 1px solid #e2e8f0;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 6px;
            cursor: pointer;
            color: #64748b;
            transition: all 0.2s;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .chart-expand-btn:hover {
            background: #fff;
            border-color: #cbd5e1;
            color: #475569;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .chart-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9999;
            padding: 20px;
            overflow: auto;
        }

        .chart-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chart-modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px 0;
            max-width: 1200px;
            width: 100%;
            max-height: 90vh;
            overflow: auto;
            position: relative;
        }

        .chart-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 24px;
        }

        .chart-modal-close {
            width: 36px;
            height: 36px;
            border: none;
            background: #f1f5f9;
            border-radius: 8px;
            cursor: pointer;
            color: #64748b;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .chart-modal-close:hover {
            background: #e2e8f0;
            color: #475569;
        }

        .chart-view-filters {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .chart-view-filter {
            padding: 6px 14px;
            border: 1px solid #e2e8f0;
            background: #fff;
            color: #64748b;
            font-size: 0.85rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chart-view-filter:hover {
            border-color: #cbd5e1;
            background: #f8fafc;
        }

        .chart-view-filter.active {
            background: #2563eb;
            border-color: #2563eb;
            color: #fff;
        }

        .chart-container {
            position: relative;
            width: 100%;
            overflow: hidden;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            background: linear-gradient(180deg, rgba(248, 250, 252, 0.9), rgba(255, 255, 255, 0.7));
        }

        /* Full-width chart styling for modal */
        .chart-container-modal {
            margin: 0 !important;
            padding: 0 !important;
        }

        .chart-legend-modal,
        .chart-footnote-modal {
            padding: 0 24px;
        }

        .chart-svg {
            width: 100%;
            height: 360px;
        }

        .chart-svg .data-point {
            cursor: pointer;
        }

        .chart-svg .data-point:hover {
            filter: brightness(1.1);
        }

        .chart-tooltip {
            position: absolute;
            background: rgba(15, 23, 42, 0.95);
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .chart-tooltip.visible {
            opacity: 1;
        }

        .chart-legend {
            margin-top: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 0.85rem;
            color: #475569;
        }

        .legend-item {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .legend-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .legend-dot.solid {
            background: #fb923c;
        }

        .legend-dot.hollow {
            border: 2px solid #38bdf8;
            border-radius: 50%;
            width: 10px;
            height: 10px;
        }

        .legend-fast-band {
            display: inline-block;
            width: 20px;
            height: 10px;
            border-radius: 4px;
            background: rgba(56, 189, 248, 0.2);
            border: 1px solid rgba(56, 189, 248, 0.6);
        }

        .chart-footnote {
            margin-top: 12px;
            font-size: 0.8rem;
            color: #94a3b8;
        }

        /* Fasting log list */
        .fasting-log {
            padding: 0;
        }
        
        .log-empty {
            padding: 60px 30px;
            text-align: center;
            color: #666;
        }
        
        .log-empty-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            opacity: 0.3;
            stroke-width: 1;
        }
        
        .log-empty h3 {
            font-size: 1.1rem;
            margin-bottom: 8px;
            color: #999;
        }
        
        .log-empty p {
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .fast-item {
            padding: 20px 30px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .fast-item:hover {
            background: rgba(251, 146, 60, 0.02);
        }
        
        .fast-item:last-child {
            border-bottom: none;
        }
        
        .fast-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .fast-dates {
            flex: 1;
        }
        
        .fast-date-range {
            font-size: 0.9rem;
            color: #333;
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .fast-duration {
            font-size: 0.8rem;
            color: #666;
        }
        
        .fast-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }
        
        .fast-indicator .indicator-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .fast-indicator .indicator-dot.live {
            background: #28a745;
        }
        
        .fast-indicator .indicator-dot.manual {
            background: #6c757d;
        }
        
        .fast-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }
        
        .body-log-day {
            margin: 16px 30px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
            overflow: hidden;
        }

        .body-log-day-header {
            width: 100%;
            padding: 16px 20px;
            background: linear-gradient(135deg, rgba(226, 232, 240, 0.55), rgba(226, 232, 240, 0.25));
            border: none;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .body-log-day-header:hover {
            background: linear-gradient(135deg, rgba(226, 232, 240, 0.7), rgba(226, 232, 240, 0.32));
        }

        .body-log-day-header-date {
            font-size: 1rem;
            font-weight: 700;
            color: #1f2937;
        }

        .body-log-day-summary {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.9rem;
            color: #475569;
        }

        .body-log-day-summary .summary-weight {
            font-weight: 700;
            color: #0f172a;
        }

        .body-log-day-summary .summary-bodyfat {
            color: #334155;
            font-weight: 600;
        }

        .body-log-day-toggle-icon {
            font-size: 0.8rem;
            color: #64748b;
        }

        .body-log-entries {
            padding: 12px 20px 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .body-log-day.collapsed .body-log-entries {
            display: none;
        }

        .body-log-entry {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 12px 16px;
            border-radius: 12px;
            background: #f8fafc;
            border: 1px solid rgba(226, 232, 240, 0.9);
        }

        .body-log-entry.canonical {
            border-color: rgba(59, 130, 246, 0.45);
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(14, 116, 144, 0.08));
        }

        .body-log-entry-header {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .body-log-metric {
            font-size: 1.4rem;
            font-weight: 700;
            color: #111827;
        }

        .body-log-bodyfat {
            font-size: 1rem;
            font-weight: 600;
            color: #1e293b;
        }

        .body-log-tag {
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            background: rgba(148, 163, 184, 0.2);
            color: #475569;
        }

        .body-log-tag.morning {
            background: rgba(59, 130, 246, 0.2);
            color: #1d4ed8;
        }

        .body-log-tag.post_fast {
            background: rgba(34, 197, 94, 0.2);
            color: #047857;
        }

        .body-log-tag.ad_hoc {
            background: rgba(248, 113, 113, 0.2);
            color: #b91c1c;
        }

        .body-log-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 0.85rem;
            color: #64748b;
        }

        .body-log-notes {
            font-size: 0.9rem;
            color: #475569;
        }

        .body-log-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .body-log-action-btn {
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 0.8rem;
            font-weight: 600;
            color: #475569;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .body-log-action-btn:hover {
            border-color: #94a3b8;
            color: #1f2937;
        }

        .body-log-action-btn.danger {
            border-color: rgba(248, 113, 113, 0.4);
            color: #b91c1c;
        }

        .body-log-canonical-pill {
            padding: 5px 12px;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 700;
            background: rgba(59, 130, 246, 0.2);
            color: #1d4ed8;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .body-log-canonical-pill.manual {
            background: rgba(14, 116, 144, 0.22);
            color: #0f172a;
        }

        .weekly-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .weekly-empty {
            padding: 14px 16px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px dashed #cbd5e1;
            color: #64748b;
            text-align: center;
        }

        .weekly-row {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 12px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid rgba(226, 232, 240, 0.9);
            padding: 12px 16px;
        }

        .weekly-row.header {
            background: none;
            border: none;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #64748b;
        }

        .weekly-col {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .weekly-label {
            font-size: 0.8rem;
            color: #64748b;
        }

        .weekly-value {
            font-size: 1rem;
            font-weight: 600;
            color: #0f172a;
        }

        .weekly-delta {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .weekly-delta.positive {
            color: #16a34a;
        }

        .weekly-delta.negative {
            color: #dc2626;
        }

        .retention-content {
            background: #f8fafc;
            border-radius: 14px;
            border: 1px solid rgba(226, 232, 240, 0.9);
            padding: 18px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .insight-placeholder {
            padding: 24px;
            text-align: center;
            color: #64748b;
            font-size: 0.95rem;
        }

        .effectiveness-content {
            border-top: 1px solid #e2e8f0;
            padding-top: 18px;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .effectiveness-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 18px;
            font-size: 0.82rem;
            color: #475569;
        }

        .summary-item {
            display: inline-flex;
            align-items: baseline;
            gap: 6px;
        }

        .summary-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #64748b;
        }

        .summary-value {
            font-weight: 600;
            color: #0f172a;
        }

        .summary-note {
            color: #64748b;
        }

        .effectiveness-bar {
            position: relative;
            height: 14px;
            border-radius: 999px;
            background: #e2e8f0;
            overflow: hidden;
            display: flex;
        }

        .bar-segment {
            height: 100%;
        }

        .bar-fat {
            background: #22c55e;
        }

        .bar-muscle {
            background: #fb923c;
        }

        .bar-fluid {
            background: #38bdf8;
        }

        .effectiveness-bar-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 0.75rem;
            color: #475569;
        }

        .legend-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .legend-chip {
            width: 10px;
            height: 10px;
            border-radius: 999px;
        }

        .legend-chip.fat {
            background: #22c55e;
        }

        .legend-chip.muscle {
            background: #fb923c;
        }

        .legend-chip.fluid {
            background: #38bdf8;
        }

        .composition-row {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 8px;
        }

        @media (max-width: 720px) {
            .composition-row {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            }
        }

        .component-card {
            border: 1px solid #e2e8f0;
            border-radius: 14px;
            background: #ffffff;
            padding: 10px 12px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .component-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .component-icon {
            font-size: 1.1rem;
        }

        .component-label {
            font-size: 0.7rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: #64748b;
        }

        .component-value {
            font-size: 1.15rem;
            font-weight: 700;
            color: #0f172a;
        }

        .component-meta {
            font-size: 0.68rem;
            color: #475569;
            line-height: 1.3;
        }

        .component-info {
            border: none;
            background: rgba(148, 163, 184, 0.18);
            color: #475569;
            width: 18px;
            height: 18px;
            border-radius: 999px;
            font-size: 0.65rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .component-info:hover,
        .component-info:focus {
            background: rgba(148, 163, 184, 0.32);
            outline: none;
        }

        .component-info::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%) translateY(4px);
            padding: 8px 10px;
            background: #0f172a;
            color: #f8fafc;
            font-size: 0.7rem;
            line-height: 1.3;
            border-radius: 8px;
            box-shadow: 0 6px 18px rgba(15, 23, 42, 0.25);
            width: max-content;
            max-width: 220px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s ease, transform 0.15s ease;
            z-index: 5;
        }

        .component-info::before {
            content: '';
            position: absolute;
            bottom: calc(100% + 2px);
            left: 50%;
            transform: translateX(-50%) translateY(4px);
            width: 8px;
            height: 8px;
            background: #0f172a;
            clip-path: polygon(50% 100%, 0 0, 100% 0);
            opacity: 0;
            transition: opacity 0.15s ease;
            z-index: 5;
        }

        .component-info:hover::after,
        .component-info:focus::after,
        .component-info:hover::before,
        .component-info:focus::before {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .component-fat {
            border-top: 3px solid #22c55e;
        }

        .component-muscle {
            border-top: 3px solid #fb923c;
        }

        .component-fluid {
            border-top: 3px solid #38bdf8;
            background: linear-gradient(180deg, #f0f9ff 0%, #ffffff 90%);
        }

        .effectiveness-tags {
            display: inline-flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .effectiveness-tag {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 999px;
            background: #e0f2fe;
            color: #0369a1;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .effectiveness-message {
            font-size: 0.95rem;
            color: #334155;
            line-height: 1.5;
        }

        .effectiveness-meta {
            font-size: 0.82rem;
            color: #64748b;
        }

        .fluid-toggle-btn {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #bae6fd;
            border-radius: 12px;
            background: rgba(191, 219, 254, 0.35);
            color: #0369a1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .fluid-toggle-btn:hover {
            background: rgba(191, 219, 254, 0.55);
        }

        #fluid-toggle-icon {
            font-size: 0.7rem;
        }

        .fluid-breakdown {
            margin-top: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            background: #f8fafc;
            padding: 12px 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .fluid-breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .fluid-breakdown-left {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .fluid-icon {
            font-size: 1.1rem;
        }

        .fluid-label {
            font-weight: 600;
            color: #0f172a;
        }

        .fluid-note {
            font-size: 0.78rem;
            color: #64748b;
        }

        .fluid-value {
            font-weight: 600;
            color: #0f172a;
        }

        .rolling-content {
            border-top: 1px solid #e2e8f0;
            padding-top: 18px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .rolling-overview {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
        }

        .rolling-metric {
            flex: 1;
            min-width: 140px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 14px;
            padding: 14px 16px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .rolling-label {
            font-size: 0.78rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #64748b;
        }

        .rolling-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: #0f172a;
        }

        .rolling-protocol-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .rolling-protocol {
            border: 1px solid #e2e8f0;
            border-radius: 14px;
            background: #ffffff;
            padding: 14px 16px;
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.06);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .rolling-protocol-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            gap: 8px;
        }

        .rolling-protocol-name {
            font-weight: 600;
            color: #0f172a;
            font-size: 1rem;
        }

        .rolling-protocol-count {
            font-size: 0.8rem;
            color: #64748b;
        }

        .rolling-protocol-metrics {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 0.85rem;
            color: #475569;
        }

        .rolling-footnote {
            font-size: 0.8rem;
            color: #64748b;
        }

        .retention-highlight {
            font-size: 2rem;
            font-weight: 700;
            color: #0f172a;
        }

        .retention-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .retention-detail {
            background: white;
            border-radius: 10px;
            border: 1px solid rgba(226, 232, 240, 0.9);
            padding: 10px 12px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .retention-detail-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #94a3b8;
            letter-spacing: 0.08em;
        }

        .retention-detail-value {
            font-size: 0.95rem;
            font-weight: 600;
            color: #0f172a;
        }

        .retention-message {
            font-size: 0.9rem;
            color: #475569;
        }

        /* ============= UNIFIED CARD STYLES ============= */

        .unified-card {
            margin: 16px 30px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
            overflow: visible;
            transition: all 0.2s ease;
        }

        .unified-card.clickable {
            cursor: pointer;
        }

        .unified-card.clickable:hover {
            box-shadow: 0 16px 40px rgba(15, 23, 42, 0.12);
            transform: translateY(-1px);
        }

        .unified-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            position: relative;
            width: 100%;
        }

        /* Remove gap when no icon */
        .unified-card-header:not(:has(.card-icon)) {
            gap: 0;
        }

        .unified-card.fast .unified-card-header {
            background: linear-gradient(135deg, rgba(251, 146, 60, 0.08), rgba(236, 72, 153, 0.05));
        }

        .unified-card.body-log-container .unified-card-header {
            background: linear-gradient(135deg, rgba(56, 189, 248, 0.08), rgba(14, 165, 233, 0.05));
            cursor: pointer;
        }

        .unified-card.body-log-container .unified-card-header:hover {
            background: linear-gradient(135deg, rgba(56, 189, 248, 0.12), rgba(14, 165, 233, 0.08));
        }

        .unified-card-header-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-width: 0;
        }

        .unified-card.body-log-container .unified-card-header-content {
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
        }

        .unified-card-body {
            padding: 12px 20px 20px 20px;
        }

        .unified-card.collapsed .unified-card-body {
            display: none;
        }

        .unified-card.body-log-container .unified-card-body {
            padding-top: 0;
        }

        .card-icon {
            font-size: 1.3rem;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .card-icon.accent-orange {
            color: #fb923c;
            filter: drop-shadow(0 2px 4px rgba(251, 146, 60, 0.3));
        }

        .card-icon.accent-blue {
            color: #38bdf8;
            filter: drop-shadow(0 2px 4px rgba(56, 189, 248, 0.3));
        }

        .card-chevron {
            font-size: 0.9rem;
            color: #64748b;
            transition: transform 0.2s ease;
            flex-shrink: 0;
        }

        /* Kebab Menu Styles */
        .card-kebab {
            position: relative;
            margin-left: auto;
        }

        .card-kebab-button {
            background: none;
            border: none;
            padding: 6px 10px;
            cursor: pointer;
            color: #64748b;
            font-size: 1.2rem;
            line-height: 1;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .card-kebab-button:hover {
            background: rgba(100, 116, 139, 0.1);
            color: #475569;
        }

        .card-kebab-icon {
            display: block;
            font-weight: 700;
            letter-spacing: 2px;
        }

        .card-kebab-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.15);
            min-width: 160px;
            z-index: 1000;
            overflow: hidden;
        }

        .card-kebab.active .card-kebab-menu {
            display: block;
        }

        .card-kebab-menu-item {
            width: 100%;
            padding: 10px 16px;
            border: none;
            background: none;
            text-align: left;
            font-size: 0.9rem;
            color: #1e293b;
            cursor: pointer;
            transition: background 0.15s ease;
            border-bottom: 1px solid #f1f5f9;
        }

        .card-kebab-menu-item:last-child {
            border-bottom: none;
        }

        .card-kebab-menu-item:hover {
            background: #f8fafc;
        }

        .card-kebab-menu-item-danger {
            color: #dc2626;
        }

        .card-kebab-menu-item-danger:hover {
            background: #fef2f2;
        }

        /* Card type-specific styles */
        .card-metric {
            font-size: 1.3rem;
            font-weight: 700;
            color: #0f172a;
        }

        .card-date {
            font-size: 0.9rem;
            font-weight: 700;
            color: #1f2937;
            white-space: nowrap;
        }

        .card-summary {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: #475569;
        }

        .card-summary .summary-weight {
            font-weight: 700;
            color: #0f172a;
        }

        .card-summary .summary-bodyfat {
            color: #334155;
            font-weight: 600;
        }

        .fast-duration-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
        }

        .card-milestones {
            display: flex;
            gap: 6px;
            margin-left: auto;
        }

        /* Fast card milestone badges - make specific to override other rules */
        .unified-card.fast .milestone-badge,
        .card-milestones .milestone-badge {
            background: rgba(251, 146, 60, 0.15);
            color: #ea580c;
            padding: 3px 9px;
            border-radius: 6px;
            font-size: 0.975rem;
            font-weight: 500;
            letter-spacing: 0.01em;
            line-height: 1;
            box-shadow: none;
            text-align: center;
        }

        .card-entries {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-top: 16px;
        }

        /* Fast card specific styles */
        .unified-card.fast .fast-date-range {
            font-size: 0.9rem;
            color: #1e293b;
            font-weight: 500;
            line-height: 1.4;
        }

        .unified-card.fast .fast-status-inline {
            color: #64748b;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            font-weight: 500;
            margin-left: 4px;
        }

        .unified-card.fast .fast-notes {
            margin-top: 12px;
            font-size: 0.9rem;
            color: #475569;
            line-height: 1.5;
            padding: 10px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 3px solid #fb923c;
        }

        /* Body log entry specific styles */
        .body-log-entry {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 12px 16px;
            border-radius: 12px;
            background: #f8fafc;
            border: 1px solid rgba(226, 232, 240, 0.9);
        }

        .body-log-entry.canonical {
            border-color: rgba(59, 130, 246, 0.45);
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(14, 116, 144, 0.08));
        }

        .body-log-entry-header {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            position: relative;
        }

        .body-log-entry-header .card-kebab {
            margin-left: auto;
        }

        .body-log-canonical-badge {
            display: flex;
            align-items: center;
        }

        .body-log-canonical-pill {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            background: rgba(59, 130, 246, 0.15);
            color: #1e40af;
        }

        .body-log-canonical-pill.manual {
            background: rgba(139, 92, 246, 0.15);
            color: #6b21a8;
        }

        .body-log-meta {
            font-size: 0.8rem;
            color: #64748b;
        }

        .body-log-notes {
            margin-top: 4px;
            font-size: 0.9rem;
            color: #475569;
            line-height: 1.5;
            padding: 8px;
            background: white;
            border-radius: 6px;
            border-left: 3px solid #38bdf8;
        }

        /* Make unified card header a button for body log containers */
        .unified-card.body-log-container button.unified-card-header {
            width: 100%;
            border: none;
            text-align: left;
            font: inherit;
        }

        /* Timeline card specific styles */
        .log-timeline-item .unified-card {
            margin: 0;
            flex: 1;
        }

        .unified-card.timeline-fast .unified-card-header,
        .unified-card.timeline-body .unified-card-header {
            padding: 10px 14px;
        }

        .unified-card.timeline-fast .log-timeline-title,
        .unified-card.timeline-body .log-timeline-title {
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
        }

        .unified-card.timeline-fast .log-timeline-date,
        .unified-card.timeline-body .log-timeline-date {
            font-size: 0.8rem;
            color: #94a3b8;
            margin-left: auto;
        }

        .unified-card.timeline-fast .unified-card-header-content,
        .unified-card.timeline-body .unified-card-header-content {
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
        }

        .unified-card.timeline-fast .unified-card-body,
        .unified-card.timeline-body .unified-card-body {
            padding: 0 14px 10px 14px;
        }

        .timeline-body-metrics {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .log-timeline-metric {
            font-size: 1.2rem;
            font-weight: 700;
            color: #0f172a;
        }

        .log-timeline-submetric {
            font-size: 0.95rem;
            font-weight: 600;
            color: #1e293b;
        }

        .log-timeline-notes {
            margin-top: 8px;
            font-size: 0.85rem;
            color: #475569;
            line-height: 1.4;
        }

        .log-timeline-date-only {
            font-size: 0.9rem;
            font-weight: 600;
            color: #1e293b;
        }

        /* ============= END UNIFIED CARD STYLES ============= */

        .log-timeline {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 16px 16px 24px;
        }

        .log-timeline-item {
            display: flex;
        }

        .log-timeline-content {
            flex: 1;
            background: white;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
            padding: 16px 18px;
        }

        .log-timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 10px;
        }

        .log-timeline-title {
            font-size: 0.9rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
        }

        .log-timeline-date {
            font-size: 0.85rem;
            color: #94a3b8;
        }

        .log-timeline-body {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .log-timeline-metric {
            font-size: 1.3rem;
            font-weight: 700;
            color: #0f172a;
        }

        .log-timeline-submetric {
            font-size: 0.95rem;
            font-weight: 600;
            color: #1e293b;
        }

        .log-timeline-notes {
            flex-basis: 100%;
            font-size: 0.9rem;
            color: #475569;
        }

        .log-timeline-actions {
            display: flex;
            gap: 8px;
        }

        .log-timeline-action-btn {
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 0.8rem;
            font-weight: 600;
            color: #475569;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .log-timeline-action-btn:hover {
            border-color: #94a3b8;
            color: #1f2937;
        }

        .log-timeline-action-btn.danger {
            border-color: rgba(248, 113, 113, 0.4);
            color: #b91c1c;
        }

        .modal-checkbox-group .modal-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            cursor: pointer;
        }

        .modal-checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .modal-form-divider {
            height: 1px;
            background: #e5e7eb;
            margin: 24px 0 20px 0;
        }

        .modal-form-section-header {
            font-size: 14px;
            font-weight: 600;
            color: #6366f1;
            text-align: center;
            margin-bottom: 16px;
        }

        .modal-checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            color: #374151;
        }

        .modal-checkbox-label input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .modal-form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 15px;
            background: white;
            cursor: pointer;
            transition: border-color 0.2s ease;
        }

        .modal-form-group select:focus {
            outline: none;
            border-color: #6366f1;
        }

        /* Placeholder content for disabled tabs */
        .placeholder-content {
            padding: 60px 30px;
            text-align: center;
            color: #666;
        }
        
        .placeholder-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            opacity: 0.3;
            stroke-width: 1;
        }
        
        .placeholder-content h3 {
            font-size: 1.2rem;
            margin-bottom: 8px;
            color: #999;
        }
        
        .placeholder-content p {
            font-size: 0.9rem;
        }

        /* Benefits Tab Styles */
        .benefits-hero {
            display: flex;
            gap: 16px;
            padding: 20px 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .benefits-stat {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 12px;
            min-width: 0;
        }

        .benefits-stat-icon {
            font-size: 1.8rem;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .benefits-stat-content {
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .benefits-stat-value {
            font-size: clamp(1rem, 2vw + 0.8rem, 1.4rem);
            font-weight: 700;
            color: #1a202c;
            line-height: 1.2;
            white-space: nowrap;
            max-width: 100%;
            display: block;
        }

        .benefits-stat-label {
            font-size: 0.8rem;
            color: #64748b;
            font-weight: 500;
        }

        .timeframe-toggle {
            display: flex;
            padding: 16px 20px;
            gap: 8px;
            border-bottom: 1px solid #f0f0f0;
        }

        .timeframe-btn {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .timeframe-btn.active {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }

        .timeframe-btn:hover:not(.active) {
            background: #f8fafc;
            border-color: #cbd5e1;
        }

        .benefits-section {
            padding: 20px 20px;
            border-bottom: 1px solid #f8fafc;
        }

        .benefits-section:last-child {
            border-bottom: none;
        }

        .benefits-section-title {
            font-size: 1rem;
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .milestones-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
        }

        .milestone-badge {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            text-align: center;
            font-size: 0.8rem;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
        }

        .milestone-badge.achieved {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
        }

        .equivalences-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .equivalence-item {
            background: #f8fafc;
            padding: 12px 16px;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
            font-size: 0.9rem;
            color: #475569;
        }

        .quick-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .quick-stat {
            text-align: center;
            padding: 16px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .quick-stat-value {
            display: block;
            font-size: 1.6rem;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 4px;
        }

        .quick-stat-label {
            font-size: 0.8rem;
            color: #64748b;
            font-weight: 500;
        }

        .benefits-actions {
            padding: 20px 20px;
            text-align: center;
        }

        .benefits-settings-btn {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .benefits-settings-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
        }

        .benefits-settings-btn:active {
            transform: translateY(0);
        }

        .benefits-loading {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }

        .benefits-empty {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }

        .benefits-empty h3 {
            font-size: 1.1rem;
            margin-bottom: 8px;
            color: #475569;
        }

        .benefits-empty p {
            font-size: 0.9rem;
        }

        
        /* Loading state */
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .loading-spinner {
            width: 32px;
            height: 32px;
            margin: 0 auto 16px;
            border: 3px solid #f0f0f0;
            border-top: 3px solid #fb923c;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Page-specific styles - modal styles now handled by /css/modal.css */
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .fast-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .effectiveness-columns,
            .rolling-overview {
                flex-direction: column;
            }

        }
    </style>

</head>
<body>
    <div class="container">
        <div class="dashboard-card">
            <!-- Header -->
            <div class="header">
                <h1>Dashboard</h1>
                <p>Track your fasting journey and progress</p>
            </div>

            <!-- Active Fast Card Display (only shown during active fasts) -->
            <div class="active-fast-section hidden" id="activeFastSection">
                <div class="active-fast-header">
                    <h3>Active Fast in Progress</h3>
                    <span class="fast-duration" id="activeFastDuration">8h 24m</span>
                </div>

                <!-- Contextual Cards (Hunger Coach + Benefits) -->
                <!-- Hunger Coach Card -->
                <div class="hunger-coach-card hidden" id="dashboardHungerCard" onclick="handleDashboardHungerCardTap(event)">
                    <div class="card-content">
                        <p class="card-message" id="dashboardHungerCardMessage">
                            <span class="inline-icon" id="dashboardHungerCardIcon">🍵</span>
                            <span id="dashboardHungerCardText">Loading helpful tips...</span>
                        </p>
                        <div class="card-extended" id="dashboardHungerCardExtended" style="display: none;">
                            <p class="extended-text" id="dashboardHungerExtendedText">Additional context and tips will appear here when you tap the card.</p>
                        </div>
                        <a href="#" class="see-more-link" id="dashboardHungerSeeMoreLink" onclick="handleDashboardSeeMoreClick(event)">See More</a>
                    </div>
                </div>

                <!-- Benefits Card -->
                <div class="benefits-card hidden" id="dashboardBenefitsCard" onclick="handleDashboardBenefitsCardTap(event)">
                    <div class="card-content">
                        <p class="card-message" id="dashboardBenefitsCardMessage">
                            <span class="inline-icon" id="dashboardBenefitsCardIcon">💰</span>
                            <span id="dashboardBenefitsCardText">Loading benefits...</span>
                        </p>
                        <div class="card-extended" id="dashboardBenefitsCardExtended" style="display: none;">
                            <p class="extended-text" id="dashboardBenefitsExtendedText">Detailed benefits information will appear here when you tap the card.</p>
                        </div>
                        <a href="#" class="see-more-link" id="dashboardBenefitsSeeMoreLink" onclick="handleDashboardBenefitsSeeMoreClick(event)">View Benefits Tab</a>
                    </div>
                </div>
            </div>

            <!-- Sub Navigation -->
            <div class="sub-nav">
                <button class="sub-nav-item active" data-tab="log">Log</button>
                <button class="sub-nav-item" data-tab="benefits">Benefits</button>
                <button class="sub-nav-item" data-tab="charts">Charts</button>
                <button class="sub-nav-item disabled" data-tab="photos">Photos</button>
            </div>
            
            <!-- Content Area -->
            <div class="content">
                <!-- Charts Tab -->
                <div id="charts-tab" class="tab-content">
                    <div class="chart-card">
                        <div class="chart-card-header">
                            <div class="chart-header-top">
                                <h3>Weight Trend</h3>
                                <label class="chart-toggle">
                                    <input type="checkbox" id="toggle-post-fast" checked>
                                    <span>Post-Fast Points</span>
                                </label>
                            </div>
                            <p class="chart-subtitle" id="chart-weight-summary">Log a few weigh-ins to see your trend.</p>
                            <div class="chart-view-filters">
                                <button class="chart-view-filter active" data-view="week">Week</button>
                                <button class="chart-view-filter" data-view="month">Month</button>
                                <button class="chart-view-filter" data-view="all">All</button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <button class="chart-expand-btn" id="expand-chart-btn" title="Expand chart">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/>
                                </svg>
                            </button>
                            <svg id="weight-trend-chart" class="chart-svg" viewBox="0 0 400 360" preserveAspectRatio="none" role="img" aria-labelledby="weight-trend-title"></svg>
                            <div id="chart-tooltip" class="chart-tooltip"></div>
                        </div>
                        <div class="chart-legend">
                            <span class="legend-item"><span class="legend-dot solid"></span> Canonical</span>
                            <span class="legend-item"><span class="legend-dot hollow"></span> Post-Fast</span>
                            <span class="legend-item"><span class="legend-fast-band"></span> Fast duration</span>
                        </div>
                        <div class="chart-footnote" id="chart-footnote"></div>
                    </div>

                    <div class="chart-card" id="fast-effectiveness-card">
                        <div class="chart-card-header">
                            <div class="chart-header-top">
                                <h3>Fast Effectiveness</h3>
                                <span class="insight-info" aria-label="How fast effectiveness is calculated">
                                    i
                                    <div class="insight-tooltip">
                                        <strong>How this works:</strong><br><br>
                                        <strong>Starting weight:</strong> We look for a measurement tagged as "fast start" when you began the fast. If none exists, we automatically use the most recent body log entry from earlier that same day (before the fast started). If no measurement exists on the same day, we can't calculate effectiveness.<br><br>
                                        <strong>Post-fast weight:</strong> We use the measurement you log right after completing the fast.<br><br>
                                        <strong>Fat vs. fluid breakdown:</strong> When you log body fat %, we calculate actual fat loss vs. water weight based on body composition changes. Without body fat data, we estimate based on typical fasting patterns (roughly 25% fat, 75% fluid for most fasts).
                                    </div>
                                </span>
                            </div>
                            <p class="chart-subtitle" id="fast-effectiveness-subtitle">Log start and post-fast weights to size up your most recent fast.</p>
                        </div>
                        <div id="fast-effectiveness-content" class="effectiveness-content"></div>
                    </div>

                    <div class="chart-card" id="rolling-insights-card">
                        <div class="chart-card-header">
                            <div class="chart-header-top">
                                <h3>Rolling Protocol Insights</h3>
                                <span class="insight-info" aria-label="How rolling insights are calculated">
                                    i
                                    <div class="insight-tooltip">Compares performance across different fasting protocols you've completed in the last 90 days. Each protocol must have both start and post-fast weigh-ins. Retention is measured by finding your next morning weigh-in within 48 hours after the fast ends.</div>
                                </span>
                            </div>
                            <p class="chart-subtitle" id="rolling-insights-subtitle">Compare how each protocol performs when you log weigh-ins.</p>
                        </div>
                        <div id="rolling-insights-content" class="rolling-content"></div>
                    </div>

                    <div class="chart-card" id="weekly-composition-card">
                        <div class="chart-card-header">
                            <div>
                                <h3>Weekly Fat vs. Lean Trends</h3>
                                <p class="chart-subtitle" id="weekly-composition-summary">Log morning weigh-ins with body fat % to unlock fat/lean tracking.</p>
                            </div>
                        </div>
                        <div id="weekly-composition-list" class="weekly-list"></div>
                    </div>

                    <div class="chart-card" id="retention-card">
                        <div class="chart-card-header">
                            <div>
                                <h3>Post-Fast Retention</h3>
                                <p class="chart-subtitle" id="retention-subtitle">Complete a fast with weigh-ins to see how much stuck.</p>
                            </div>
                        </div>
                        <div id="retention-content" class="retention-content"></div>
                    </div>
                </div>

                <!-- Log Tab -->
                <div id="log-tab" class="tab-content active">
                    <div class="log-header">
                        <div class="log-controls">
                            <div class="log-filters" role="tablist">
                                <button type="button" class="log-filter-btn active" data-log-filter="fasts">Fasts</button>
                                <button type="button" class="log-filter-btn" data-log-filter="body">Body</button>
                                <button type="button" class="log-filter-btn" data-log-filter="all">All</button>
                            </div>
                        </div>
                        <div class="log-stats">
                            <!-- Fasting Stats (shown when filter is 'fasts' or 'all') -->
                            <div class="log-stat log-stat-fasting">
                                <span class="log-stat-value" id="total-fasts">-</span>
                                <span class="log-stat-label">Total Fasts</span>
                            </div>
                            <div class="log-stat log-stat-fasting">
                                <span class="log-stat-value" id="current-streak">-</span>
                                <span class="log-stat-label">Current Streak</span>
                            </div>
                            <div class="log-stat log-stat-fasting">
                                <span class="log-stat-value" id="total-hours">-</span>
                                <span class="log-stat-label">Total Hours</span>
                            </div>
                            <!-- Body Stats (shown when filter is 'body') -->
                            <div class="log-stat log-stat-body" style="display: none;">
                                <span class="log-stat-value" id="weight-delta">-</span>
                                <span class="log-stat-label">Weight Δ</span>
                            </div>
                            <div class="log-stat log-stat-body" style="display: none;">
                                <span class="log-stat-value" id="body-fat-delta">-</span>
                                <span class="log-stat-label">Body Fat Δ</span>
                            </div>
                            <div class="log-stat log-stat-body" style="display: none;">
                                <span class="log-stat-value" id="weight-percent-change">-</span>
                                <span class="log-stat-label">Weight % Δ</span>
                            </div>
                        </div>
                        <div class="log-controls">
                            <div class="log-action">
                                <button type="button" class="add-fast-btn log-action-btn" id="log-primary-action">
                                    <span class="log-action-icon" aria-hidden="true">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <line x1="5" y1="12" x2="19" y2="12"></line>
                                        </svg>
                                    </span>
                                    <span id="log-action-label">Add Fast</span>
                                    <span class="log-action-chevron hidden" id="log-action-chevron" aria-hidden="true">▾</span>
                                </button>
                                <div class="log-action-menu hidden" id="log-action-menu" role="menu">
                                    <button type="button" class="log-action-menu-item" data-action="add-fast">Add Fast</button>
                                    <button type="button" class="log-action-menu-item" data-action="add-body-entry">Add Body Entry</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="fasting-log">
                        <div id="loading-state" class="loading">
                            <div class="loading-spinner"></div>
                            <p>Loading your fasting history...</p>
                        </div>
                        
                        <div id="empty-state" class="log-empty" style="display: none;">
                            <svg class="log-empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14,2 14,8 20,8"/>
                                <line x1="16" y1="13" x2="8" y2="13"/>
                                <line x1="16" y1="17" x2="8" y2="17"/>
                                <polyline points="10,9 9,9 8,9"/>
                            </svg>
                            <h3 id="log-empty-title">No fasts recorded yet</h3>
                            <p id="log-empty-description">Start your first fast or add a previous fast manually to begin tracking your journey.</p>
                        </div>

                        <div id="log-list">
                            <!-- Log entries will be populated here by JavaScript -->
                        </div>
                    </div>
                </div>
                
                <!-- Benefits Tab -->
                <div id="benefits-tab" class="tab-content">
                    <!-- Hero Stats -->
                    <div class="benefits-hero">
                        <div class="benefits-stat">
                            <div class="benefits-stat-icon">💰</div>
                            <div class="benefits-stat-content">
                                <span class="benefits-stat-value" id="total-money-saved">$0.00</span>
                                <span class="benefits-stat-label">Money Saved</span>
                            </div>
                        </div>
                        <div class="benefits-stat">
                            <div class="benefits-stat-icon">⏰</div>
                            <div class="benefits-stat-content">
                                <span class="benefits-stat-value" id="total-time-reclaimed">0h</span>
                                <span class="benefits-stat-label">Time Reclaimed</span>
                            </div>
                        </div>
                    </div>

                    <!-- Timeframe Toggle -->
                    <div class="timeframe-toggle">
                        <button class="timeframe-btn" data-timeframe="week">Week</button>
                        <button class="timeframe-btn" data-timeframe="month">Month</button>
                        <button class="timeframe-btn active" data-timeframe="all">All Time</button>
                    </div>

                    <!-- Milestones Section -->
                    <div class="benefits-section">
                        <h3 class="benefits-section-title">🎯 Milestones</h3>
                        <div class="milestones-grid" id="milestones-grid">
                            <!-- Milestones will be populated here -->
                        </div>
                    </div>

                    <!-- Equivalences Section -->
                    <div class="benefits-section">
                        <h3 class="benefits-section-title">💡 What You've Earned</h3>
                        <div class="equivalences-list" id="equivalences-list">
                            <!-- Equivalences will be populated here -->
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="benefits-section">
                        <h3 class="benefits-section-title">📊 Quick Stats</h3>
                        <div class="quick-stats">
                            <div class="quick-stat">
                                <span class="quick-stat-value" id="meals-skipped">0</span>
                                <span class="quick-stat-label">Meals Skipped</span>
                            </div>
                            <div class="quick-stat">
                                <span class="quick-stat-value" id="avg-savings-per-fast">$0</span>
                                <span class="quick-stat-label">Avg per Fast</span>
                            </div>
                        </div>
                    </div>

                    <!-- Settings Button -->
                    <div class="benefits-actions">
                        <button class="benefits-settings-btn" id="benefits-settings-btn">
                            ⚙️ Adjust Preferences
                        </button>
                    </div>
                </div>
                
                <!-- Photos Tab -->
                <div id="photos-tab" class="tab-content">
                    <div class="placeholder-content">
                        <svg class="placeholder-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <circle cx="8.5" cy="8.5" r="1.5"/>
                            <polyline points="21,15 16,10 5,21"/>
                        </svg>
                        <h3>Photos Coming Soon</h3>
                        <p>Document your transformation with progress photos.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Navigation Placeholder -->
    <div id="navigation-placeholder"></div>

    <!-- Navigation Utility -->
    <script src="/js/utils/navigation.js"></script>

    <!-- Add Fast Modal -->
    <div id="add-fast-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Fast</h2>
                <button type="button" class="modal-close" onclick="hideAddFastModal()">×</button>
            </div>
            <div class="modal-body">
                <form id="add-fast-form" class="modal-form" onsubmit="submitAddFast(event)">
                    <div class="modal-form-group">
                        <label for="start-date">Fast Start</label>
                        <div class="modal-form-row">
                            <div class="modal-form-group">
                                <input type="date" id="start-date" name="start-date" required>
                            </div>
                            <div class="modal-form-group">
                                <input type="time" id="start-time" name="start-time" required>
                            </div>
                        </div>
                    </div>

                    <div class="modal-form-group">
                        <label for="end-date">Fast End (Optional)</label>
                        <div class="modal-form-row">
                            <div class="modal-form-group">
                                <input type="date" id="end-date" name="end-date">
                            </div>
                            <div class="modal-form-group">
                                <input type="time" id="end-time" name="end-time">
                            </div>
                        </div>
                        <div class="modal-form-hint">Leave empty if fast is ongoing</div>
                    </div>

                    <div class="modal-form-group">
                        <label for="start-weight">Starting Weight (Optional)</label>
                        <input type="number" id="start-weight" name="start-weight" step="0.1" placeholder="Enter starting weight">
                    </div>

                    <div class="modal-form-group">
                        <label for="start-body-fat">Starting Body Fat % (Optional)</label>
                        <input type="number" id="start-body-fat" name="start-body-fat" step="0.1" min="0" max="100" placeholder="Enter starting body fat %">
                    </div>

                    <div class="modal-form-group">
                        <label for="end-weight">End Weight (Optional)</label>
                        <input type="number" id="end-weight" name="end-weight" step="0.1" placeholder="Enter end weight">
                        <div class="modal-form-hint">Only if fast is complete</div>
                    </div>

                    <div class="modal-form-group">
                        <label for="end-body-fat">End Body Fat % (Optional)</label>
                        <input type="number" id="end-body-fat" name="end-body-fat" step="0.1" min="0" max="100" placeholder="Enter end body fat %">
                        <div class="modal-form-hint">Only if fast is complete</div>
                    </div>

                    <div class="modal-form-group">
                        <label for="notes">Notes (Optional)</label>
                        <textarea id="notes" name="notes" placeholder="Add any notes about this fast..."></textarea>
                    </div>

                    <div class="modal-form-divider"></div>
                    <div class="modal-form-section-header">Optional Context (improves breakdown accuracy)</div>

                    <div class="modal-form-group">
                        <label class="modal-checkbox-label">
                            <input type="checkbox" id="add-start-in-ketosis" name="start-in-ketosis">
                            <span>Already in ketosis?</span>
                        </label>
                        <div class="modal-form-hint">Check if you were already fat-adapted before starting</div>
                    </div>

                    <div class="modal-form-group">
                        <label for="add-pre-fast-protein">Pre-fast protein (grams)</label>
                        <input type="number" id="add-pre-fast-protein" name="pre-fast-protein" min="0" max="200" placeholder="Optional">
                        <div class="modal-form-hint">Protein in your last meal (helps preserve muscle)</div>
                    </div>

                    <div class="modal-form-group">
                        <label for="add-carb-status">Pre-fast carb intake</label>
                        <select id="add-carb-status" name="carb-status">
                            <option value="normal">Normal</option>
                            <option value="low">Low (keto/low-carb)</option>
                            <option value="high">High (carb-heavy meal)</option>
                        </select>
                        <div class="modal-form-hint">Affects glycogen and water loss</div>
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="modal-btn modal-btn-secondary" onclick="hideAddFastModal()">Cancel</button>
                        <button type="submit" class="modal-btn modal-btn-primary">Add Fast</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Fast Modal -->
    <div id="edit-fast-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Fast</h2>
                <button type="button" class="modal-close" onclick="hideEditFastModal()">×</button>
            </div>
            <div class="modal-body">
                <form id="edit-fast-form" class="modal-form" onsubmit="submitEditFast(event)">
                    <div class="modal-form-group">
                        <label for="edit-start-date">Fast Start</label>
                        <div class="modal-form-row">
                            <div class="modal-form-group">
                                <input type="date" id="edit-start-date" name="start-date" required>
                            </div>
                            <div class="modal-form-group">
                                <input type="time" id="edit-start-time" name="start-time" required>
                            </div>
                        </div>
                    </div>

                    <div class="modal-form-group">
                        <label for="edit-end-date">Fast End (Optional)</label>
                        <div class="modal-form-row">
                            <div class="modal-form-group">
                                <input type="date" id="edit-end-date" name="end-date">
                            </div>
                            <div class="modal-form-group">
                                <input type="time" id="edit-end-time" name="end-time">
                            </div>
                        </div>
                        <div class="modal-form-hint">Leave empty if fast is ongoing</div>
                    </div>

                    <div class="modal-form-group">
                        <label for="edit-start-weight">Starting Weight (Optional)</label>
                        <input type="number" id="edit-start-weight" name="start-weight" step="0.1" placeholder="Enter starting weight">
                    </div>

                    <div class="modal-form-group">
                        <label for="edit-start-body-fat">Starting Body Fat % (Optional)</label>
                        <input type="number" id="edit-start-body-fat" name="start-body-fat" step="0.1" min="0" max="100" placeholder="Enter starting body fat %">
                    </div>

                    <div class="modal-form-group">
                        <label for="edit-end-weight">End Weight (Optional)</label>
                        <input type="number" id="edit-end-weight" name="end-weight" step="0.1" placeholder="Enter end weight">
                        <div class="modal-form-hint">Only if fast is complete</div>
                    </div>

                    <div class="modal-form-group">
                        <label for="edit-end-body-fat">End Body Fat % (Optional)</label>
                        <input type="number" id="edit-end-body-fat" name="end-body-fat" step="0.1" min="0" max="100" placeholder="Enter end body fat %">
                        <div class="modal-form-hint">Only if fast is complete</div>
                    </div>

                    <div class="modal-form-group">
                        <label for="edit-notes">Notes (Optional)</label>
                        <textarea id="edit-notes" name="notes" placeholder="Add any notes about this fast..."></textarea>
                    </div>

                    <div class="modal-form-divider"></div>
                    <div class="modal-form-section-header">Optional Context (improves breakdown accuracy)</div>

                    <div class="modal-form-group">
                        <label class="modal-checkbox-label">
                            <input type="checkbox" id="edit-start-in-ketosis" name="start-in-ketosis">
                            <span>Already in ketosis?</span>
                        </label>
                        <div class="modal-form-hint">Check if you were already fat-adapted before starting</div>
                    </div>

                    <div class="modal-form-group">
                        <label for="edit-pre-fast-protein">Pre-fast protein (grams)</label>
                        <input type="number" id="edit-pre-fast-protein" name="pre-fast-protein" min="0" max="200" placeholder="Optional">
                        <div class="modal-form-hint">Protein in your last meal (helps preserve muscle)</div>
                    </div>

                    <div class="modal-form-group">
                        <label for="edit-carb-status">Pre-fast carb intake</label>
                        <select id="edit-carb-status" name="carb-status">
                            <option value="normal">Normal</option>
                            <option value="low">Low (keto/low-carb)</option>
                            <option value="high">High (carb-heavy meal)</option>
                        </select>
                        <div class="modal-form-hint">Affects glycogen and water loss</div>
                    </div>

                    <div class="modal-actions-special">
                        <button type="button" class="modal-btn modal-btn-danger" onclick="deleteFast(editingFastId)">Delete</button>
                        <div class="modal-actions-spacer"></div>
                        <button type="button" class="modal-btn modal-btn-secondary" onclick="hideEditFastModal()">Cancel</button>
                        <button type="submit" class="modal-btn modal-btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Body Entry Modal -->
    <div id="body-entry-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="body-entry-modal-title">Add Body Entry</h2>
                <button type="button" class="modal-close" onclick="hideBodyEntryModal()">×</button>
            </div>
            <div class="modal-body">
                <form id="body-entry-form" class="modal-form" onsubmit="submitBodyEntry(event)">
                    <input type="hidden" id="body-entry-id" name="entry-id">
                    <input type="hidden" id="body-entry-fast-id" name="fast-id">

                    <div class="modal-form-group">
                        <label for="body-entry-date">Entry Date</label>
                        <div class="modal-form-row">
                            <div class="modal-form-group">
                                <input type="date" id="body-entry-date" name="entry-date" required>
                            </div>
                            <div class="modal-form-group">
                                <input type="time" id="body-entry-time" name="entry-time" required>
                            </div>
                        </div>
                        <div class="modal-form-hint">Morning fasted readings (4am–11:59am) are preferred.</div>
                    </div>

                    <div class="modal-form-group">
                        <label for="body-entry-weight">Weight</label>
                        <input type="number" id="body-entry-weight" name="weight" step="0.1" min="0" required placeholder="Enter weight">
                    </div>

                    <div class="modal-form-group">
                        <label for="body-entry-bodyfat">Body Fat % (Optional)</label>
                        <input type="number" id="body-entry-bodyfat" name="body-fat" step="0.1" min="0" max="100" placeholder="Enter body fat %">
                    </div>

                    <div class="modal-form-group">
                        <label for="body-entry-notes">Notes (Optional)</label>
                        <textarea id="body-entry-notes" name="notes" placeholder="Add context like scale type or measurement conditions..."></textarea>
                    </div>

                    <div class="modal-form-group modal-checkbox-group">
                        <label class="modal-checkbox">
                            <input type="checkbox" id="body-entry-make-canonical" name="make-canonical">
                            <span>Mark as canonical for this day</span>
                        </label>
                        <div class="modal-form-hint">Use this to override the automatic selection for trend calculations.</div>
                    </div>

                    <div class="modal-actions-special" id="body-entry-modal-actions">
                        <button type="button" class="modal-btn modal-btn-danger" id="body-entry-delete-btn" onclick="deleteBodyEntryFromModal()">Delete</button>
                        <div class="modal-actions-spacer"></div>
                        <button type="button" class="modal-btn modal-btn-secondary" onclick="hideBodyEntryModal()">Cancel</button>
                        <button type="submit" class="modal-btn modal-btn-primary" id="body-entry-submit-btn">Save Entry</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Benefits Onboarding Modal -->
    <div id="benefits-onboarding-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Welcome to Benefits Tracking! 🎉</h2>
                <button type="button" class="modal-close" onclick="dismissBenefitsOnboarding()">×</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 3rem; margin-bottom: 10px;">💰⏰🎯</div>
                    <p style="font-size: 1.1rem; color: #555; margin-bottom: 20px;">
                        Track the money you save and time you reclaim from fasting, plus see your progress with achievement milestones!
                    </p>
                </div>

                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin-top: 0; color: #333;">What you'll see:</h3>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li><strong>Money Saved:</strong> Track dollars saved by skipping meals</li>
                        <li><strong>Time Reclaimed:</strong> See hours gained from not meal prepping</li>
                        <li><strong>Achievement Badges:</strong> Unlock milestones as you progress</li>
                        <li><strong>Smart Equivalences:</strong> "Enough saved for running shoes!"</li>
                    </ul>
                </div>

                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="margin: 0; color: #1976d2; font-weight: 500;">
                        💡 <strong>Pro tip:</strong> Customize your average meal cost and prep time in Settings to get personalized calculations!
                    </p>
                </div>

                <div class="modal-actions">
                    <button type="button" class="modal-btn modal-btn-secondary" onclick="goToBenefitsSettings()">
                        Customize Settings
                    </button>
                    <button type="button" class="modal-btn modal-btn-primary" onclick="completeBenefitsOnboarding()">
                        Get Started
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart Expand Modal -->
    <div id="chart-modal" class="chart-modal">
        <div class="chart-modal-content">
            <div class="chart-modal-header">
                <h2 style="margin: 0; font-size: 1.5rem; color: #0f172a;">Weight Trend</h2>
                <button class="chart-modal-close" id="close-chart-modal">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div id="chart-modal-body">
                <!-- Chart will be cloned here -->
            </div>
        </div>
    </div>

    <!-- Global Notification Manager -->
    <script src="/js/modules/hunger-coach.js"></script>
    <script src="/js/modules/global-notification-manager.js"></script>

    <!-- Benefits Tracking -->
    <script src="/js/services/BenefitsCalculator.js"></script>
    <script src="/js/services/BenefitsDataService.js"></script>
    <script src="/js/services/BodyLogApi.js"></script>

    <!-- Card System Components -->
    <script src="/js/components/ContextualCard.js"></script>
    <script src="/js/components/HungerCoachCard.js"></script>
    <script src="/js/components/BenefitsCard.js"></script>
    <script src="/js/services/MealTimeDetector.js"></script>
    <script src="/js/managers/CardRotationManager.js"></script>

    <script>
        let fasts = [];
        let bodyLogEntries = [];
        const bodyLogApi = new BodyLogApi();
        let currentLogFilter = 'fasts';
        let fastsLoaded = false;
        let bodyEntriesLoaded = false;
        const expandedBodyDates = new Set();
        let bodyEntryModalMode = 'create';
        let bodyEntryEditingId = null;
        let pendingScrollTarget = null;
        let logControlsInitialized = false;
        let logListInteractionInitialized = false;
        let logActionMenuOpen = false;
        let chartControlsInitialized = false;
        let bodyAnalytics = null;
        let chartsLoading = false;
        let chartsError = null;
        let showPostFastPoints = true;
        let chartViewFilter = 'week'; // 'week', 'month', or 'all'
        
        // Initialize dashboard page function that waits for session
        async function initializeDashboardPage() {
            console.log('Initializing dashboard page with session ready');

            // Set up tab switching functionality
            const subNavItems = document.querySelectorAll('.sub-nav-item');
            const tabContents = document.querySelectorAll('.tab-content');

            subNavItems.forEach(item => {
                item.addEventListener('click', function() {
                    if (this.classList.contains('disabled')) return;

                    // Remove active class from all items and contents
                    subNavItems.forEach(navItem => navItem.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));

                    // Add active class to clicked item
                    this.classList.add('active');

                    // Show corresponding tab content
                    const tabId = this.getAttribute('data-tab') + '-tab';
                    document.getElementById(tabId).classList.add('active');
                });
            });

            setupLogControls();
            setupLogListInteractions();
            setupChartInteractions();
            renderLogEntries();
            renderCharts();

            // Load fasting and body log data
            await loadFasts();
            await loadBodyLogEntries();
            await loadBodyAnalytics();

            // Initialize Benefits tab functionality
            await initializeBenefitsTab();

            // Initialize dashboard active fast display
            await initializeDashboardActiveFast();

            // Update navigation
            updateActiveNavItem();
        }

        // DOM Content Loaded - only set up non-session dependent functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Set default start date/time to now
            const now = new Date();
            const localISOTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString();
            const [date, time] = localISOTime.split('T');
            const startDateInput = document.getElementById('start-date');
            const startTimeInput = document.getElementById('start-time');
            if (startDateInput) startDateInput.value = date;
            if (startTimeInput) startTimeInput.value = time.slice(0, 5); // Remove seconds

            // Close modal handlers
            document.getElementById('add-fast-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideAddFastModal();
                }
            });

            document.getElementById('edit-fast-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideEditFastModal();
                }
            });

            document.getElementById('benefits-onboarding-modal').addEventListener('click', async function(e) {
                if (e.target === this) {
                    await dismissBenefitsOnboarding();
                }
            });

            // Add click handlers for navigation items
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    const href = item.getAttribute('href');

                    // For now, prevent default navigation for pages that don't exist
                    if (href !== '/dashboard' && href !== '/timer' && href !== '/schedule' && href !== '/settings') {
                        e.preventDefault();

                        const pageName = item.querySelector('.nav-label').textContent;
                        alert(`${pageName} page coming soon!`);
                    }
                });
            });

            // Mobile-friendly tooltip handlers
            document.querySelectorAll('.insight-info').forEach(infoIcon => {
                infoIcon.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const tooltip = infoIcon.querySelector('.insight-tooltip');
                    if (tooltip) {
                        tooltip.classList.toggle('visible');

                        // Close other open tooltips
                        document.querySelectorAll('.insight-tooltip.visible').forEach(other => {
                            if (other !== tooltip) {
                                other.classList.remove('visible');
                            }
                        });
                    }
                });
            });

            // Close tooltips when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.insight-info')) {
                    document.querySelectorAll('.insight-tooltip.visible').forEach(tooltip => {
                        tooltip.classList.remove('visible');
                    });
                }
            });

            window.addEventListener('resize', () => {
                clearTimeout(benefitsResizeTimeout);
                benefitsResizeTimeout = setTimeout(fitBenefitsHeroText, 150);
            });
        });

        // Benefits Tab Functionality
        let benefitsDataService = null;
        let currentTimeframe = 'all';
        const BENEFITS_ONBOARDING_KEY = 'fastingForecast_benefitsOnboardingAcknowledged';
        const fullCurrencyFormatter = new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
        const compactCurrencyFormatter = new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            notation: 'compact',
            compactDisplay: 'short',
            maximumFractionDigits: 1,
            minimumFractionDigits: 0
        });
        const BENEFITS_HERO_FONT_MAX_REM = 1.4;
        const BENEFITS_HERO_FONT_MIN_REM = 0.85;
        const BENEFITS_HERO_FONT_STEP_REM = 0.05;
        let benefitsResizeTimeout = null;

        function formatCurrency(value) {
            const numericValue = Number(value) || 0;

            if (Math.abs(numericValue) >= 1000) {
                return compactCurrencyFormatter.format(numericValue);
            }

            return fullCurrencyFormatter.format(numericValue);
        }

        function adjustHeroStatValue(element) {
            if (!element) {
                return;
            }

            element.style.removeProperty('font-size');

            const computedFontPx = parseFloat(window.getComputedStyle(element).fontSize) || (BENEFITS_HERO_FONT_MAX_REM * 16);
            let currentFontRem = Math.min(computedFontPx / 16, BENEFITS_HERO_FONT_MAX_REM);
            element.style.fontSize = `${currentFontRem}rem`;

            const availableWidth = element.clientWidth || element.parentElement?.clientWidth || 0;
            if (!availableWidth) {
                return;
            }

            let iterations = 0;
            while (element.scrollWidth > availableWidth && currentFontRem > BENEFITS_HERO_FONT_MIN_REM && iterations < 20) {
                currentFontRem = Math.max(currentFontRem - BENEFITS_HERO_FONT_STEP_REM, BENEFITS_HERO_FONT_MIN_REM);
                element.style.fontSize = `${currentFontRem}rem`;
                iterations++;
            }
        }

        function fitBenefitsHeroText() {
            window.requestAnimationFrame(() => {
                document.querySelectorAll('.benefits-stat-value').forEach(adjustHeroStatValue);
            });
        }

        function hasAcknowledgedBenefitsOnboarding() {
            try {
                return localStorage.getItem(BENEFITS_ONBOARDING_KEY) === 'true';
            } catch (error) {
                console.warn('Unable to read benefits onboarding state:', error);
                return false;
            }
        }

        function setBenefitsOnboardingAcknowledgedLocally() {
            try {
                localStorage.setItem(BENEFITS_ONBOARDING_KEY, 'true');
            } catch (error) {
                console.warn('Unable to persist benefits onboarding locally:', error);
            }
        }

        // Meal times functionality for card rotation
        let userMealtimes = null;
        let mealtimesLoaded = false;

        async function getUserMealtimes() {
            // Return cached mealtimes if already loaded
            if (mealtimesLoaded && userMealtimes) {
                return userMealtimes;
            }

            const sessionId = window.getSessionId();
            if (!sessionId) {
                // Return defaults if no session
                const defaults = {
                    breakfast: '08:00',
                    lunch: '12:00',
                    dinner: '18:00'
                };
                userMealtimes = defaults;
                mealtimesLoaded = true;
                return defaults;
            }

            try {
                const response = await fetch(`/api/user/${sessionId}/hunger-settings`);
                if (response.ok) {
                    const settings = await response.json();

                    // Convert custom_mealtimes array to object format expected by CardRotationManager
                    const mealtimes = {};
                    if (settings.custom_mealtimes && Array.isArray(settings.custom_mealtimes)) {
                        settings.custom_mealtimes.forEach(meal => {
                            // Use meal name as key, but convert to lowercase for consistency
                            const key = meal.name.toLowerCase().replace(/\s+/g, '_');
                            mealtimes[key] = meal.time;
                        });
                    }

                    // Fallback to defaults if no custom mealtimes
                    if (Object.keys(mealtimes).length === 0) {
                        userMealtimes = {
                            breakfast: '08:00',
                            lunch: '12:00',
                            dinner: '18:00'
                        };
                    } else {
                        userMealtimes = mealtimes;
                    }

                    mealtimesLoaded = true;
                    return userMealtimes;
                } else {
                    console.error('Failed to load user mealtimes:', response.status);
                    // Return defaults on failure
                    const defaults = {
                        breakfast: '08:00',
                        lunch: '12:00',
                        dinner: '18:00'
                    };
                    userMealtimes = defaults;
                    mealtimesLoaded = true;
                    return defaults;
                }
            } catch (error) {
                console.error('Error loading user mealtimes:', error);
                // Return defaults on error
                const defaults = {
                    breakfast: '08:00',
                    lunch: '12:00',
                    dinner: '18:00'
                };
                userMealtimes = defaults;
                mealtimesLoaded = true;
                return defaults;
            }
        }

        async function initializeBenefitsTab() {
            try {
                // Initialize benefits data service
                benefitsDataService = new BenefitsDataService();
                await benefitsDataService.init();

                // Set up event listeners
                setupBenefitsEventListeners();

                // Load initial benefits data
                await loadBenefitsData();

                console.log('Benefits tab initialized successfully');
            } catch (error) {
                console.error('Failed to initialize benefits tab:', error);
                showBenefitsError('Failed to load benefits data');
            }
        }

        function setupBenefitsEventListeners() {
            // Timeframe toggle buttons
            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    // Update active state
                    document.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    // Update timeframe and reload data
                    currentTimeframe = this.getAttribute('data-timeframe');
                    await loadBenefitsData();
                });
            });

            // Settings button
            const settingsBtn = document.getElementById('benefits-settings-btn');
            if (settingsBtn) {
                settingsBtn.addEventListener('click', function() {
                    showBenefitsSettingsModal();
                });
            }

            // Listen for tab switches to Benefits
            document.querySelector('[data-tab="benefits"]').addEventListener('click', async function() {
                if (!this.classList.contains('disabled')) {
                    // Check if user needs onboarding first
                    const isOnboarded = await checkBenefitsOnboarding();

                    if (!isOnboarded) {
                        showBenefitsOnboardingModal();
                    } else {
                        loadBenefitsData();
                    }
                }
            });
        }

        async function loadBenefitsData() {
            try {
                showBenefitsLoading();

                if (!benefitsDataService) {
                    throw new Error('Benefits service not initialized');
                }

                // Get cumulative benefits for selected timeframe
                const benefits = await benefitsDataService.getCumulativeBenefits(currentTimeframe);

                if (benefits) {
                    displayBenefitsData(benefits);
                } else {
                    showBenefitsEmpty();
                }

            } catch (error) {
                console.error('Error loading benefits data:', error);
                showBenefitsError('Failed to load benefits data');
            }
        }

        function displayBenefitsData(benefits) {
            // Update hero stats
            document.getElementById('total-money-saved').textContent = formatCurrency(benefits.totalMoneySaved);
            document.getElementById('total-time-reclaimed').textContent = benefits.totalTimeReclaimedFormatted || '0h';

            // Update quick stats
            document.getElementById('meals-skipped').textContent = benefits.totalMealsSkipped || 0;
            const avgSavings = benefits.totalFasts > 0 ?
                (benefits.totalMoneySaved / benefits.totalFasts) : 0;
            document.getElementById('avg-savings-per-fast').textContent = formatCurrency(avgSavings);

            // Update milestones
            displayMilestones(benefits);

            // Update equivalences
            displayEquivalences(benefits.equivalences || []);

            // Remove loading state
            hideBenefitsLoading();

            fitBenefitsHeroText();
        }

        function displayMilestones(benefits) {
            const milestonesGrid = document.getElementById('milestones-grid');

            // Generate milestone badges
            const milestones = [];

            // Money milestones
            const moneyThresholds = [25, 50, 100, 200, 500];
            moneyThresholds.forEach(threshold => {
                const achieved = benefits.totalMoneySaved >= threshold;
                milestones.push({
                    text: `$${threshold}`,
                    achieved,
                    type: 'money'
                });
            });

            // Time milestones (in hours)
            const timeThresholds = [2, 6, 12, 24, 48];
            timeThresholds.forEach(threshold => {
                const totalHours = Math.floor(benefits.totalTimeReclaimed / 60);
                const achieved = totalHours >= threshold;
                milestones.push({
                    text: `${threshold}h`,
                    achieved,
                    type: 'time'
                });
            });

            // Render milestones
            milestonesGrid.innerHTML = milestones.map(milestone => `
                <div class="milestone-badge ${milestone.achieved ? 'achieved' : ''}">
                    ${milestone.text}
                </div>
            `).join('');
        }

        function displayEquivalences(equivalences) {
            const equivalencesList = document.getElementById('equivalences-list');

            if (equivalences.length === 0) {
                equivalencesList.innerHTML = `
                    <div class="equivalence-item">
                        Keep fasting to see what your savings can buy! 🎯
                    </div>
                `;
                return;
            }

            equivalencesList.innerHTML = equivalences.map(equiv => `
                <div class="equivalence-item">
                    ${equiv}
                </div>
            `).join('');
        }

        function showBenefitsLoading() {
            const benefitsTab = document.getElementById('benefits-tab');
            const existingLoading = benefitsTab.querySelector('.benefits-loading');

            if (!existingLoading) {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'benefits-loading';
                loadingDiv.innerHTML = '⏳ Loading benefits data...';
                benefitsTab.appendChild(loadingDiv);
            }
        }

        function hideBenefitsLoading() {
            const loadingDiv = document.querySelector('.benefits-loading');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        function showBenefitsEmpty() {
            hideBenefitsLoading();
            const benefitsTab = document.getElementById('benefits-tab');

            // Add empty state to hero section
            document.getElementById('total-money-saved').textContent = formatCurrency(0);
            document.getElementById('total-time-reclaimed').textContent = '0h';
            document.getElementById('meals-skipped').textContent = '0';
            document.getElementById('avg-savings-per-fast').textContent = formatCurrency(0);

            // Show empty state message in milestones
            const milestonesGrid = document.getElementById('milestones-grid');
            milestonesGrid.innerHTML = `
                <div class="benefits-empty" style="grid-column: 1 / -1;">
                    <h3>Start your first fast!</h3>
                    <p>Your benefits will appear here as you complete fasts.</p>
                </div>
            `;

            // Clear equivalences
            displayEquivalences([]);

            fitBenefitsHeroText();
        }

        function showBenefitsError(message) {
            hideBenefitsLoading();
            const milestonesGrid = document.getElementById('milestones-grid');
            milestonesGrid.innerHTML = `
                <div class="benefits-empty" style="grid-column: 1 / -1; color: #ef4444;">
                    <h3>Unable to load benefits</h3>
                    <p>${message}</p>
                </div>
            `;
        }

        function showBenefitsSettingsModal() {
            // For now, redirect to settings page
            // Later we can implement a modal here
            window.location.href = '/settings#benefits';
        }

        // Benefits Onboarding Functions
        function showBenefitsOnboardingModal() {
            document.getElementById('benefits-onboarding-modal').classList.add('active');
        }

        function hideBenefitsOnboardingModal() {
            document.getElementById('benefits-onboarding-modal').classList.remove('active');
        }

        async function acknowledgeBenefitsOnboarding({ persist = true } = {}) {
            const alreadyAcknowledged = hasAcknowledgedBenefitsOnboarding();
            setBenefitsOnboardingAcknowledgedLocally();

            if (!persist || alreadyAcknowledged) {
                return;
            }

            try {
                if (benefitsDataService && typeof benefitsDataService.markBenefitsOnboarded === 'function') {
                    await benefitsDataService.markBenefitsOnboarded();
                } else {
                    const sessionId = window.getSessionId();
                    if (!sessionId) {
                        return;
                    }

                    await fetch('/api/benefits/onboarding-complete', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ sessionId })
                    });
                }
            } catch (error) {
                console.error('Error marking benefits onboarding complete:', error);
            }
        }

        async function dismissBenefitsOnboarding({ persist = true } = {}) {
            hideBenefitsOnboardingModal();
            await acknowledgeBenefitsOnboarding({ persist });
        }

        async function goToBenefitsSettings() {
            await dismissBenefitsOnboarding();
            window.location.href = '/settings#benefits';
        }

        async function completeBenefitsOnboarding() {
            try {
                await dismissBenefitsOnboarding();
                await loadBenefitsData();

                console.log('Benefits onboarding completed successfully');
            } catch (error) {
                console.error('Error completing benefits onboarding:', error);
                // Still proceed to load benefits data even if marking onboarding fails
                await loadBenefitsData();
            }
        }

        async function checkBenefitsOnboarding() {
            try {
                if (!benefitsDataService) {
                    return false;
                }

                if (hasAcknowledgedBenefitsOnboarding()) {
                    return true;
                }

                const preferences = await benefitsDataService.getUserPreferences();
                const onboardingFlag = preferences ?
                    (preferences.benefitsOnboarded ?? preferences.benefits_onboarded) : false;

                if (onboardingFlag === true) {
                    setBenefitsOnboardingAcknowledgedLocally();
                    return true;
                }

                return false;
            } catch (error) {
                console.error('Error checking benefits onboarding status:', error);
                return hasAcknowledgedBenefitsOnboarding();
            }
        }

        // Dashboard Active Fast Management
        let dashboardCardRotationManager = null;
        let activeFastUpdateInterval = null;

        async function initializeDashboardActiveFast() {
            try {
                // Check if there's an active fast
                const activeFast = await getActiveFast();

                if (activeFast) {
                    await showActiveFastSection(activeFast);
                } else {
                    hideActiveFastSection();
                }

            } catch (error) {
                console.error('Error initializing dashboard active fast:', error);
                hideActiveFastSection();
            }
        }

        async function showActiveFastSection(activeFast) {
            const activeFastSection = document.getElementById('activeFastSection');
            const fastDuration = document.getElementById('activeFastDuration');

            if (!activeFastSection) return;

            try {
                // Calculate duration
                const startTime = new Date(activeFast.start_time);
                const now = new Date();
                const elapsedMs = now - startTime;
                const duration = formatDuration(elapsedMs);

                // Update UI
                fastDuration.textContent = duration;
                activeFastSection.classList.remove('hidden');

                // Initialize card rotation manager if not already done
                if (!dashboardCardRotationManager && window.CardRotationManager) {
                    dashboardCardRotationManager = new CardRotationManager({
                        rotationInterval: 15000, // 15 seconds on dashboard
                        mealTimeToleranceMinutes: 30,
                        enableRotation: true
                    });

                    // Override the card initialization to use dashboard-specific IDs
                    dashboardCardRotationManager.initializeCards = async function() {
                        try {
                            // Initialize Hunger Coach Card with dashboard ID
                            if (window.HungerCoachCard) {
                                this.hungerCoachCard = new HungerCoachCard('dashboardHungerCard');
                                await this.hungerCoachCard.init();
                            } else {
                                console.warn('HungerCoachCard class not available');
                            }

                            // Initialize Benefits Card with dashboard ID
                            if (window.BenefitsCard) {
                                this.benefitsCard = new BenefitsCard('dashboardBenefitsCard');
                                await this.benefitsCard.init();
                            } else {
                                console.warn('BenefitsCard class not available');
                            }

                            // Ensure we have at least one card
                            if (!this.hungerCoachCard && !this.benefitsCard) {
                                throw new Error('No cards available for rotation');
                            }

                        } catch (error) {
                            console.error('Error initializing dashboard cards:', error);
                            throw error;
                        }
                    }.bind(dashboardCardRotationManager);

                    await dashboardCardRotationManager.init();
                }

                // Update fast state
                if (dashboardCardRotationManager) {
                    const mealtimes = await getUserMealtimes();
                    dashboardCardRotationManager.updateFastState(true, activeFast.start_time, mealtimes);
                }

                // Start updating duration
                startActiveFastUpdates();


            } catch (error) {
                console.error('Error showing active fast section:', error);
            }
        }

        function hideActiveFastSection() {
            const activeFastSection = document.getElementById('activeFastSection');
            if (activeFastSection) {
                activeFastSection.classList.add('hidden');
            }

            // Stop card rotation
            if (dashboardCardRotationManager) {
                dashboardCardRotationManager.updateFastState(false, null, null);
            }

            // Stop duration updates
            stopActiveFastUpdates();

        }

        function startActiveFastUpdates() {
            stopActiveFastUpdates(); // Clear any existing interval

            activeFastUpdateInterval = setInterval(async () => {
                try {
                    const activeFast = await getActiveFast();
                    if (activeFast) {
                        const fastDuration = document.getElementById('activeFastDuration');
                        if (fastDuration) {
                            const startTime = new Date(activeFast.start_time);
                            const now = new Date();
                            const elapsedMs = now - startTime;
                            const duration = formatDuration(elapsedMs);
                            fastDuration.textContent = duration;
                        }
                    } else {
                        // Fast ended, hide section
                        hideActiveFastSection();
                    }
                } catch (error) {
                    console.error('Error updating active fast:', error);
                }
            }, 60000); // Update every minute
        }

        function stopActiveFastUpdates() {
            if (activeFastUpdateInterval) {
                clearInterval(activeFastUpdateInterval);
                activeFastUpdateInterval = null;
            }
        }

        async function getActiveFast() {
            try {
                const sessionId = window.getSessionId();
                if (!sessionId) {
                    return null;
                }

                const response = await fetch(`/api/fasts/active?sessionId=${sessionId}`);

                if (response.ok) {
                    const activeFast = await response.json();
                    return activeFast && activeFast.id ? activeFast : null;
                } else if (response.status === 404) {
                    // User profile not found or no active fast
                    return null;
                }
                return null;
            } catch (error) {
                console.error('Error fetching active fast:', error);
                return null;
            }
        }

        function formatDuration(milliseconds) {
            // Handle invalid inputs (NaN, null, undefined)
            if (isNaN(milliseconds) || milliseconds == null) {
                return '0h 0m';
            }

            // Handle negative durations (shouldn't happen but just in case)
            if (milliseconds < 0) {
                return '0h 0m';
            }

            const hours = Math.floor(milliseconds / (1000 * 60 * 60));
            const minutes = Math.floor((milliseconds % (1000 * 60 * 60)) / (1000 * 60));
            return `${hours}h ${minutes}m`;
        }


        // Dashboard card event handlers
        function handleDashboardSeeMoreClick(event) {
            event.preventDefault();
            event.stopPropagation();

            // Navigate to timer page
            window.location.href = '/timer';
        }

        function handleDashboardBenefitsSeeMoreClick(event) {
            event.preventDefault();
            event.stopPropagation();

            // Switch to benefits tab
            const benefitsTab = document.querySelector('[data-tab="benefits"]');
            if (benefitsTab) {
                benefitsTab.click();
            }
        }

        function handleDashboardHungerCardTap(event) {
            event.preventDefault();
            event.stopPropagation();

            // Navigate to timer page when hunger coach card is tapped
            window.location.href = '/timer';
        }

        function handleDashboardBenefitsCardTap(event) {
            event.preventDefault();
            event.stopPropagation();

            // Switch to benefits tab when benefits card is tapped
            const benefitsTab = document.querySelector('[data-tab="benefits"]');
            if (benefitsTab) {
                benefitsTab.click();
            }
        }

        // Load fasting data from API
        async function loadFasts() {
            fastsLoaded = false;
            renderLogEntries();

            try {
                const sessionId = window.getSessionId();
                const url = sessionId ? `/api/fasts?sessionId=${sessionId}` : '/api/fasts';

                const response = await fetch(url);
                if (response.ok) {
                    fasts = await response.json();
                    fastsLoaded = true;
                    updateStats();
                    renderLogEntries();
                } else if (response.status === 404 && sessionId) {
                    console.log('User profile missing after server restart - redirecting to onboarding');
                    if (window.pageGuard) window.pageGuard.refreshSession();
                    localStorage.removeItem('fastingForecast_profileSaved');
                    window.location.href = '/forecaster';
                    return;
                } else {
                    console.error('Failed to load fasts');
                    fasts = [];
                    fastsLoaded = true;
                    renderLogEntries();
                }
            } catch (error) {
                console.error('Error loading fasts:', error);
                fasts = [];
                fastsLoaded = true;
                renderLogEntries();
            }
        }

        function renderFastEntries() {
            if (!fasts || fasts.length === 0) {
                return '';
            }

            return fasts.map(fast => {
                const startDate = new Date(fast.start_time);
                const endDate = fast.end_time ? new Date(fast.end_time) : null;

                // Calculate duration if not stored in database
                let duration = fast.duration_hours;
                if (!duration && fast.start_time) {
                    if (fast.end_time) {
                        // Completed fast: use end_time - start_time
                        duration = (endDate - startDate) / (1000 * 60 * 60); // Convert to hours
                    } else {
                        // Active fast: use current time - start_time
                        const now = new Date();
                        duration = (now - startDate) / (1000 * 60 * 60); // Convert to hours
                    }
                }
                duration = duration || 0;

                // Compact numeric date format with time
                const formatDateTime = (date) => {
                    return date.toLocaleString(undefined, {
                        month: 'numeric',
                        day: 'numeric',
                        year: 'numeric',
                        hour: 'numeric',
                        minute: '2-digit'
                    });
                };

                const formatDuration = (hours) => {
                    if (hours < 24) {
                        return `${hours.toFixed(1)}h`;
                    } else {
                        const days = Math.floor(hours / 24);
                        const remainingHours = Math.floor(hours % 24);
                        return `${days}d ${remainingHours}h`;
                    }
                };

                // Build date range with inline status
                const statusLabel = fast.is_manual ? 'Manual' : 'Tracked';
                const dateRange = endDate
                    ? `${formatDateTime(startDate)} → ${formatDateTime(endDate)}`
                    : `Started ${formatDateTime(startDate)}`;

                const milestones = [];
                if (duration >= 16) milestones.push('16h');
                if (duration >= 24) milestones.push('24h');
                if (duration >= 48) milestones.push('48h');
                if (duration >= 72) milestones.push('72h');

                // Don't show icon in Fasts filter view (only in All filter)
                const icon = '';

                const header = `
                    <div class="fast-date-range">
                        ${dateRange}
                        <span class="fast-status-inline">• ${statusLabel}</span>
                    </div>
                `;

                const body = `
                    <div class="fast-duration-row">
                        <div class="card-metric">${formatDuration(duration)}</div>
                        ${milestones.length > 0 ? `
                            <div class="card-milestones">
                                ${milestones.map(m => `<span class="milestone-badge">${m}</span>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                    ${fast.notes ? `<div class="fast-notes">${escapeHtml(fast.notes)}</div>` : ''}
                `;

                const actions = renderKebabMenu([
                    { label: 'Edit', action: 'edit-fast', dataAttrs: `data-fast-id="${fast.id}"` },
                    { label: 'Delete', action: 'delete-fast', variant: 'danger', dataAttrs: `data-fast-id="${fast.id}"` }
                ]);

                return renderUnifiedCard({
                    type: 'fast',
                    icon,
                    header,
                    body,
                    actions,
                    dataAttrs: `data-fast-id="${fast.id}"`
                });
            }).join('');
        }

        function renderLogEntries() {
            const loadingState = document.getElementById('loading-state');
            const emptyState = document.getElementById('empty-state');
            const emptyTitle = document.getElementById('log-empty-title');
            const emptyDescription = document.getElementById('log-empty-description');
            const logList = document.getElementById('log-list');

            if (!loadingState || !emptyState || !logList) {
                return;
            }

            if (!isLogDataReadyForFilter(currentLogFilter)) {
                loadingState.style.display = 'block';
                emptyState.style.display = 'none';
                logList.innerHTML = '';
                return;
            }

            loadingState.style.display = 'none';

            let content = '';

            switch (currentLogFilter) {
                case 'body':
                    setEmptyStateCopy(
                        emptyTitle,
                        emptyDescription,
                        'No body entries yet',
                        'Log a weigh-in to start tracking weight trends alongside your fasts.'
                    );
                    content = renderBodyLogEntries();
                    break;
                case 'all':
                    setEmptyStateCopy(
                        emptyTitle,
                        emptyDescription,
                        'No activity logged yet',
                        'Add a fast or log a body entry to see your history here.'
                    );
                    content = renderCombinedLogEntries();
                    break;
                case 'fasts':
                default:
                    setEmptyStateCopy(
                        emptyTitle,
                        emptyDescription,
                        'No fasts recorded yet',
                        'Start your first fast or add a previous fast manually to begin tracking your journey.'
                    );
                    content = renderFastEntries();
                    break;
            }

            if (currentLogFilter === 'all') {
                logList.classList.add('log-timeline');
            } else {
                logList.classList.remove('log-timeline');
            }

            if (!content) {
                emptyState.style.display = 'block';
                logList.innerHTML = '';
            } else {
                emptyState.style.display = 'none';
                logList.innerHTML = content;
                if (pendingScrollTarget) {
                    requestAnimationFrame(() => {
                        const target = document.querySelector(`[data-entry-id="${pendingScrollTarget}"]`);
                        if (target) {
                            target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        pendingScrollTarget = null;
                    });
                }
            }
        }

        function isLogDataReadyForFilter(filter) {
            switch (filter) {
                case 'body':
                    return bodyEntriesLoaded;
                case 'all':
                    return fastsLoaded && bodyEntriesLoaded;
                case 'fasts':
                default:
                    return fastsLoaded;
            }
        }

        function setEmptyStateCopy(titleElement, descriptionElement, title, description) {
            if (titleElement) {
                titleElement.textContent = title;
            }
            if (descriptionElement) {
                descriptionElement.textContent = description;
            }
        }

        function renderBodyLogEntries() {
            if (!bodyLogEntries || bodyLogEntries.length === 0) {
                return '';
            }

            const grouped = new Map();

            bodyLogEntries.forEach((entry) => {
                const dateKey = getBodyEntryDateKey(entry);
                if (!grouped.has(dateKey)) {
                    grouped.set(dateKey, []);
                }
                grouped.get(dateKey).push(entry);
            });

            const sortedDates = Array.from(grouped.keys()).sort((a, b) => new Date(b) - new Date(a));

            return sortedDates
                .map((dateKey) => renderBodyDaySection(dateKey, grouped.get(dateKey)))
                .join('');
        }

        function renderBodyDaySection(dateKey, entries) {
            const sortedEntries = [...entries].sort((a, b) => new Date(a.loggedAt) - new Date(b.loggedAt));
            const canonicalEntry = sortedEntries.find((entry) => entry.isCanonical);
            const expanded = expandedBodyDates.has(dateKey);

            const summaryWeight = canonicalEntry ? formatWeightValue(canonicalEntry.weight) : '—';
            const summaryBodyFat = canonicalEntry && canonicalEntry.bodyFat !== undefined && canonicalEntry.bodyFat !== null
                ? formatBodyFatValue(canonicalEntry.bodyFat)
                : '—';
            const canonicalTag = canonicalEntry
                ? formatBodyEntryTag(canonicalEntry.canonicalReason || canonicalEntry.entryTag)
                : null;
            const canonicalClass = canonicalEntry ? (canonicalEntry.canonicalReason || canonicalEntry.entryTag || '').replace(/\s+/g, '_') : '';

            // Don't show icon in Body filter view (only in All filter)
            const icon = '';

            const header = `
                <div class="card-date">${formatBodyEntryDateDisplay(dateKey)}</div>
                <div class="card-summary">
                    <span class="summary-weight">${summaryWeight}</span>
                    <span class="summary-bodyfat">${summaryBodyFat}</span>
                    ${canonicalTag ? `<span class="body-log-tag ${canonicalClass}">${canonicalTag}</span>` : ''}
                </div>
                ${renderChevron(expanded)}
            `;

            const body = `
                <div class="card-entries">
                    ${sortedEntries.map((entry) => renderBodyEntry(entry)).join('')}
                </div>
            `;

            // Wrap in button for toggle behavior
            const cardHtml = renderUnifiedCard({
                type: 'body-log-container',
                icon,
                header,
                body,
                expandable: true,
                expanded,
                dataAttrs: `data-body-day="${dateKey}"`
            });

            // Replace the header div with a button for accessibility
            return cardHtml.replace(
                '<div class="unified-card-header">',
                '<button type="button" class="unified-card-header" data-log-action="toggle-body-day" data-body-day="' + dateKey + '">'
            ).replace(
                '</div>\n                    <div class="unified-card-body">',
                '</button>\n                    <div class="unified-card-body">'
            ).replace(
                '</div>\n                </div>',
                '</div>\n                </button>'
            );
        }

        function renderBodyEntry(entry) {
            const dateTime = getEntryLocalDateTime(entry);
            const timeDisplay = dateTime
                ? dateTime.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit' })
                : '--:--';
            const tagLabel = formatBodyEntryTag(entry.entryTag);
            const tagClass = (entry.entryTag || '').replace(/\s+/g, '_');
            const canonicalLabel = entry.isCanonical
                ? `Canonical${entry.canonicalStatus === 'manual' ? ' • Manual' : ''}`
                : null;
            const canonicalReasonLabel = entry.isCanonical && (entry.canonicalReason || entry.entryTag)
                ? formatBodyEntryTag(entry.canonicalReason || entry.entryTag)
                : null;

            // Build kebab menu actions
            const kebabActions = [];
            if (entry.isCanonical && entry.canonicalStatus === 'manual') {
                kebabActions.push({ label: 'Clear Override', action: 'clear-body-canonical' });
            } else if (!entry.isCanonical) {
                kebabActions.push({ label: 'Set Canonical', action: 'set-body-canonical' });
            }
            kebabActions.push({ label: 'Edit', action: 'edit-body-entry' });
            kebabActions.push({ label: 'Delete', action: 'delete-body-entry', variant: 'danger' });

            const metaParts = [timeDisplay];
            if (entry.source && entry.source !== 'manual') {
                metaParts.push(formatBodyEntrySource(entry));
            }
            if (entry.fastId) {
                metaParts.push(`Linked to fast #${entry.fastId}`);
            }

            return `
                <article class="body-log-entry${entry.isCanonical ? ' canonical' : ''}" data-entry-id="${entry.id}">
                    <div class="body-log-entry-header">
                        <span class="body-log-metric">${formatWeightValue(entry.weight)}</span>
                        <span class="body-log-bodyfat">${entry.bodyFat !== null && entry.bodyFat !== undefined ? formatBodyFatValue(entry.bodyFat) : '—'}</span>
                        ${!entry.isCanonical ? `<span class="body-log-tag ${tagClass}">${tagLabel}</span>` : ''}
                        ${renderKebabMenu(kebabActions, `data-entry-id="${entry.id}"`)}
                    </div>
                    ${entry.isCanonical ? `
                        <div class="body-log-canonical-badge">
                            <span class="body-log-canonical-pill ${entry.canonicalStatus === 'manual' ? 'manual' : ''}">${canonicalLabel}${canonicalReasonLabel ? ` • ${canonicalReasonLabel}` : ''}</span>
                        </div>
                    ` : ''}
                    <div class="body-log-meta">${metaParts.join(' • ')}</div>
                    ${entry.notes ? `<div class="body-log-notes">${escapeHtml(entry.notes)}</div>` : ''}
                </article>
            `;
        }

        function getBodyEntryDateKey(entry) {
            if (!entry) {
                return 'unknown';
            }
            if (entry.localDate) {
                return entry.localDate;
            }
            if (entry.loggedAt) {
                return entry.loggedAt.slice(0, 10);
            }
            return 'unknown';
        }

        function formatBodyEntryDateDisplay(dateKey) {
            const date = new Date(dateKey + 'T00:00:00');
            if (Number.isNaN(date.getTime())) {
                return dateKey;
            }
            // Compact numeric format: "10/1/2025" (US) or "1/10/2025" (EU), etc.
            // Automatically adapts to user's locale
            return date.toLocaleDateString(undefined, {
                month: 'numeric',
                day: 'numeric',
                year: 'numeric'
            });
        }

        function formatBodyEntryTag(tag) {
            switch (tag) {
                case 'morning':
                    return 'Morning';
                case 'post_fast':
                    return 'Post-Fast';
                case 'ad_hoc':
                    return 'Ad Hoc';
                case 'fast_start':
                    return 'Fast Start';
                case 'fast_end':
                    return 'Fast End';
                default:
                    return (tag || 'Entry').replace(/_/g, ' ').replace(/\b\w/g, (l) => l.toUpperCase());
            }
        }

        function formatBodyEntrySource(entry) {
            switch (entry.source) {
                case 'fast_start':
                    return 'Captured at fast start';
                case 'fast_end':
                case 'fast_completion':
                    return 'Captured at fast completion';
                case 'post_fast_prompt':
                    return 'Post-fast prompt';
                default:
                    return 'Manual entry';
            }
        }

        function formatWeightValue(weight) {
            if (weight === undefined || weight === null || Number.isNaN(Number(weight))) {
                return '—';
            }
            const numeric = Number(weight);
            return `${numeric.toFixed(1)}`;
        }

        function formatBodyFatValue(bodyFat) {
            if (bodyFat === undefined || bodyFat === null || Number.isNaN(Number(bodyFat))) {
                return '—';
            }
            const numeric = Number(bodyFat);
            return `${numeric.toFixed(1)}%`;
        }

        function getEntryLocalDateTime(entry) {
            if (!entry || !entry.loggedAt) {
                return null;
            }

            const loggedAtString = String(entry.loggedAt);
            const timestamp = new Date(loggedAtString);
            if (Number.isNaN(timestamp.getTime())) {
                return null;
            }

            const hasExplicitOffset = /[zZ]|([+-]\d{2}:?\d{2})$/.test(loggedAtString);

            if (!hasExplicitOffset && typeof entry.timezoneOffsetMinutes === 'number' && !Number.isNaN(entry.timezoneOffsetMinutes)) {
                // Fallback for legacy entries that lack an explicit offset.
                return new Date(timestamp.getTime() + entry.timezoneOffsetMinutes * 60 * 1000);
            }

            return timestamp;
        }

        function escapeHtml(value) {
            if (value === null || value === undefined) {
                return '';
            }
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // ============= UNIFIED CARD HELPERS =============

        function renderCardIcon(icon, accentClass) {
            return `<span class="card-icon ${accentClass}">${icon}</span>`;
        }

        function renderChevron(expanded) {
            return `<span class="card-chevron" aria-hidden="true">${expanded ? '▾' : '▸'}</span>`;
        }

        function renderKebabMenu(actions, baseDataAttrs = '') {
            if (!actions || actions.length === 0) {
                return '';
            }

            const menuItems = actions.map(action => {
                const variant = action.variant ? `card-kebab-menu-item-${action.variant}` : '';
                const dataAttrs = action.dataAttrs || baseDataAttrs;
                return `
                    <button
                        type="button"
                        class="card-kebab-menu-item ${variant}"
                        data-card-action="${action.action}"
                        ${dataAttrs}>
                        ${action.label}
                    </button>
                `;
            }).join('');

            return `
                <div class="card-kebab">
                    <button type="button" class="card-kebab-button" aria-label="More actions">
                        <span class="card-kebab-icon">⋮</span>
                    </button>
                    <div class="card-kebab-menu">
                        ${menuItems}
                    </div>
                </div>
            `;
        }

        function renderUnifiedCard(config) {
            const {
                type = '',
                icon = '',
                header = '',
                body = '',
                actions = '',
                expandable = false,
                expanded = false,
                dataAttrs = '',
                clickable = false
            } = config;

            const classes = ['unified-card', type];
            if (expandable && !expanded) classes.push('collapsed');
            if (clickable) classes.push('clickable');

            return `
                <div class="${classes.join(' ')}" ${dataAttrs}>
                    <div class="unified-card-header">
                        ${icon}
                        <div class="unified-card-header-content">
                            ${header}
                        </div>
                        ${actions}
                    </div>
                    ${body ? `<div class="unified-card-body">${body}</div>` : ''}
                </div>
            `;
        }

        // ============= END UNIFIED CARD HELPERS =============

        function renderCombinedLogEntries() {
            const combinedItems = [];

            if (Array.isArray(fasts)) {
                fasts.forEach((fast) => {
                    const timestamp = fast.end_time || fast.start_time;
                    if (!timestamp) {
                        return;
                    }
                    combinedItems.push({ type: 'fast', timestamp, fast });
                });
            }

            if (Array.isArray(bodyLogEntries)) {
                bodyLogEntries.forEach((entry) => {
                    if (!entry.loggedAt) {
                        return;
                    }
                    combinedItems.push({ type: 'body', timestamp: entry.loggedAt, entry });
                });
            }

            if (!combinedItems.length) {
                return '';
            }

            combinedItems.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            return `
                <div class="log-timeline">
                    ${combinedItems.map((item) => item.type === 'fast'
                        ? renderFastTimelineItem(item.fast)
                        : renderBodyTimelineItem(item.entry)).join('')}
                </div>
            `;
        }

        function renderFastTimelineItem(fast) {
            const startDate = fast.start_time ? new Date(fast.start_time) : null;
            const endDate = fast.end_time ? new Date(fast.end_time) : null;
            const isActive = !endDate && startDate;

            let durationHours = fast.duration_hours
                ? Number(fast.duration_hours)
                : startDate && endDate
                    ? (endDate - startDate) / (1000 * 60 * 60)
                    : null;

            // For active fasts, calculate current duration
            if (isActive && startDate) {
                const now = new Date();
                durationHours = (now - startDate) / (1000 * 60 * 60);
            }

            const durationLabel = isActive
                ? `Active (${durationHours ? formatFastDuration(durationHours) : '0h'})`
                : durationHours ? formatFastDuration(durationHours) : '—';
            const anchorDate = endDate || startDate;
            const timestampLabel = anchorDate ? formatTimelineDate(anchorDate) : '';

            const icon = renderCardIcon('⏱️', 'accent-orange');

            // Just show the date, no title
            const header = `
                <span class="log-timeline-date-only">${timestampLabel}</span>
            `;

            const body = `
                <div class="log-timeline-metric">${durationLabel}</div>
                ${fast.notes ? `<div class="log-timeline-notes">${escapeHtml(fast.notes)}</div>` : ''}
            `;

            const actions = renderKebabMenu([
                { label: 'Edit', action: 'edit-fast', dataAttrs: `data-fast-id="${fast.id}"` },
                { label: 'Delete', action: 'delete-fast', variant: 'danger', dataAttrs: `data-fast-id="${fast.id}"` }
            ]);

            const cardContent = renderUnifiedCard({
                type: 'timeline-fast',
                icon,
                header,
                body,
                actions,
                dataAttrs: `data-fast-id="${fast.id}"`
            });

            return `
                <div class="log-timeline-item log-timeline-item-fast">
                    ${cardContent}
                </div>
            `;
        }

        function renderBodyTimelineItem(entry) {
            const dateTime = getEntryLocalDateTime(entry);
            const timestampLabel = dateTime ? formatTimelineDate(dateTime) : '';
            const tagLabel = formatBodyEntryTag(entry.entryTag);
            const tagClass = (entry.entryTag || '').replace(/\s+/g, '_');

            const icon = renderCardIcon('⚖️', 'accent-blue');

            // Just show the date, no title
            const header = `
                <span class="log-timeline-date-only">${timestampLabel}</span>
            `;

            const body = `
                <div class="timeline-body-metrics">
                    <span class="log-timeline-metric">${formatWeightValue(entry.weight)}</span>
                    <span class="log-timeline-submetric">${entry.bodyFat !== null && entry.bodyFat !== undefined ? formatBodyFatValue(entry.bodyFat) : '—'}</span>
                    <span class="body-log-tag ${tagClass}">${tagLabel}</span>
                </div>
                ${entry.notes ? `<div class="log-timeline-notes">${escapeHtml(entry.notes)}</div>` : ''}
            `;

            const actions = renderKebabMenu([
                { label: 'Edit', action: 'edit-body-entry', dataAttrs: `data-entry-id="${entry.id}"` },
                { label: 'Delete', action: 'delete-body-entry', variant: 'danger', dataAttrs: `data-entry-id="${entry.id}"` }
            ]);

            const cardContent = renderUnifiedCard({
                type: 'timeline-body',
                icon,
                header,
                body,
                actions,
                dataAttrs: `data-entry-id="${entry.id}"`
            });

            return `
                <div class="log-timeline-item log-timeline-item-body">
                    ${cardContent}
                </div>
            `;
        }

        function formatTimelineDate(date) {
            // Compact numeric format: "10/1/2025, 8:15 PM"
            return date.toLocaleString(undefined, {
                month: 'numeric',
                day: 'numeric',
                year: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
            });
        }

        function formatFastDuration(hours) {
            if (!hours && hours !== 0) {
                return '—';
            }

            if (hours < 24) {
                return `${hours.toFixed(1)}h`;
            }

            const wholeHours = Math.floor(hours);
            const days = Math.floor(wholeHours / 24);
            const remainingHours = wholeHours % 24;
            return `${days}d ${remainingHours}h`;
        }

        function setupLogControls() {
            if (logControlsInitialized) {
                updateLogActionState();
                return;
            }

            const filterButtons = document.querySelectorAll('.log-filter-btn');
            filterButtons.forEach((button) => {
                button.addEventListener('click', () => {
                    const targetFilter = button.getAttribute('data-log-filter');
                    if (targetFilter) {
                        setLogFilter(targetFilter);
                    }
                });
            });

            const primaryActionButton = document.getElementById('log-primary-action');
            if (primaryActionButton) {
                primaryActionButton.addEventListener('click', handlePrimaryLogAction);
            }

            const actionMenu = document.getElementById('log-action-menu');
            if (actionMenu) {
                actionMenu.addEventListener('click', (event) => {
                    const menuItem = event.target.closest('.log-action-menu-item');
                    if (!menuItem) {
                        return;
                    }
                    event.preventDefault();
                    handleLogMenuSelection(menuItem.getAttribute('data-action'));
                });
            }

            document.addEventListener('click', handleDocumentClickForLogActionMenu);

            logControlsInitialized = true;
            updateLogActionState();
        }

        function setupLogListInteractions() {
            if (logListInteractionInitialized) {
                return;
            }

            const logList = document.getElementById('log-list');
            if (logList) {
                logList.addEventListener('click', handleLogListClick);
            }

            logListInteractionInitialized = true;
        }

        function setupChartInteractions() {
            if (chartControlsInitialized) {
                return;
            }

            const toggle = document.getElementById('toggle-post-fast');
            if (toggle) {
                toggle.addEventListener('change', (event) => {
                    showPostFastPoints = !!event.target.checked;
                    renderWeightChart();
                });
            }

            const viewFilters = document.querySelectorAll('.chart-view-filter');
            viewFilters.forEach(button => {
                button.addEventListener('click', (event) => {
                    const newView = event.target.dataset.view;
                    if (newView && newView !== chartViewFilter) {
                        chartViewFilter = newView;

                        viewFilters.forEach(btn => btn.classList.remove('active'));
                        event.target.classList.add('active');

                        renderWeightChart();
                    }
                });
            });

            const expandBtn = document.getElementById('expand-chart-btn');
            const modal = document.getElementById('chart-modal');
            const closeModalBtn = document.getElementById('close-chart-modal');
            const modalBody = document.getElementById('chart-modal-body');

            if (expandBtn && modal && closeModalBtn && modalBody) {
                expandBtn.addEventListener('click', () => {

                    const chartContainer = document.querySelector('.chart-container');
                    const chartLegend = document.querySelector('.chart-legend');
                    const chartFootnote = document.querySelector('.chart-footnote');

                    // Clone chart elements
                    const clonedContainer = chartContainer.cloneNode(true);
                    const clonedLegend = chartLegend ? chartLegend.cloneNode(true) : null;
                    const clonedFootnote = chartFootnote ? chartFootnote.cloneNode(true) : null;

                    // Add modal-specific class for full-width styling
                    clonedContainer.classList.add('chart-container-modal');
                    if (clonedLegend) clonedLegend.classList.add('chart-legend-modal');
                    if (clonedFootnote) clonedFootnote.classList.add('chart-footnote-modal');

                    // Remove expand button from cloned container
                    const clonedExpandBtn = clonedContainer.querySelector('.chart-expand-btn');
                    if (clonedExpandBtn) {
                        clonedExpandBtn.remove();
                    }

                    // Build modal content
                    modalBody.innerHTML = '';
                    modalBody.appendChild(clonedContainer);
                    if (clonedLegend) modalBody.appendChild(clonedLegend);
                    if (clonedFootnote) modalBody.appendChild(clonedFootnote);

                    modal.classList.add('active');
                    document.body.style.overflow = 'hidden';

                    // Setup tooltips for the cloned chart
                    setupModalChartTooltips(clonedContainer);
                });

                closeModalBtn.addEventListener('click', () => {
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                });

                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                        document.body.style.overflow = '';
                    }
                });
            }

            chartControlsInitialized = true;
        }

        async function loadBodyAnalytics() {
            chartsLoading = true;
            chartsError = null;
            renderCharts();

            try {
                const sessionId = window.getSessionId();
                const url = sessionId ? `/api/body-log/analytics?sessionId=${sessionId}` : '/api/body-log/analytics';
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Analytics fetch failed with status ${response.status}`);
                }
                bodyAnalytics = await response.json();
                chartsLoading = false;
                chartsError = null;
                renderCharts();
                updateLogStatsDisplay();
            } catch (error) {
                console.error('Error loading body analytics:', error);
                bodyAnalytics = null;
                chartsLoading = false;
                chartsError = 'Unable to load charts right now.';
                renderCharts();
                updateLogStatsDisplay();
            }
        }

        function renderCharts() {
            renderWeightChart();
            renderWeeklyComposition();
            renderFastEffectivenessCard();
            renderRollingInsightsCard();
            renderRetentionCard();
        }

        function renderWeightChart() {
            const svg = document.getElementById('weight-trend-chart');
            const summaryEl = document.getElementById('chart-weight-summary');
            const footnoteEl = document.getElementById('chart-footnote');
            const toggle = document.getElementById('toggle-post-fast');

            if (!svg || !summaryEl || !footnoteEl) {
                return;
            }

            if (chartsLoading) {
                svg.innerHTML = '';
                summaryEl.textContent = 'Loading your weight trend…';
                footnoteEl.textContent = '';
                if (toggle) {
                    toggle.disabled = true;
                }
                return;
            }

            if (chartsError) {
                svg.innerHTML = '';
                summaryEl.textContent = chartsError;
                footnoteEl.textContent = '';
                if (toggle) {
                    toggle.disabled = true;
                }
                return;
            }

            if (!bodyAnalytics || !Array.isArray(bodyAnalytics.canonicalEntries) || bodyAnalytics.canonicalEntries.length === 0) {
                svg.innerHTML = '';
                summaryEl.textContent = 'Log a few morning weigh-ins to see your trend.';
                footnoteEl.textContent = '';
                if (toggle) {
                    toggle.disabled = true;
                }
                return;
            }

            if (toggle) {
                toggle.disabled = false;
                toggle.checked = showPostFastPoints;
            }

            let canonical = bodyAnalytics.canonicalEntries
                .filter((entry) => entry && entry.weight !== null && entry.loggedAt)
                .map((entry) => ({
                    ...entry,
                    date: new Date(entry.loggedAt)
                }))
                .sort((a, b) => a.date.getTime() - b.date.getTime());

            if (canonical.length === 0) {
                svg.innerHTML = '';
                summaryEl.textContent = 'Log a few morning weigh-ins to see your trend.';
                footnoteEl.textContent = '';
                return;
            }

            const now = new Date();
            if (chartViewFilter === 'week') {
                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                canonical = canonical.filter(entry => entry.date >= weekAgo);
            } else if (chartViewFilter === 'month') {
                const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                canonical = canonical.filter(entry => entry.date >= monthAgo);
            }

            if (canonical.length === 0) {
                svg.innerHTML = '';
                summaryEl.textContent = `No data in the selected time range.`;
                footnoteEl.textContent = '';
                return;
            }

            const dateMin = new Date(Math.min(...canonical.map((entry) => entry.date.getTime())));
            const dateMax = new Date(Math.max(...canonical.map((entry) => entry.date.getTime())));

            let filteredPostFastEntries = [];
            if (showPostFastPoints && Array.isArray(bodyAnalytics.postFastEntries)) {
                filteredPostFastEntries = bodyAnalytics.postFastEntries.filter((entry) => {
                    if (!entry.loggedAt) return false;
                    const date = new Date(entry.loggedAt);
                    return date >= dateMin && date <= dateMax;
                });
            }
            if (dateMin.getTime() === dateMax.getTime()) {
                dateMax.setDate(dateMax.getDate() + 1);
            }

            const weightValues = canonical.map((entry) => entry.weight);
            const weightMin = Math.min(...weightValues) - 1;
            const weightMax = Math.max(...weightValues) + 1;

            const width = 400;
            const height = 360;
            const margin = { top: 30, right: 40, bottom: 50, left: 65 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;

            const xScale = (date) => {
                const ratio = (date.getTime() - dateMin.getTime()) / (dateMax.getTime() - dateMin.getTime());
                return margin.left + ratio * chartWidth;
            };

            const yScale = (weight) => {
                const ratio = (weight - weightMin) / (weightMax - weightMin || 1);
                return margin.top + (1 - ratio) * chartHeight;
            };

            const linePath = canonical
                .map((entry, index) => {
                    const x = xScale(entry.date);
                    const y = yScale(entry.weight);
                    const command = index === 0 ? 'M' : 'L';
                    return `${command}${x},${y}`;
                })
                .join(' ');

            const canonicalCircles = canonical.map((entry) => {
                const x = xScale(entry.date);
                const y = yScale(entry.weight);
                const title = `${formatShortDate(entry.date)} • ${formatWeight(entry.weight)}`;
                return `<circle cx="${x}" cy="${y}" r="6" fill="#fb923c" stroke="#fff" stroke-width="2" class="data-point canonical-point"><title>${title}</title></circle>`;
            }).join('');

            const postFastPoints = filteredPostFastEntries
                .filter((entry) => entry.weight !== null)
                .map((entry) => {
                    const date = new Date(entry.loggedAt);
                    const x = xScale(date);
                    const y = yScale(entry.weight);
                    const title = `${formatShortDateTime(date)} • ${formatWeight(entry.weight)} (Post-Fast)`;
                    return `<circle cx="${x}" cy="${y}" r="6" fill="#fff" stroke="#38bdf8" stroke-width="2.5" class="data-point post-fast-point"><title>${title}</title></circle>`;
                })
                .join('');

            const fastBands = Array.isArray(bodyAnalytics.fasts)
                ? bodyAnalytics.fasts
                    .filter((fast) => fast.startTime)
                    .map((fast) => {
                        const start = new Date(fast.startTime);
                        const end = fast.endTime ? new Date(fast.endTime) : new Date();

                        if (end.getTime() < dateMin.getTime() || start.getTime() > dateMax.getTime()) {
                            return null;
                        }

                        const clampedStart = start.getTime() < dateMin.getTime() ? dateMin : start;
                        const clampedEnd = end.getTime() > dateMax.getTime() ? dateMax : end;

                        const x = xScale(clampedStart);
                        const widthRect = Math.max(2, xScale(clampedEnd) - x);
                        return `<rect x="${x}" y="${margin.top}" width="${widthRect}" height="${chartHeight}" fill="rgba(56,189,248,0.16)" stroke="rgba(14,165,233,0.3)" stroke-width="1" />`;
                    })
                    .filter(Boolean)
                    .join('')
                : '';

            const axes = `
                <line x1="${margin.left}" y1="${height - margin.bottom}" x2="${width - margin.right}" y2="${height - margin.bottom}" stroke="#cbd5f5" stroke-width="1" />
                <line x1="${margin.left}" y1="${margin.top}" x2="${margin.left}" y2="${height - margin.bottom}" stroke="#cbd5f5" stroke-width="1" />
            `;

            const yTicks = 4;
            const yTickElements = [];
            for (let i = 0; i <= yTicks; i += 1) {
                const weight = weightMin + ((weightMax - weightMin) / yTicks) * i;
                const y = yScale(weight);
                yTickElements.push(`
                    <line x1="${margin.left - 6}" y1="${y}" x2="${margin.left}" y2="${y}" stroke="#94a3b8" stroke-width="1" />
                    <text x="${margin.left - 10}" y="${y + 4}" text-anchor="end" font-size="11" fill="#64748b" font-weight="600" font-family="-apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif" font-stretch="expanded" letter-spacing="0.5" transform="scale(1.2, 1) translate(${(margin.left - 10) * -0.2 / 1.2}, 0)">${weight.toFixed(0)}</text>
                `);
            }

            const xTickDates = buildXTicks(dateMin, dateMax);
            const xTickElements = xTickDates.map((tickDate, index) => {
                const x = xScale(tickDate);
                const showLabel = index === 0 || index === xTickDates.length - 1 || index % 2 === 0;
                return `
                    <line x1="${x}" y1="${height - margin.bottom}" x2="${x}" y2="${height - margin.bottom + 6}" stroke="#94a3b8" stroke-width="1" />
                    ${showLabel ? `<text x="${x}" y="${height - margin.bottom + 20}" text-anchor="middle" font-size="11" fill="#64748b" font-weight="600" font-family="-apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif" font-stretch="expanded" letter-spacing="0.5" transform="scale(1.2, 1)">${formatShortDate(tickDate)}</text>` : ''}
                `;
            }).join('');

            svg.innerHTML = `
                ${fastBands || ''}
                ${axes}
                ${yTickElements.join('')}
                ${xTickElements}
                <path d="${linePath}" fill="none" stroke="#fb923c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                ${canonicalCircles}
                ${postFastPoints || ''}
            `;

            const latestEntry = canonical[canonical.length - 1];
            const firstEntry = canonical[0] || null;
            if (latestEntry) {
                let summary = `${formatWeight(latestEntry.weight)} • ${formatShortDate(latestEntry.date)}`;
                if (firstEntry && canonical.length > 1) {
                    const delta = latestEntry.weight - firstEntry.weight;
                    if (Math.abs(delta) >= 0.1) {
                        summary += ` (${formatDelta(delta)})`;
                    }
                }
                summaryEl.textContent = summary;
            }

            footnoteEl.textContent = 'Solid markers show canonical daily weigh-ins. Hollow markers show post-fast readings logged within two hours of ending a fast.';

            setupChartTooltips();
        }

        function setupChartTooltips() {
            const svg = document.getElementById('weight-trend-chart');
            const tooltip = document.getElementById('chart-tooltip');

            if (!svg || !tooltip) return;

            const dataPoints = svg.querySelectorAll('.data-point');

            dataPoints.forEach(point => {
                point.addEventListener('mouseenter', (e) => {
                    const title = e.target.querySelector('title');
                    if (title) {
                        tooltip.textContent = title.textContent;
                        tooltip.classList.add('visible');
                    }
                });

                point.addEventListener('mousemove', (e) => {
                    const rect = svg.getBoundingClientRect();
                    const container = svg.parentElement;
                    const containerRect = container.getBoundingClientRect();

                    let left = e.clientX - rect.left + 10;
                    let top = e.clientY - rect.top - 30;

                    // Check if tooltip would go off right edge
                    const tooltipWidth = tooltip.offsetWidth;
                    const tooltipHeight = tooltip.offsetHeight;

                    if (left + tooltipWidth > containerRect.width) {
                        left = e.clientX - rect.left - tooltipWidth - 10;
                    }

                    // Check if tooltip would go off left edge
                    if (left < 0) {
                        left = 10;
                    }

                    // Check if tooltip would go off top edge
                    if (top < 0) {
                        top = e.clientY - rect.top + 10;
                    }

                    // Check if tooltip would go off bottom edge
                    if (top + tooltipHeight > containerRect.height) {
                        top = containerRect.height - tooltipHeight - 10;
                    }

                    tooltip.style.left = left + 'px';
                    tooltip.style.top = top + 'px';
                });

                point.addEventListener('mouseleave', () => {
                    tooltip.classList.remove('visible');
                });
            });
        }

        function setupModalChartTooltips(container) {
            const svg = container.querySelector('.chart-svg');
            const tooltip = container.querySelector('.chart-tooltip');

            if (!svg || !tooltip) return;

            const dataPoints = svg.querySelectorAll('.data-point');

            dataPoints.forEach(point => {
                point.addEventListener('mouseenter', (e) => {
                    const title = e.target.querySelector('title');
                    if (title) {
                        tooltip.textContent = title.textContent;
                        tooltip.classList.add('visible');
                    }
                });

                point.addEventListener('mousemove', (e) => {
                    const rect = svg.getBoundingClientRect();
                    const containerRect = container.getBoundingClientRect();

                    let left = e.clientX - rect.left + 10;
                    let top = e.clientY - rect.top - 30;

                    // Check if tooltip would go off right edge
                    const tooltipWidth = tooltip.offsetWidth;
                    const tooltipHeight = tooltip.offsetHeight;

                    if (left + tooltipWidth > containerRect.width) {
                        left = e.clientX - rect.left - tooltipWidth - 10;
                    }

                    // Check if tooltip would go off left edge
                    if (left < 0) {
                        left = 10;
                    }

                    // Check if tooltip would go off top edge
                    if (top < 0) {
                        top = e.clientY - rect.top + 10;
                    }

                    // Check if tooltip would go off bottom edge
                    if (top + tooltipHeight > containerRect.height) {
                        top = containerRect.height - tooltipHeight - 10;
                    }

                    tooltip.style.left = left + 'px';
                    tooltip.style.top = top + 'px';
                });

                point.addEventListener('mouseleave', () => {
                    tooltip.classList.remove('visible');
                });
            });
        }

        function buildXTicks(startDate, endDate) {
            const ticks = [];
            const totalMs = endDate.getTime() - startDate.getTime();
            if (totalMs <= 0) {
                return [startDate];
            }
            const intervals = 4;
            ticks.push(new Date(startDate));
            for (let i = 1; i < intervals; i += 1) {
                const ratio = i / intervals;
                ticks.push(new Date(startDate.getTime() + totalMs * ratio));
            }
            ticks.push(new Date(endDate));
            return ticks;
        }

        function renderWeeklyComposition() {
            const list = document.getElementById('weekly-composition-list');
            const summaryEl = document.getElementById('weekly-composition-summary');
            if (!list || !summaryEl) {
                return;
            }

            if (chartsLoading) {
                list.innerHTML = '<div class="weekly-empty">Loading weekly insights…</div>';
                summaryEl.textContent = 'Loading weekly fat vs lean breakdown…';
                return;
            }

            if (chartsError) {
                list.innerHTML = `<div class="weekly-empty">${chartsError}</div>`;
                summaryEl.textContent = chartsError;
                return;
            }

            if (!bodyAnalytics || !Array.isArray(bodyAnalytics.weeklyComposition) || bodyAnalytics.weeklyComposition.length === 0) {
                list.innerHTML = '<div class="weekly-empty">Add a few body fat % readings to unlock weekly fat vs. lean tracking.</div>';
                summaryEl.textContent = 'Log morning weigh-ins with body fat % to unlock fat/lean tracking.';
                return;
            }

            const rows = bodyAnalytics.weeklyComposition.map((week) => {
                const label = `Week of ${formatWeekLabel(week.weekStart)}`;
                return `
                    <div class="weekly-row">
                        <div class="weekly-col">
                            <span class="weekly-label">Week</span>
                            <span class="weekly-value">${label}</span>
                        </div>
                        <div class="weekly-col">
                            <span class="weekly-label">Avg Weight</span>
                            <span class="weekly-value">${formatWeight(week.averageWeight)}</span>
                            <span class="weekly-delta ${week.deltaWeight > 0 ? 'positive' : week.deltaWeight < 0 ? 'negative' : ''}">${formatDelta(week.deltaWeight)}</span>
                        </div>
                        <div class="weekly-col">
                            <span class="weekly-label">Avg Fat Mass</span>
                            <span class="weekly-value">${formatWeight(week.averageFatMass)}</span>
                            <span class="weekly-delta ${week.deltaFatMass > 0 ? 'positive' : week.deltaFatMass < 0 ? 'negative' : ''}">${formatDelta(week.deltaFatMass)}</span>
                        </div>
                        <div class="weekly-col">
                            <span class="weekly-label">Avg Lean Mass</span>
                            <span class="weekly-value">${formatWeight(week.averageLeanMass)}</span>
                            <span class="weekly-delta ${week.deltaLeanMass > 0 ? 'positive' : week.deltaLeanMass < 0 ? 'negative' : ''}">${formatDelta(week.deltaLeanMass)}</span>
                        </div>
                    </div>
                `;
            }).join('');

            list.innerHTML = rows;

            const latest = bodyAnalytics.weeklyComposition[bodyAnalytics.weeklyComposition.length - 1];
            if (latest) {
                const fatDelta = formatDelta(latest.deltaFatMass);
                const leanDelta = formatDelta(latest.deltaLeanMass);
                summaryEl.textContent = `Latest week: ${fatDelta.replace('+', '')} fat, ${leanDelta.replace('+', '')} lean.`;
            }
        }

        function renderRetentionCard() {
            const container = document.getElementById('retention-content');
            const subtitle = document.getElementById('retention-subtitle');
            if (!container || !subtitle) {
                return;
            }

            if (chartsLoading) {
                container.innerHTML = '<div class="retention-message">Loading retention insight…</div>';
                subtitle.textContent = 'Loading your latest retention insight…';
                return;
            }

            if (chartsError) {
                container.innerHTML = `<div class="retention-message">${chartsError}</div>`;
                subtitle.textContent = chartsError;
                return;
            }

            if (!bodyAnalytics || !bodyAnalytics.retention) {
                container.innerHTML = '<div class="retention-message">Complete a fast with start and post-fast weights to see retention insights.</div>';
                subtitle.textContent = 'Complete a fast with weigh-ins to see how much stuck.';
                return;
            }

            const retention = bodyAnalytics.retention;

            if (retention.status === 'waiting') {
                container.innerHTML = `<div class="retention-message">${retention.message}</div>`;
                subtitle.textContent = 'We’re watching for your next canonical weigh-in after the fast.';
                return;
            }

            if (retention.status !== 'ok') {
                container.innerHTML = `<div class="retention-message">${retention.message}</div>`;
                subtitle.textContent = 'Complete a fast with start and post-fast weights to see retention insights.';
                return;
            }

            subtitle.textContent = 'Compared to your next canonical weigh-in within 48 hours.';

            container.innerHTML = `
                <div class="retention-highlight">${retention.retentionPercent != null ? `${retention.retentionPercent}%` : '—'}</div>
                <div class="retention-message">of your post-fast drop stayed off by the next weigh-in.</div>
                <div class="retention-details">
                    <div class="retention-detail">
                        <span class="retention-detail-label">Post-Fast Weight</span>
                        <span class="retention-detail-value">${formatWeight(retention.postFastWeight)}</span>
                        <span class="retention-detail-label">Logged</span>
                        <span class="retention-detail-value">${formatShortDateTime(retention.postFastLoggedAt)}</span>
                    </div>
                    <div class="retention-detail">
                        <span class="retention-detail-label">Next Canonical</span>
                        <span class="retention-detail-value">${formatWeight(retention.nextCanonicalWeight)}</span>
                        <span class="retention-detail-label">Logged</span>
                        <span class="retention-detail-value">${formatShortDateTime(retention.nextCanonicalLoggedAt)}</span>
                    </div>
                    <div class="retention-detail">
                        <span class="retention-detail-label">Lost During Fast</span>
                        <span class="retention-detail-value">${formatWeight(retention.weightLostDuringFast)}</span>
                        <span class="retention-detail-label">Regained</span>
                        <span class="retention-detail-value">${formatWeight(retention.weightRegained)}</span>
                    </div>
                </div>
            `;
        }

        function toggleFluidBreakdown() {
            const breakdown = document.getElementById('fluid-breakdown');
            const toggleText = document.getElementById('fluid-toggle-text');
            const toggleIcon = document.getElementById('fluid-toggle-icon');
            const toggleBtn = document.getElementById('fluid-toggle-btn');

            if (!breakdown) return;

            const isVisible = breakdown.style.display === 'flex';
            breakdown.style.display = isVisible ? 'none' : 'flex';
            if (toggleText) {
                toggleText.textContent = isVisible ? 'Show fluid breakdown' : 'Hide fluid breakdown';
            }
            if (toggleIcon) {
                toggleIcon.textContent = isVisible ? '▼' : '▲';
            }
            if (toggleBtn) {
                toggleBtn.setAttribute('aria-expanded', (!isVisible).toString());
            }
        }

        function renderFastEffectivenessCard() {
            const container = document.getElementById('fast-effectiveness-content');
            const subtitle = document.getElementById('fast-effectiveness-subtitle');
            if (!container || !subtitle) {
                return;
            }

            if (chartsLoading) {
                container.innerHTML = '<div class="insight-placeholder">Loading fast effectiveness…</div>';
                subtitle.textContent = 'Sizing up your most recent fast…';
                return;
            }

            if (chartsError) {
                container.innerHTML = `<div class="insight-placeholder">${chartsError}</div>`;
                subtitle.textContent = chartsError;
                return;
            }

            const effectiveness = bodyAnalytics && bodyAnalytics.fastEffectiveness;

            if (!effectiveness || !effectiveness.status || effectiveness.status === 'no-data') {
                container.innerHTML = '<div class="insight-placeholder">Complete a fast with start and post-fast weights to size up effectiveness.</div>';
                subtitle.textContent = 'Log start and post-fast weights to see the breakdown.';
                return;
            }

            if (effectiveness.status !== 'ok') {
                container.innerHTML = `<div class="insight-placeholder">${effectiveness.message}</div>`;
                subtitle.textContent = 'Log start and post-fast weights to see the breakdown.';
                return;
            }

            subtitle.textContent = 'Based on your most recent completed fast with start & post weigh-ins.';

            const asNumber = (value) => {
                const numeric = Number(value);
                return Number.isFinite(numeric) ? numeric : 0;
            };

            const startWeightLabel = formatWeight(effectiveness.startWeight);
            const postWeightLabel = formatWeight(effectiveness.postWeight);
            const weightDeltaLabel = formatDelta(effectiveness.weightDelta);

            let durationLabel = '—';
            let postLogged = '';
            let durationHours = effectiveness.durationHours ? Number(effectiveness.durationHours) : null;
            if (!durationHours && Array.isArray(bodyAnalytics?.fasts)) {
                const matchedFast = bodyAnalytics.fasts.find((fast) => fast && Number(fast.id) === Number(effectiveness.fastId));
                if (matchedFast) {
                    durationHours = matchedFast.durationHours ? Number(matchedFast.durationHours) : durationHours;
                    if (!durationHours && matchedFast.startTime && matchedFast.endTime) {
                        const start = new Date(matchedFast.startTime);
                        const end = new Date(matchedFast.endTime);
                        if (!Number.isNaN(start.getTime()) && !Number.isNaN(end.getTime())) {
                            durationHours = (end.getTime() - start.getTime()) / (1000 * 60 * 60);
                        }
                    }
                }
            }
            if (durationHours) {
                durationLabel = formatFastDuration(durationHours);
            }
            if (effectiveness.postFastLoggedAt) {
                postLogged = formatShortDateTime(effectiveness.postFastLoggedAt);
            }

            const isMeasured = effectiveness.breakdownSource === 'measured';
            const bfTag = (effectiveness.bodyFatChange !== null && effectiveness.bodyFatChange !== undefined && !Number.isNaN(effectiveness.bodyFatChange))
                ? formatPercentDelta(effectiveness.bodyFatChange)
                : '—';
            const modePrimary = isMeasured ? 'Measured' : 'Estimated';
            const modeSecondary = isMeasured
                ? (bfTag !== '—' ? `${bfTag} BF` : 'Body fat logged')
                : 'Metabolic estimate';

            const fatLossValue = Math.max(0, asNumber(effectiveness.fatLoss));
            const muscleLossValue = Math.max(0, asNumber(effectiveness.muscleLoss));
            const fluidLossValue = Math.max(0, asNumber(effectiveness.fluidLoss ?? effectiveness.waterLoss));
            const totalLossValue = Math.max(0, asNumber(effectiveness.totalWeightLost));
            const leanWaterValue = Math.max(0, asNumber(effectiveness.leanWater ?? effectiveness.fluidBreakdown?.leanWater));
            const fluidBreakdown = effectiveness.fluidBreakdown || {};
            const glycogenMassValue = Math.max(0, asNumber(fluidBreakdown.glycogenMass));
            const glycogenBoundWaterValue = Math.max(0, asNumber(fluidBreakdown.glycogenBoundWater));
            const gutContentValue = Math.max(0, asNumber(fluidBreakdown.gutContent));
            const residualWaterShiftValue = asNumber(fluidBreakdown.residualWaterShift);
            const otherFluidRaw = effectiveness.otherFluidLoss !== null && effectiveness.otherFluidLoss !== undefined
                ? asNumber(effectiveness.otherFluidLoss)
                : (fluidLossValue - leanWaterValue);
            const otherFluidValue = Math.max(0, otherFluidRaw);

            const fatLossLabel = formatWeight(fatLossValue);
            const muscleLossLabel = formatWeight(muscleLossValue);
            const fluidLabel = formatWeight(fluidLossValue);
            const leanWaterLabel = formatWeight(leanWaterValue);
            const otherFluidLabel = formatWeight(otherFluidValue);

            const summaryHtml = `
                <div class="effectiveness-summary">
                    <div class="summary-item">
                        <span class="summary-label">Scale</span>
                        <span class="summary-value">${weightDeltaLabel}</span>
                        <span class="summary-note">(${startWeightLabel} → ${postWeightLabel})</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Fast Length</span>
                        <span class="summary-value">${durationLabel}</span>
                        ${postLogged ? `<span class="summary-note">• ${postLogged}</span>` : ''}
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Mode</span>
                        <span class="summary-value">${modePrimary}</span>
                        ${modeSecondary ? `<span class="summary-note">${modeSecondary}</span>` : ''}
                    </div>
                </div>
            `;

            const barHtml = totalLossValue > 0.05
                ? `
                    <div class="effectiveness-bar" role="presentation" aria-hidden="true">
                        <div class="bar-segment bar-fat" style="flex: ${fatLossValue};"></div>
                        <div class="bar-segment bar-muscle" style="flex: ${muscleLossValue};"></div>
                        <div class="bar-segment bar-fluid" style="flex: ${fluidLossValue};"></div>
                    </div>
                    <div class="effectiveness-bar-legend">
                        <span class="legend-item"><span class="legend-chip fat"></span>Fat ${fatLossLabel}</span>
                        <span class="legend-item"><span class="legend-chip muscle"></span>Muscle ${muscleLossLabel}</span>
                        <span class="legend-item"><span class="legend-chip fluid"></span>Transient ${fluidLabel}</span>
                    </div>
                `
                : '';

            const breakdownHtml = `
                <div class="composition-row">
                    <div class="component-card component-fat">
                        <div class="component-top">
                            <span class="component-icon">🔥</span>
                            <button class="component-info" type="button" data-tooltip="Permanent body fat reduction — the progress that stays after refeeding." aria-label="Fat loss info" tabindex="0">i</button>
                        </div>
                        <span class="component-label">Fat Loss</span>
                        <span class="component-value">${fatLossLabel}</span>
                    </div>
                    <div class="component-card component-muscle">
                        <div class="component-top">
                            <span class="component-icon">🧬</span>
                            <button class="component-info" type="button" data-tooltip="Structural lean tissue loss — typically minimal with solid protein and resistance training." aria-label="Muscle loss info" tabindex="0">i</button>
                        </div>
                        <span class="component-label">Muscle Loss</span>
                        <span class="component-value">${muscleLossLabel}</span>
                    </div>
                    <div class="component-card component-fluid">
                        <div class="component-top">
                            <span class="component-icon">💧</span>
                            <button class="component-info" type="button" data-tooltip="Temporary shifts from muscle water, glycogen, and gut content. Expect most to rebound within 24–72 hours. Muscle water ${leanWaterLabel}; Glycogen + gut ${otherFluidLabel}." aria-label="Fluid info" tabindex="0">i</button>
                        </div>
                        <span class="component-label">Fluid & Transient</span>
                        <span class="component-value">${fluidLabel}</span>
                    </div>
                </div>
            `;

            const breakdownValues = [leanWaterValue, glycogenMassValue, glycogenBoundWaterValue, gutContentValue, residualWaterShiftValue];
            const hasFluidBreakdown = !!fluidBreakdown;

            let fluidDetailsHtml = '';
            if (hasFluidBreakdown) {
                fluidDetailsHtml = `
                    <button class="fluid-toggle-btn" onclick="toggleFluidBreakdown()" id="fluid-toggle-btn" type="button" aria-expanded="false">
                        <span id="fluid-toggle-text">Show fluid breakdown</span>
                        <span id="fluid-toggle-icon">▼</span>
                    </button>
                    <div class="fluid-breakdown" id="fluid-breakdown" style="display: none;">
                        <div class="fluid-breakdown-item">
                            <div class="fluid-breakdown-left">
                                <span class="fluid-icon">💧</span>
                                <div>
                                    <div class="fluid-label">Muscle water</div>
                                    <div class="fluid-note">Intracellular water that rebounds quickly.</div>
                                </div>
                            </div>
                            <span class="fluid-value">${leanWaterLabel}</span>
                        </div>
                        <div class="fluid-breakdown-item">
                            <div class="fluid-breakdown-left">
                                <span class="fluid-icon">⚡️</span>
                                <div>
                                    <div class="fluid-label">Glycogen mass</div>
                                    <div class="fluid-note">Stored carbohydrate fuel burned during the fast.</div>
                                </div>
                            </div>
                            <span class="fluid-value">${formatWeight(glycogenMassValue)}</span>
                        </div>
                        <div class="fluid-breakdown-item">
                            <div class="fluid-breakdown-left">
                                <span class="fluid-icon">💧</span>
                                <div>
                                    <div class="fluid-label">Glycogen-bound water</div>
                                    <div class="fluid-note">Water released as glycogen depletes.</div>
                                </div>
                            </div>
                            <span class="fluid-value">${formatWeight(glycogenBoundWaterValue)}</span>
                        </div>
                        <div class="fluid-breakdown-item">
                            <div class="fluid-breakdown-left">
                                <span class="fluid-icon">⚙️</span>
                                <div>
                                    <div class="fluid-label">Gut content</div>
                                    <div class="fluid-note">Digestive contents cleared during the fast.</div>
                                </div>
                            </div>
                            <span class="fluid-value">${formatWeight(gutContentValue)}</span>
                        </div>
                        <div class="fluid-breakdown-item">
                            <div class="fluid-breakdown-left">
                                <span class="fluid-icon">↔️</span>
                                <div>
                                    <div class="fluid-label">Residual shifts</div>
                                    <div class="fluid-note">Hydration & sodium balance changes.</div>
                                </div>
                            </div>
                            <span class="fluid-value">${formatWeight(residualWaterShiftValue)}</span>
                        </div>
                    </div>
                `;
            }

            const tags = [];
            tags.push(modePrimary);
            if (bfTag !== '—' && isMeasured) {
                tags.push(`${bfTag} BF`);
            }
            const tagsHtml = tags.length
                ? `<div class="effectiveness-tags">${tags.map((tag) => `<span class="effectiveness-tag">${tag}</span>`).join('')}</div>`
                : '';

            const bodyFatCopy = (effectiveness.startBodyFat !== null && effectiveness.startBodyFat !== undefined
                && effectiveness.postBodyFat !== null && effectiveness.postBodyFat !== undefined)
                ? `Body fat ${formatBodyFatValue(effectiveness.startBodyFat)} → ${formatBodyFatValue(effectiveness.postBodyFat)}`
                : '';

            const metaParts = [];
            if (durationLabel && durationLabel !== '—') {
                metaParts.push(`Fast length ${durationLabel}`);
            }
            if (postLogged) {
                metaParts.push(`Post-fast weigh-in ${postLogged}`);
            }
            if (bodyFatCopy) {
                metaParts.push(bodyFatCopy);
            }
            if (!metaParts.length) {
                metaParts.push('Keep logging morning weigh-ins to refine this breakdown.');
            }
            const metaText = metaParts.join(' • ');

            container.innerHTML = `
                ${summaryHtml}
                ${barHtml}
                ${breakdownHtml}
                ${fluidDetailsHtml}
                ${tagsHtml}
                <div class="effectiveness-message">${effectiveness.message}</div>
                <div class="effectiveness-meta">${metaText}</div>
            `;
        }

        function renderRollingInsightsCard() {
            const container = document.getElementById('rolling-insights-content');
            const subtitle = document.getElementById('rolling-insights-subtitle');
            if (!container || !subtitle) {
                return;
            }

            if (chartsLoading) {
                container.innerHTML = '<div class="insight-placeholder">Loading rolling insights…</div>';
                subtitle.textContent = 'Crunching your recent fasts…';
                return;
            }

            if (chartsError) {
                container.innerHTML = `<div class="insight-placeholder">${chartsError}</div>`;
                subtitle.textContent = chartsError;
                return;
            }

            const insights = bodyAnalytics && bodyAnalytics.rollingInsights;

            if (!insights || !insights.status || insights.status === 'no-data') {
                container.innerHTML = '<div class="insight-placeholder">Log start and post-fast weights to unlock rolling insights.</div>';
                subtitle.textContent = 'We need start and post-fast weigh-ins to compare protocols.';
                return;
            }

            if (insights.status !== 'ok') {
                const fallbackMessage = insights.message || 'We need more data to show rolling insights.';
                container.innerHTML = `<div class="insight-placeholder">${fallbackMessage}</div>`;
                subtitle.textContent = 'We need start and post-fast weigh-ins to compare protocols.';
                return;
            }

            subtitle.textContent = insights.education && insights.education.description
                ? insights.education.description
                : 'Based on fasts logged in this window.';

            const overviewMetrics = [
                { label: 'Avg Change', value: formatDelta(insights.averageWeightDelta) },
                { label: 'Avg Retention', value: formatPercent(insights.averageRetentionPercent) }
            ];
            if (insights.averageFatLoss !== null && insights.averageFatLoss !== undefined && !Number.isNaN(insights.averageFatLoss)) {
                overviewMetrics.push({ label: 'Likely Fat', value: formatWeight(insights.averageFatLoss) });
            }

            const overviewHtml = overviewMetrics.map((metric) => `
                <div class="rolling-metric">
                    <span class="rolling-label">${metric.label}</span>
                    <span class="rolling-value">${metric.value}</span>
                </div>
            `).join('');

            const protocolHtml = (insights.protocols || []).map((protocol) => {
                const changeLabel = formatDelta(protocol.averageWeightDelta);
                const dropLabel = protocol.averageWeightDrop !== null && protocol.averageWeightDrop !== undefined
                    ? formatWeight(protocol.averageWeightDrop)
                    : null;
                const retentionLabel = formatPercent(protocol.averageRetentionPercent);
                const fatLabel = protocol.averageFatLoss !== null && protocol.averageFatLoss !== undefined
                    ? formatWeight(protocol.averageFatLoss)
                    : null;

                const metricParts = [`Δ ${changeLabel}`];
                if (dropLabel && dropLabel !== '—') {
                    metricParts.push(`Drop ${dropLabel}`);
                }
                if (fatLabel && fatLabel !== '—') {
                    metricParts.push(`Likely fat ${fatLabel}`);
                }
                if (retentionLabel !== '—') {
                    metricParts.push(`Retention ${retentionLabel}`);
                }

                const metricsHtml = metricParts.length
                    ? metricParts.map((text) => `<span>${text}</span>`).join('')
                    : '<span>Need more weigh-ins for this protocol.</span>';

                const countLabel = protocol.count === 1 ? '1 fast' : `${protocol.count} fasts`;

                return `
                    <div class="rolling-protocol">
                        <div class="rolling-protocol-header">
                            <span class="rolling-protocol-name">${protocol.label}</span>
                            <span class="rolling-protocol-count">${countLabel}</span>
                        </div>
                        <div class="rolling-protocol-metrics">${metricsHtml}</div>
                    </div>
                `;
            }).join('');

            const protocolListHtml = protocolHtml || '<div class="insight-placeholder">We need more weigh-ins per protocol to show insights.</div>';

            const sampleSummary = `Sampling ${insights.sampleSize} fast${insights.sampleSize === 1 ? '' : 's'}${insights.protocols && insights.protocols.length ? ` • ${insights.protocols.length} protocol${insights.protocols.length === 1 ? '' : 's'}` : ''}`;
            const retentionTip = insights.education && insights.education.retention ? insights.education.retention : '';
            const extraProtocols = insights.remainingProtocols && insights.remainingProtocols.length > 0
                ? `+${insights.remainingProtocols.length} more protocol${insights.remainingProtocols.length === 1 ? '' : 's'} tracked with fewer weigh-ins.`
                : '';
            const footnoteParts = [sampleSummary, retentionTip, extraProtocols].filter((part) => part && part.length);
            const footnoteText = footnoteParts.length ? footnoteParts.join(' • ') : 'Keep logging strategic weigh-ins to compare protocols.';

            container.innerHTML = `
                <div class="rolling-overview">${overviewHtml}</div>
                <div class="rolling-protocol-list">${protocolListHtml}</div>
                <div class="rolling-footnote">${footnoteText}</div>
            `;
        }


        function setLogFilter(filter) {
            if (currentLogFilter === filter) {
                return;
            }

            currentLogFilter = filter;
            const filterButtons = document.querySelectorAll('.log-filter-btn');
            filterButtons.forEach((button) => {
                button.classList.toggle('active', button.getAttribute('data-log-filter') === currentLogFilter);
            });

            updateLogStatsDisplay();
            updateLogActionState();
            renderLogEntries();
        }

        function updateLogStatsDisplay() {
            const fastingStats = document.querySelectorAll('.log-stat-fasting');
            const bodyStats = document.querySelectorAll('.log-stat-body');
            const logStatsContainer = document.querySelector('.log-stats');

            if (currentLogFilter === 'body') {
                fastingStats.forEach(stat => stat.style.display = 'none');
                bodyStats.forEach(stat => stat.style.display = 'flex');
                if (logStatsContainer) {
                    logStatsContainer.style.display = 'flex';
                    logStatsContainer.style.flexWrap = 'nowrap';
                }
                updateBodyStats();
            } else if (currentLogFilter === 'all') {
                fastingStats.forEach(stat => stat.style.display = 'flex');
                bodyStats.forEach(stat => stat.style.display = 'flex');
                if (logStatsContainer) {
                    logStatsContainer.style.display = 'grid';
                    logStatsContainer.style.gridTemplateColumns = 'repeat(3, 1fr)';
                }
                updateStats();
                updateBodyStats();
            } else {
                fastingStats.forEach(stat => stat.style.display = 'flex');
                bodyStats.forEach(stat => stat.style.display = 'none');
                if (logStatsContainer) {
                    logStatsContainer.style.display = 'flex';
                    logStatsContainer.style.flexWrap = 'nowrap';
                }
                updateStats();
            }
        }

        function updateLogActionState() {
            const label = document.getElementById('log-action-label');
            const chevron = document.getElementById('log-action-chevron');
            const menu = document.getElementById('log-action-menu');

            if (!label || !chevron || !menu) {
                return;
            }

            if (currentLogFilter === 'body') {
                label.textContent = 'Add Body Entry';
                chevron.classList.add('hidden');
                closeLogActionMenu();
            } else if (currentLogFilter === 'all') {
                label.textContent = 'Add Fast';
                chevron.classList.remove('hidden');
                closeLogActionMenu();
            } else {
                label.textContent = 'Add Fast';
                chevron.classList.add('hidden');
                closeLogActionMenu();
            }
        }

        function formatWeight(value) {
            if (value === null || value === undefined || Number.isNaN(value)) {
                return '—';
            }
            return `${Number(value).toFixed(1)} lb`;
        }

        function formatDelta(value) {
            if (value === null || value === undefined || Number.isNaN(value)) {
                return '—';
            }
            const numeric = Number(value);
            if (Math.abs(numeric) < 0.05) {
                return '0.0 lb';
            }
            const sign = numeric > 0 ? '+' : '';
            return `${sign}${numeric.toFixed(1)} lb`;
        }

        function formatPercent(value, decimals = 0) {
            if (value === null || value === undefined || Number.isNaN(value)) {
                return '—';
            }
            return `${Number(value).toFixed(decimals)}%`;
        }

        function formatPercentDelta(value) {
            if (value === null || value === undefined || Number.isNaN(value)) {
                return '—';
            }
            const numeric = Number(value);
            if (Math.abs(numeric) < 0.05) {
                return '0.0%';
            }
            const sign = numeric > 0 ? '+' : '';
            return `${sign}${numeric.toFixed(1)}%`;
        }

        function formatShortDate(value) {
            const date = value instanceof Date ? value : (value ? new Date(value) : null);
            if (!date || Number.isNaN(date.getTime())) {
                return '';
            }
            return date.toLocaleDateString(undefined, { month: 'numeric', day: 'numeric' });
        }

        function formatShortDateTime(value) {
            const date = value instanceof Date ? value : (value ? new Date(value) : null);
            if (!date || Number.isNaN(date.getTime())) {
                return '';
            }
            return date.toLocaleString(undefined, { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
        }

        function formatWeekLabel(isoDate) {
            if (!isoDate) {
                return '';
            }
            const date = new Date(`${isoDate}T00:00:00Z`);
            if (Number.isNaN(date.getTime())) {
                return isoDate;
            }
            return date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
        }

        function handlePrimaryLogAction() {
            if (currentLogFilter === 'all') {
                toggleLogActionMenu();
                return;
            }

            if (currentLogFilter === 'body') {
                showBodyEntryModal({ mode: 'create' });
            } else {
                showAddFastModal();
            }
        }

        function handleLogMenuSelection(action) {
            closeLogActionMenu();

            if (action === 'add-fast') {
                showAddFastModal();
            } else if (action === 'add-body-entry') {
                showBodyEntryModal({ mode: 'create' });
            }
        }

        function toggleLogActionMenu() {
            if (logActionMenuOpen) {
                closeLogActionMenu();
            } else {
                openLogActionMenu();
            }
        }

        function openLogActionMenu() {
            const menu = document.getElementById('log-action-menu');
            if (!menu) {
                return;
            }
            menu.classList.remove('hidden');
            logActionMenuOpen = true;
        }

        function closeLogActionMenu() {
            const menu = document.getElementById('log-action-menu');
            if (!menu) {
                return;
            }
            if (!menu.classList.contains('hidden')) {
                menu.classList.add('hidden');
            }
            logActionMenuOpen = false;
        }

        function handleDocumentClickForLogActionMenu(event) {
            if (!logActionMenuOpen) {
                return;
            }

            const actionButton = document.getElementById('log-primary-action');
            const menu = document.getElementById('log-action-menu');

            const clickedInsideButton = actionButton && actionButton.contains(event.target);
            const clickedInsideMenu = menu && menu.contains(event.target);

            if (!clickedInsideButton && !clickedInsideMenu) {
                closeLogActionMenu();
            }
        }

        function handleLogListClick(event) {
            // Handle kebab menu toggle
            const kebabButton = event.target.closest('.card-kebab-button');
            if (kebabButton) {
                event.preventDefault();
                event.stopPropagation();
                toggleKebabMenu(kebabButton);
                return;
            }

            // Handle card actions (from kebab menu or other buttons)
            const cardActionElement = event.target.closest('[data-card-action]');
            if (cardActionElement) {
                const action = cardActionElement.getAttribute('data-card-action');
                const entryId = cardActionElement.getAttribute('data-entry-id');
                const fastId = cardActionElement.getAttribute('data-fast-id');

                event.preventDefault();

                // Close any open kebab menus
                closeAllKebabMenus();

                switch (action) {
                    case 'edit-fast':
                        if (fastId) {
                            editFast(Number(fastId));
                        }
                        break;
                    case 'delete-fast':
                        if (fastId) {
                            deleteFast(Number(fastId));
                        }
                        break;
                    case 'set-body-canonical':
                        if (entryId) {
                            setBodyEntryCanonical(Number(entryId));
                        }
                        break;
                    case 'clear-body-canonical':
                        if (entryId) {
                            clearBodyEntryCanonical(Number(entryId));
                        }
                        break;
                    case 'edit-body-entry':
                        if (entryId) {
                            showBodyEntryModal({ mode: 'edit', entryId: Number(entryId) });
                        }
                        break;
                    case 'delete-body-entry':
                        if (entryId) {
                            confirmDeleteBodyEntry(Number(entryId));
                        }
                        break;
                    default:
                        break;
                }
                return;
            }

            // Handle legacy data-log-action for backwards compatibility
            const actionElement = event.target.closest('[data-log-action]');
            if (!actionElement) {
                return;
            }

            const action = actionElement.getAttribute('data-log-action');
            const entryId = actionElement.getAttribute('data-entry-id');
            const bodyDay = actionElement.getAttribute('data-body-day');
            const fastId = actionElement.getAttribute('data-fast-id');

            event.preventDefault();

            switch (action) {
                case 'toggle-body-day':
                    if (bodyDay) {
                        toggleBodyDay(bodyDay);
                    }
                    break;
                case 'set-body-canonical':
                    if (entryId) {
                        setBodyEntryCanonical(Number(entryId));
                    }
                    break;
                case 'clear-body-canonical':
                    if (entryId) {
                        clearBodyEntryCanonical(Number(entryId));
                    }
                    break;
                case 'edit-body-entry':
                    if (entryId) {
                        showBodyEntryModal({ mode: 'edit', entryId: Number(entryId) });
                    }
                    break;
                case 'delete-body-entry':
                    if (entryId) {
                        confirmDeleteBodyEntry(Number(entryId));
                    }
                    break;
                case 'edit-fast':
                    if (fastId) {
                        editFast(Number(fastId));
                    }
                    break;
                default:
                    break;
            }
        }

        function toggleKebabMenu(button) {
            const kebab = button.closest('.card-kebab');
            if (!kebab) {
                return;
            }

            const isActive = kebab.classList.contains('active');

            // Close all other kebab menus first
            closeAllKebabMenus();

            // Toggle this one
            if (!isActive) {
                kebab.classList.add('active');
            }
        }

        function closeAllKebabMenus() {
            document.querySelectorAll('.card-kebab.active').forEach(kebab => {
                kebab.classList.remove('active');
            });
        }

        // Add global click handler to close kebab menus when clicking outside
        document.addEventListener('click', (event) => {
            if (!event.target.closest('.card-kebab')) {
                closeAllKebabMenus();
            }
        });

        function toggleBodyDay(dateKey) {
            if (expandedBodyDates.has(dateKey)) {
                expandedBodyDates.delete(dateKey);
            } else {
                expandedBodyDates.add(dateKey);
            }
            renderLogEntries();
        }

        async function setBodyEntryCanonical(entryId) {
            if (!entryId) {
                return;
            }
            try {
                pendingScrollTarget = entryId;
                await bodyLogApi.setCanonical(entryId);
                await loadBodyLogEntries();
            } catch (error) {
                console.error('Failed to set canonical body entry:', error);
                alert(error.payload?.error || 'Failed to set canonical entry.');
            }
        }

        async function clearBodyEntryCanonical(entryId) {
            if (!entryId) {
                return;
            }
            try {
                pendingScrollTarget = entryId;
                await bodyLogApi.clearCanonical(entryId);
                await loadBodyLogEntries();
            } catch (error) {
                console.error('Failed to clear canonical body entry:', error);
                alert(error.payload?.error || 'Failed to clear canonical entry.');
            }
        }

        async function confirmDeleteBodyEntry(entryId) {
            if (!entryId) {
                return;
            }
            const confirmed = window.confirm('Delete this body entry? This action cannot be undone.');
            if (!confirmed) {
                return;
            }
            try {
                await bodyLogApi.deleteEntry(entryId);
                await loadBodyLogEntries();
            } catch (error) {
                console.error('Failed to delete body entry:', error);
                alert(error.payload?.error || 'Failed to delete body entry.');
            }
        }

        function calculateCurrentStreak(fasts) {
            if (!fasts || fasts.length === 0) {
                return 0;
            }
            
            // Sort fasts by end time (most recent first)
            const sortedFasts = fasts
                .filter(fast => fast.end_time) // Only completed fasts
                .sort((a, b) => new Date(b.end_time) - new Date(a.end_time));
            
            if (sortedFasts.length === 0) {
                return 0;
            }
            
            let streak = 0;
            const now = new Date();
            const oneDayMs = 24 * 60 * 60 * 1000;
            
            for (let i = 0; i < sortedFasts.length; i++) {
                const fastEndTime = new Date(sortedFasts[i].end_time);
                
                if (i === 0) {
                    // For the first (most recent) fast, check if it's within the last 7 days
                    const timeSinceLastFast = now - fastEndTime;
                    if (timeSinceLastFast > 7 * oneDayMs) {
                        break; // Too long since last fast, streak is 0
                    }
                    streak = 1;
                } else {
                    // Check if this fast is within a reasonable timeframe of the previous one
                    const prevFastEndTime = new Date(sortedFasts[i - 1].end_time);
                    const timeBetweenFasts = prevFastEndTime - fastEndTime;
                    
                    // Allow up to 7 days between fasts to maintain streak
                    if (timeBetweenFasts <= 7 * oneDayMs) {
                        streak++;
                    } else {
                        break; // Gap too large, end of streak
                    }
                }
            }
            
            return streak;
        }

        async function loadBodyLogEntries(options = {}) {
            bodyEntriesLoaded = false;
            renderLogEntries();

            try {
                bodyLogEntries = await bodyLogApi.listEntries(options);
                if (bodyLogEntries.length && expandedBodyDates.size === 0) {
                    const first = bodyLogEntries[0];
                    const dateKey = getBodyEntryDateKey(first);
                    if (dateKey) {
                        expandedBodyDates.add(dateKey);
                    }
                }
                bodyEntriesLoaded = true;
                renderLogEntries();
            } catch (error) {
                console.error('Error loading body log entries:', error);
                bodyLogEntries = [];
                bodyEntriesLoaded = true;
                renderLogEntries();
            }
        }

        function updateStats() {
            const totalFasts = fasts.length;
            const totalHours = fasts.reduce((sum, fast) => {
                let duration = fast.duration_hours;

                // Calculate duration if not stored in database
                if (!duration && fast.start_time && fast.end_time) {
                    const startTime = new Date(fast.start_time);
                    const endTime = new Date(fast.end_time);
                    duration = (endTime - startTime) / (1000 * 60 * 60); // Convert to hours
                }

                return sum + (duration || 0);
            }, 0);

            // Calculate current streak
            const currentStreak = calculateCurrentStreak(fasts);

            document.getElementById('total-fasts').textContent = totalFasts;
            document.getElementById('total-hours').textContent = Math.round(totalHours) + 'h';
            document.getElementById('current-streak').textContent = currentStreak;
        }

        function updateBodyStats() {
            const weightDeltaEl = document.getElementById('weight-delta');
            const bodyFatDeltaEl = document.getElementById('body-fat-delta');
            const weightPercentChangeEl = document.getElementById('weight-percent-change');

            // Default values
            weightDeltaEl.textContent = '—';
            bodyFatDeltaEl.textContent = '—';
            weightPercentChangeEl.textContent = '—';

            if (!bodyAnalytics || !Array.isArray(bodyAnalytics.canonicalEntries) || bodyAnalytics.canonicalEntries.length < 2) {
                return;
            }

            const entries = bodyAnalytics.canonicalEntries
                .filter(entry => entry && entry.weight !== null && entry.loggedAt)
                .sort((a, b) => new Date(a.loggedAt) - new Date(b.loggedAt));

            if (entries.length < 2) {
                return;
            }

            const firstEntry = entries[0];
            const lastEntry = entries[entries.length - 1];

            // Weight delta
            const weightDelta = lastEntry.weight - firstEntry.weight;
            const weightDeltaStr = weightDelta >= 0 ? `+${weightDelta.toFixed(1)}` : weightDelta.toFixed(1);
            weightDeltaEl.textContent = `${weightDeltaStr} lbs`;

            // Body fat delta
            if (firstEntry.bodyFat !== null && firstEntry.bodyFat !== undefined &&
                lastEntry.bodyFat !== null && lastEntry.bodyFat !== undefined) {
                const bodyFatDelta = lastEntry.bodyFat - firstEntry.bodyFat;
                const bodyFatDeltaStr = bodyFatDelta >= 0 ? `+${bodyFatDelta.toFixed(1)}` : bodyFatDelta.toFixed(1);
                bodyFatDeltaEl.textContent = `${bodyFatDeltaStr}%`;
            }

            // Weight percent change
            const weightPercentChange = ((lastEntry.weight - firstEntry.weight) / firstEntry.weight) * 100;
            const weightPercentChangeStr = weightPercentChange >= 0 ? `+${weightPercentChange.toFixed(1)}` : weightPercentChange.toFixed(1);
            weightPercentChangeEl.textContent = `${weightPercentChangeStr}%`;
        }
        
        function showAddFastModal() {
            document.getElementById('add-fast-modal').classList.add('active');
        }

        function hideAddFastModal() {
            document.getElementById('add-fast-modal').classList.remove('active');
            document.getElementById('add-fast-form').reset();
        }

        function showBodyEntryModal({ mode = 'create', entryId = null, fastId = null } = {}) {
            const modal = document.getElementById('body-entry-modal');
            if (!modal) {
                return;
            }

            bodyEntryModalMode = mode;
            bodyEntryEditingId = entryId;

            const titleEl = document.getElementById('body-entry-modal-title');
            const submitBtn = document.getElementById('body-entry-submit-btn');
            const deleteBtn = document.getElementById('body-entry-delete-btn');
            const canonicalCheckbox = document.getElementById('body-entry-make-canonical');

            resetBodyEntryForm();

            if (mode === 'edit' && entryId) {
                const entry = bodyLogEntries.find((item) => item.id === entryId);
                if (!entry) {
                    alert('Body entry not found.');
                    return;
                }

                if (titleEl) {
                    titleEl.textContent = 'Edit Body Entry';
                }
                if (submitBtn) {
                    submitBtn.textContent = 'Save Changes';
                }
                if (deleteBtn) {
                    deleteBtn.style.display = 'inline-flex';
                }

                populateBodyEntryForm(entry);

                if (canonicalCheckbox) {
                    canonicalCheckbox.checked = entry.isCanonical && entry.canonicalStatus === 'manual';
                }

                const dateKey = getBodyEntryDateKey(entry);
                if (dateKey) {
                    expandedBodyDates.add(dateKey);
                }
            } else {
                if (titleEl) {
                    titleEl.textContent = 'Add Body Entry';
                }
                if (submitBtn) {
                    submitBtn.textContent = 'Save Entry';
                }
                if (deleteBtn) {
                    deleteBtn.style.display = 'none';
                }
                if (fastId) {
                    const fastField = document.getElementById('body-entry-fast-id');
                    if (fastField) {
                        fastField.value = fastId;
                    }
                }
                if (canonicalCheckbox) {
                    canonicalCheckbox.checked = false;
                }
            }

            modal.classList.add('active');
        }

        function hideBodyEntryModal() {
            const modal = document.getElementById('body-entry-modal');
            if (modal) {
                modal.classList.remove('active');
            }
            resetBodyEntryForm();
            bodyEntryModalMode = 'create';
            bodyEntryEditingId = null;
        }

        function resetBodyEntryForm() {
            const form = document.getElementById('body-entry-form');
            if (!form) {
                return;
            }

            form.reset();

            const now = new Date();
            const dateField = document.getElementById('body-entry-date');
            const timeField = document.getElementById('body-entry-time');
            if (dateField) {
                dateField.value = now.toISOString().slice(0, 10);
            }
            if (timeField) {
                timeField.value = now.toTimeString().slice(0, 5);
            }

            const deleteBtn = document.getElementById('body-entry-delete-btn');
            if (deleteBtn) {
                deleteBtn.style.display = 'none';
            }

            const fastField = document.getElementById('body-entry-fast-id');
            if (fastField) {
                fastField.value = '';
            }

            const canonicalCheckbox = document.getElementById('body-entry-make-canonical');
            if (canonicalCheckbox) {
                canonicalCheckbox.checked = false;
            }
        }

        function populateBodyEntryForm(entry) {
            const dateField = document.getElementById('body-entry-date');
            const timeField = document.getElementById('body-entry-time');
            const weightField = document.getElementById('body-entry-weight');
            const bodyFatField = document.getElementById('body-entry-bodyfat');
            const notesField = document.getElementById('body-entry-notes');
            const fastField = document.getElementById('body-entry-fast-id');

            const localDateTime = getEntryLocalDateTime(entry) || new Date(entry.loggedAt);

            if (dateField && localDateTime) {
                dateField.value = localDateTime.toISOString().slice(0, 10);
            }
            if (timeField && localDateTime) {
                timeField.value = localDateTime.toTimeString().slice(0, 5);
            }
            if (weightField) {
                weightField.value = entry.weight ?? '';
            }
            if (bodyFatField) {
                bodyFatField.value = entry.bodyFat ?? '';
            }
            if (notesField) {
                notesField.value = entry.notes ?? '';
            }
            if (fastField) {
                fastField.value = entry.fastId ?? '';
            }
        }

        async function submitBodyEntry(event) {
            event.preventDefault();

            const form = event.target;
            const formData = new FormData(form);

            const date = formData.get('entry-date');
            const time = formData.get('entry-time');
            const weight = formData.get('weight');
            const bodyFat = formData.get('body-fat');
            const notes = formData.get('notes');
            const fastId = formData.get('fast-id');
            const makeCanonical = formData.get('make-canonical') === 'on';

            if (!date || !time) {
                alert('Please provide a date and time for the entry.');
                return;
            }

            let isoResult;
            try {
                isoResult = buildIsoWithOffset(date, time);
            } catch (error) {
                console.error('Invalid date/time provided for body entry:', error);
                alert('Invalid date or time provided.');
                return;
            }

            const weightValue = weight !== '' && weight !== null ? Number(weight) : null;
            if (weightValue === null || Number.isNaN(weightValue)) {
                alert('Please provide a valid weight value.');
                return;
            }

            const bodyFatValue = bodyFat !== '' && bodyFat !== null ? Number(bodyFat) : null;
            if (bodyFatValue !== null && Number.isNaN(bodyFatValue)) {
                alert('Please provide a valid body fat percentage.');
                return;
            }

            const payload = {
                loggedAt: isoResult.isoString,
                timezoneOffsetMinutes: isoResult.timezoneOffsetMinutes,
                weight: weightValue,
                bodyFat: bodyFatValue,
                notes: notes && notes.trim() ? notes.trim() : null
            };

            if (fastId) {
                payload.fastId = Number(fastId);
            }

            try {
                if (bodyEntryModalMode === 'edit' && bodyEntryEditingId) {
                    await bodyLogApi.updateEntry(bodyEntryEditingId, payload);
                    if (makeCanonical) {
                        await bodyLogApi.setCanonical(bodyEntryEditingId);
                    }
                } else {
                    payload.makeCanonical = makeCanonical;
                    const createdEntry = await bodyLogApi.createEntry(payload);
                    if (createdEntry && createdEntry.id) {
                        pendingScrollTarget = createdEntry.id;
                        const dateKey = getBodyEntryDateKey(createdEntry);
                        if (dateKey) {
                            expandedBodyDates.add(dateKey);
                        }
                    }
                }

                await loadBodyLogEntries();
                await loadBodyAnalytics();
                hideBodyEntryModal();
            } catch (error) {
                console.error('Failed to save body entry:', error);
                alert(error.payload?.error || 'Failed to save body entry.');
            }
        }

        async function deleteBodyEntryFromModal() {
            if (!bodyEntryEditingId) {
                return;
            }

            const confirmed = window.confirm('Delete this body entry? This action cannot be undone.');
            if (!confirmed) {
                return;
            }

            try {
                await bodyLogApi.deleteEntry(bodyEntryEditingId);
                await loadBodyLogEntries();
                await loadBodyAnalytics();
                hideBodyEntryModal();
            } catch (error) {
                console.error('Failed to delete body entry:', error);
                alert(error.payload?.error || 'Failed to delete body entry.');
            }
        }

        function buildIsoWithOffset(dateStr, timeStr) {
            const normalizedTime = timeStr.length === 5 ? `${timeStr}:00` : timeStr;
            const localDate = new Date(`${dateStr}T${normalizedTime}`);

            if (Number.isNaN(localDate.getTime())) {
                throw new Error('Invalid date/time');
            }

            const offsetMinutes = -localDate.getTimezoneOffset();
            const absoluteOffset = Math.abs(localDate.getTimezoneOffset());
            const offsetHoursPart = String(Math.floor(absoluteOffset / 60)).padStart(2, '0');
            const offsetMinutesPart = String(absoluteOffset % 60).padStart(2, '0');
            const sign = localDate.getTimezoneOffset() <= 0 ? '+' : '-';

            const isoString = `${dateStr}T${normalizedTime}${sign}${offsetHoursPart}:${offsetMinutesPart}`;

            return {
                isoString,
                timezoneOffsetMinutes: offsetMinutes
            };
        }

        
        async function submitAddFast(event) {
            event.preventDefault();

            const formData = new FormData(event.target);
            const startDate = formData.get('start-date');
            const startTime = formData.get('start-time');
            const endDate = formData.get('end-date');
            const endTime = formData.get('end-time');
            const notes = formData.get('notes');
            const startWeight = formData.get('start-weight');
            const startBodyFat = formData.get('start-body-fat');
            const endWeight = formData.get('end-weight');
            const endBodyFat = formData.get('end-body-fat');

            // Combine date and time inputs
            const startDateTime = new Date(`${startDate}T${startTime}`).toISOString();
            const endDateTime = endDate && endTime ? new Date(`${endDate}T${endTime}`).toISOString() : null;

            // Validate that end time is after start time if both are provided
            if (endDateTime) {
                const startTime = new Date(startDateTime);
                const endTime = new Date(endDateTime);

                if (endTime <= startTime) {
                    alert('Fast end time must be after the start time. Please check your dates and times.');
                    return;
                }
            }

            // Get session ID for linking to user profile
            const sessionId = window.getSessionId();

            // Get timezone offset in minutes
            const timezoneOffsetMinutes = -new Date().getTimezoneOffset();

            // Get optional context fields
            const startInKetosis = document.getElementById('add-start-in-ketosis')?.checked || false;
            const preFastProtein = formData.get('pre-fast-protein');
            const carbStatus = formData.get('carb-status') || 'normal';

            const fastData = {
                start_time: startDateTime,
                end_time: endDateTime,
                notes: notes || null,
                start_weight: startWeight ? parseFloat(startWeight) : null,
                start_body_fat: startBodyFat ? parseFloat(startBodyFat) : null,
                end_weight: endWeight ? parseFloat(endWeight) : null,
                end_body_fat: endBodyFat ? parseFloat(endBodyFat) : null,
                timezone_offset_minutes: timezoneOffsetMinutes,
                is_manual: true,
                sessionId: sessionId,
                start_in_ketosis: startInKetosis,
                pre_fast_protein_grams: preFastProtein ? parseFloat(preFastProtein) : null,
                carb_status: carbStatus
            };
            
            try {
                const response = await fetch('/api/fasts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(fastData)
                });
                
                if (response.ok) {
                    hideAddFastModal();
                    loadFasts(); // Reload the fasts list
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error}`);
                }
            } catch (error) {
                console.error('Error adding fast:', error);
                alert('Failed to add fast. Please try again.');
            }
        }
        
        let editingFastId = null;
        
        async function editFast(fastId) {
            editingFastId = fastId;

            try {
                const sessionId = window.getSessionId();
                if (!sessionId) {
                    alert('Session error. Please refresh the page.');
                    return;
                }

                const response = await fetch(`/api/fasts/${fastId}?sessionId=${sessionId}`);
                if (response.ok) {
                    const fast = await response.json();
                    populateEditModal(fast);
                    document.getElementById('edit-fast-modal').classList.add('active');
                } else {
                    console.error('Failed to load fast data:', response.status);
                    alert('Error loading fast data');
                }
            } catch (error) {
                console.error('Error loading fast:', error);
                alert('Failed to load fast data');
            }
        }
        
        function populateEditModal(fast) {
            const startDate = new Date(fast.start_time);
            const endDate = fast.end_time ? new Date(fast.end_time) : null;

            // Format dates for inputs
            const formatDateForInput = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            const formatTimeForInput = (date) => {
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${hours}:${minutes}`;
            };

            document.getElementById('edit-start-date').value = formatDateForInput(startDate);
            document.getElementById('edit-start-time').value = formatTimeForInput(startDate);

            if (endDate) {
                document.getElementById('edit-end-date').value = formatDateForInput(endDate);
                document.getElementById('edit-end-time').value = formatTimeForInput(endDate);
            } else {
                document.getElementById('edit-end-date').value = '';
                document.getElementById('edit-end-time').value = '';
            }

            document.getElementById('edit-notes').value = fast.notes || '';
            document.getElementById('edit-start-weight').value = fast.start_weight || '';
            document.getElementById('edit-start-body-fat').value = fast.start_body_fat || '';
            document.getElementById('edit-end-weight').value = fast.end_weight || '';
            document.getElementById('edit-end-body-fat').value = fast.end_body_fat || '';

            // Populate optional context fields
            document.getElementById('edit-start-in-ketosis').checked = fast.start_in_ketosis || false;
            document.getElementById('edit-pre-fast-protein').value = fast.pre_fast_protein_grams || '';
            document.getElementById('edit-carb-status').value = fast.carb_status || 'normal';
        }
        
        function hideEditFastModal() {
            document.getElementById('edit-fast-modal').classList.remove('active');
            document.getElementById('edit-fast-form').reset();
            editingFastId = null;
        }
        
        async function submitEditFast(event) {
            event.preventDefault();

            if (!editingFastId) return;

            const formData = new FormData(event.target);
            const startDate = formData.get('start-date');
            const startTime = formData.get('start-time');
            const endDate = formData.get('end-date');
            const endTime = formData.get('end-time');
            const notes = formData.get('notes');
            const startWeight = formData.get('start-weight');
            const startBodyFat = formData.get('start-body-fat');
            const endWeight = formData.get('end-weight');
            const endBodyFat = formData.get('end-body-fat');

            // Combine date and time inputs
            const startDateTime = new Date(`${startDate}T${startTime}`).toISOString();
            const endDateTime = endDate && endTime ? new Date(`${endDate}T${endTime}`).toISOString() : null;

            // Validate that end time is after start time if both are provided
            if (endDateTime) {
                const startTime = new Date(startDateTime);
                const endTime = new Date(endDateTime);

                if (endTime <= startTime) {
                    alert('Fast end time must be after the start time. Please check your dates and times.');
                    return;
                }
            }

            const sessionId = window.getSessionId();
            if (!sessionId) {
                alert('Session error. Please refresh the page.');
                return;
            }

            // Get timezone offset in minutes
            const timezoneOffsetMinutes = -new Date().getTimezoneOffset();

            // Get optional context fields
            const startInKetosis = document.getElementById('edit-start-in-ketosis')?.checked || false;
            const preFastProtein = formData.get('pre-fast-protein');
            const carbStatus = formData.get('carb-status') || 'normal';

            const fastData = {
                start_time: startDateTime,
                end_time: endDateTime,
                notes: notes || null,
                start_weight: startWeight ? parseFloat(startWeight) : null,
                start_body_fat: startBodyFat ? parseFloat(startBodyFat) : null,
                end_weight: endWeight ? parseFloat(endWeight) : null,
                end_body_fat: endBodyFat ? parseFloat(endBodyFat) : null,
                timezone_offset_minutes: timezoneOffsetMinutes,
                start_in_ketosis: startInKetosis,
                pre_fast_protein_grams: preFastProtein ? parseFloat(preFastProtein) : null,
                carb_status: carbStatus
            };

            try {
                const response = await fetch(`/api/fasts/${editingFastId}?sessionId=${sessionId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(fastData)
                });
                
                if (response.ok) {
                    // Check if this is the currently active fast and update timer localStorage
                    const timerState = localStorage.getItem('fastingForecast_timerState');
                    if (timerState) {
                        try {
                            const parsedState = JSON.parse(timerState);
                            if (parsedState.currentFastId === editingFastId) {
                                // Update timer state with new start time
                                parsedState.fastStartTime = startDateTime;
                                localStorage.setItem('fastingForecast_timerState', JSON.stringify(parsedState));
                                console.log('Updated timer localStorage with new start time');
                            }
                        } catch (error) {
                            console.error('Error updating timer localStorage:', error);
                        }
                    }

                    hideEditFastModal();
                    loadFasts(); // Reload the fasts list

                    // If this was an active fast, refresh the active fast display immediately
                    // (but only if there was an active fast shown before)
                    const activeFastSection = document.getElementById('activeFastSection');
                    if (activeFastSection && !activeFastSection.classList.contains('hidden')) {
                        // Just update the specific duration display without full reinitialization
                        setTimeout(async () => {
                            try {
                                const activeFast = await getActiveFast();
                                if (activeFast) {
                                    const fastDuration = document.getElementById('activeFastDuration');
                                    if (fastDuration) {
                                        const startTime = new Date(activeFast.start_time);
                                        const now = new Date();
                                        const elapsedMs = now - startTime;
                                        const duration = formatDuration(elapsedMs);
                                        fastDuration.textContent = duration;
                                    }
                                }
                            } catch (error) {
                                console.error('Error refreshing active fast after edit:', error);
                            }
                        }, 1000); // Wait 1 second for the database update to complete
                    }
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error}`);
                }
            } catch (error) {
                console.error('Error updating fast:', error);
                alert('Failed to update fast. Please try again.');
            }
        }
        
        async function deleteFast(fastId) {
            if (!confirm('Are you sure you want to delete this fast? This action cannot be undone.')) {
                return;
            }

            const sessionId = window.getSessionId();
            if (!sessionId) {
                alert('Session error. Please refresh the page.');
                return;
            }

            try {
                const response = await fetch(`/api/fasts/${fastId}?sessionId=${sessionId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete fast');
                }

                // Close modal if it's open (called from Edit Fast modal)
                hideEditFastModal();

                // Reload the data
                await loadFasts();
                renderLogEntries();
            } catch (error) {
                console.error('Error deleting fast:', error);
                alert(error.message || 'Failed to delete fast. Please try again.');
            }
        }
        
        // Bottom Navigation Functionality (copied from timer.html)
        function updateActiveNavItem() {
            const currentPath = window.location.pathname;
            const navItems = document.querySelectorAll('.nav-item');
            
            navItems.forEach(item => {
                item.classList.remove('active');
                const href = item.getAttribute('href');
                
                if (href === currentPath || (href === '/dashboard' && currentPath === '/dashboard')) {
                    item.classList.add('active');
                }
            });
        }
        
    </script>

    <!-- Session Management Scripts -->
    <script src="/js/modules/session-manager.js"></script>
    <script src="/js/modules/page-session-guard.js"></script>
    <script>
        // Initialize session management first
        try {
            const pageGuard = new window.FastingForecastPageSessionGuard();
            window.pageGuard = pageGuard; // Make it available globally for getSessionId()

            // Wait for session to be ready before continuing with page logic
            pageGuard.waitForReady().then(() => {
                console.log('✅ Session manager ready for dashboard.html');

                // Now that session is ready, initialize the dashboard page
                initializeDashboardPage();
            }).catch(error => {
                console.error('❌ Session waitForReady failed:', error);
            });
        } catch (error) {
            console.error('❌ PageSessionGuard creation failed:', error);
        }
    </script>
</body>
</html>
