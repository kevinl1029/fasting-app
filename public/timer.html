<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fasting Timer - Your Journey</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #fcd34d 0%, #fb923c 50%, #ec4899 100%);
            min-height: 100vh;
            padding-bottom: 85px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
        }
        
        .timer-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            min-height: 500px;
            max-height: calc(100vh - 140px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow-y: auto;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #28a745;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-indicator.fasting {
            background: #fb923c;
        }
        
        .status-indicator.feeding {
            background: #28a745;
        }
        
        .status-text {
            font-size: 1.1rem;
            font-weight: 600;
            color: #666;
            margin-bottom: 20px;
        }
        
        .circular-timer {
            width: min(280px, 70vw);
            height: min(280px, 70vw);
            margin: 30px auto 20px;
            position: relative;
            border-radius: 50%;
            background: #f0f0f0;
            box-shadow: 
                inset 8px 8px 16px rgba(163, 177, 198, 0.6),
                inset -8px -8px 16px rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: visible; /* Allow pulse to expand beyond container */
        }
        
        .timer-progress-outer {
            position: absolute;
            top: 50%;
            left: 50%;
            width: calc(min(280px, 70vw) - 20px);
            height: calc(min(280px, 70vw) - 20px);
            border-radius: 50%;
            background: conic-gradient(#ec4899 0deg, #f0f0f0 0deg);
            transition: all 0.3s ease;
            transform: translate(-50%, -50%);
        }
        
        .timer-progress-inner {
            position: absolute;
            top: 50%;
            left: 50%;
            width: calc(min(280px, 70vw) - 50px);
            height: calc(min(280px, 70vw) - 50px);
            border-radius: 50%;
            background: conic-gradient(#fb923c 0deg, #f8f9fa 0deg);
            transition: all 0.3s ease;
            transform: translate(-50%, -50%);
        }
        
        .timer-progress-minute {
            position: absolute;
            top: 50%;
            left: 50%;
            width: calc(min(280px, 70vw) - 80px);
            height: calc(min(280px, 70vw) - 80px);
            border-radius: 50%;
            background: conic-gradient(#fcd34d 0deg, #f8f9fa 0deg);
            transition: all 0.3s ease;
            opacity: 0;
            transform: translate(-50%, -50%);
        }
        
        .timer-progress-minute.visible {
            opacity: 1;
        }
        
        .radar-pulse {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border: 2px solid rgba(252, 211, 77, calc(var(--pulse-opacity, 0.8)));
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: radarPulse 1s ease-out infinite;
            z-index: 1;
            opacity: 0;
            pointer-events: none;
        }
        
        .radar-pulse.visible {
            opacity: 1;
        }
        
        /* Milestone Markers */
        .milestone-marker {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #fff;
            border: 3px solid #ddd;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 5;
            transform: translate(-50%, -50%);
        }
        
        .milestone-marker.reached {
            background: #28a745;
            border-color: #28a745;
            box-shadow: 0 0 8px rgba(40, 167, 69, 0.4);
        }
        
        .milestone-marker.current {
            background: #fb923c;
            border-color: #fb923c;
            box-shadow: 0 0 12px rgba(251, 146, 60, 0.6);
            animation: milestoneGlow 2s ease-in-out infinite;
        }
        
        .milestone-marker:hover {
            transform: translate(-50%, -50%) scale(1.3);
            box-shadow: 0 0 15px rgba(251, 146, 60, 0.8);
        }
        
        @keyframes milestoneGlow {
            0%, 100% { box-shadow: 0 0 12px rgba(251, 146, 60, 0.6); }
            50% { box-shadow: 0 0 20px rgba(251, 146, 60, 0.9); }
        }
        
        /* Milestone Tooltip */
        .milestone-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            white-space: normal;
            max-width: min(200px, 50vw);
            word-wrap: break-word;
            z-index: 10;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            pointer-events: none;
            left: 50%;
            transform: translateX(-50%) translateY(-10px);
        }
        
        .milestone-marker:hover .milestone-tooltip {
            opacity: 1;
            transform: translateX(-50%) translateY(-40px);
        }
        
        @keyframes radarPulse {
            0% {
                width: 0;
                height: 0;
                opacity: calc(var(--pulse-opacity, 0.8));
                border-width: 3px;
            }
            50% {
                opacity: calc(var(--pulse-opacity, 0.8) * 0.6);
                border-width: 2px;
            }
            100% {
                width: min(280px, 70vw);  /* Responsive to match timer size */
                height: min(280px, 70vw);
                opacity: 0;
                border-width: 1px;
            }
        }
        
        .timer-inner {
            position: absolute;
            top: 50%;
            left: 50%;
            width: calc(min(280px, 70vw) - 120px);
            height: calc(min(280px, 70vw) - 120px);
            border-radius: 50%;
            background: #f0f0f0;
            box-shadow: 
                8px 8px 16px rgba(163, 177, 198, 0.6),
                -8px -8px 16px rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 4;
            transform: translate(-50%, -50%);
        }
        
        .timer-display {
            font-size: 2.5rem;
            font-weight: 700;
            color: #333;
            font-family: 'Courier New', monospace;
            margin: 5px 0;
        }
        
        .timer-label {
            font-size: 0.9rem;
            color: #666;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .upcoming-fast-notice {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 51, 234, 0.1));
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 15px;
            padding: 15px 20px;
            margin: 20px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        
        .upcoming-fast-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .upcoming-text {
            flex: 1;
            color: #1e40af;
            font-size: 0.95rem;
            line-height: 1.4;
        }
        
        .upcoming-text strong {
            color: #1e3a8a;
            font-weight: 600;
        }
        
        .upcoming-text small {
            color: #64748b;
            font-size: 0.85rem;
        }
        
        .btn-start-early {
            background: linear-gradient(135deg, #3b82f6, #6366f1);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .btn-start-early:hover {
            background: linear-gradient(135deg, #2563eb, #4f46e5);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        /* Actionable upcoming fast - within 6 hours, Start Early available */
        .upcoming-fast-notice.actionable {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(147, 51, 234, 0.12));
            border: 1px solid rgba(59, 130, 246, 0.25);
            animation: subtle-glow 3s ease-in-out infinite alternate;
        }
        
        @keyframes subtle-glow {
            from { box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1); }
            to { box-shadow: 0 6px 20px rgba(59, 130, 246, 0.15); }
        }
        
        /* Informational upcoming fast - distant future, just awareness */
        .upcoming-fast-notice.informational {
            background: linear-gradient(135deg, rgba(107, 114, 128, 0.08), rgba(156, 163, 175, 0.08));
            border: 1px solid rgba(107, 114, 128, 0.15);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
        }
        
        .upcoming-fast-notice.informational .upcoming-text {
            color: #6b7280;
        }
        
        .upcoming-fast-notice.informational .upcoming-text strong {
            color: #4b5563;
        }
        
        .upcoming-fast-notice.informational .upcoming-text small {
            color: #9ca3af;
        }
        
        .phase-info {
            background: linear-gradient(135deg, rgba(251, 146, 60, 0.08), rgba(236, 72, 153, 0.08));
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 4px solid #fb923c;
        }
        
        .phase-title {
            color: #fb923c;
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
        
        .phase-description {
            color: #666;
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        .start-fast-btn {
            width: 100%;
            max-width: 300px;
            margin: 0 auto 30px;
            padding: 20px 40px;
            border: none;
            border-radius: 15px;
            font-size: 1.3rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #fcd34d 0%, #fb923c 50%, #ec4899 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(251, 146, 60, 0.4);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .start-fast-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(251, 146, 60, 0.5);
        }
        
        .control-buttons {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            justify-content: center;
        }
        
        .btn {
            flex: 1;
            padding: 15px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #fcd34d 0%, #fb923c 50%, #ec4899 100%);
            color: white;
        }
        
        .btn-secondary {
            background: transparent;
            border: 2px solid #fb923c;
            color: #fb923c;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(251, 146, 60, 0.4);
        }
        
        .scheduled-fast {
            background: linear-gradient(135deg, rgba(251, 146, 60, 0.08), rgba(236, 72, 153, 0.08));
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 4px solid #fb923c;
        }
        
        .scheduled-title {
            color: #fb923c;
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 10px;
        }
        
        .scheduled-info {
            color: #666;
            font-size: 0.95rem;
            line-height: 1.4;
        }
        
        .new-user-welcome {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.08), rgba(251, 146, 60, 0.08));
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 4px solid #28a745;
            text-align: center;
        }
        
        .welcome-title {
            color: #28a745;
            font-weight: 700;
            font-size: 1.3rem;
            margin-bottom: 12px;
        }
        
        .welcome-subtitle {
            color: #666;
            font-size: 1rem;
            line-height: 1.4;
            margin-bottom: 15px;
        }
        
        .welcome-hint {
            color: #999;
            font-size: 0.85rem;
            margin-top: 15px;
            font-style: italic;
        }
        
        .schedule-setup-state {
            background: linear-gradient(135deg, rgba(251, 146, 60, 0.08), rgba(236, 72, 153, 0.08));
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 4px solid #fb923c;
            text-align: center;
        }
        
        .schedule-title {
            color: #fb923c;
            font-weight: 700;
            font-size: 1.3rem;
            margin-bottom: 12px;
        }
        
        .schedule-subtitle {
            color: #666;
            font-size: 1rem;
            line-height: 1.4;
            margin-bottom: 15px;
        }
        
        .dual-button-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        
        .schedule-btn-primary {
            flex: 1;
            padding: 15px 20px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #fb923c 0%, #ec4899 100%);
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .schedule-btn-secondary {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #fb923c;
            border-radius: 10px;
            background: transparent;
            color: #fb923c;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .schedule-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(251, 146, 60, 0.3);
        }
        
        .schedule-btn-secondary:hover {
            transform: translateY(-2px);
            background: rgba(251, 146, 60, 0.05);
        }
        
        .time-display {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .time-item {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin: 12px 0;
            min-height: 24px;
        }
        
        .time-label {
            color: #666;
            font-weight: 500;
            font-size: 0.95rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .time-value {
            color: #333;
            font-weight: 600;
            font-size: 0.95rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            text-align: right;
            line-height: 1.2;
        }
        
        .time-value-container {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 8px;
        }
        
        .adjust-time-btn {
            background: transparent;
            border: 1px solid #ddd;
            color: #666;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s ease;
            opacity: 0.7;
        }
        
        .adjust-time-btn:hover {
            border-color: #fb923c;
            color: #fb923c;
            opacity: 1;
        }
        
        .time-adjustment-controls {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        .time-adjustment-controls input[type="time"],
        .time-adjustment-controls select {
            padding: 4px 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.8rem;
            font-family: inherit;
        }
        
        .time-adjustment-controls input[type="time"]:focus,
        .time-adjustment-controls select:focus {
            border-color: #fb923c;
            outline: none;
            box-shadow: 0 0 0 2px rgba(251, 146, 60, 0.1);
        }
        
        .apply-adjustment-btn,
        .cancel-adjustment-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .apply-adjustment-btn {
            background: #28a745;
            color: white;
        }
        
        .apply-adjustment-btn:hover {
            background: #218838;
        }
        
        .cancel-adjustment-btn {
            background: #6c757d;
            color: white;
        }
        
        .cancel-adjustment-btn:hover {
            background: #5a6268;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 25px 0;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }
        
        .welcome-message {
            text-align: center;
            color: white;
            padding: 20px 0;
            margin-bottom: 20px;
        }
        
        .welcome-message h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .welcome-message p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .customize-duration {
            text-align: center;
            margin: 15px 0;
        }
        
        .customize-btn {
            background: transparent;
            border: 1px solid #fb923c;
            color: #fb923c;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .customize-btn:hover {
            background: rgba(251, 146, 60, 0.1);
            transform: translateY(-1px);
        }
        
        .duration-selector {
            background: linear-gradient(135deg, rgba(251, 146, 60, 0.05), rgba(236, 72, 153, 0.05));
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            border: 1px solid rgba(251, 146, 60, 0.2);
            transition: all 0.3s ease;
        }
        
        .duration-presets h4 {
            color: #fb923c;
            font-size: 1.1rem;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .preset-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .preset-btn {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }
        
        .preset-btn:hover {
            border-color: #fb923c;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(251, 146, 60, 0.2);
        }
        
        .preset-btn.active {
            border-color: #fb923c;
            background: linear-gradient(135deg, rgba(251, 146, 60, 0.1), rgba(236, 72, 153, 0.1));
            box-shadow: 0 4px 12px rgba(251, 146, 60, 0.3);
        }
        
        .preset-btn .duration {
            display: block;
            font-weight: 700;
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 4px;
        }
        
        .preset-btn .description {
            display: block;
            font-size: 0.8rem;
            color: #666;
            line-height: 1.2;
        }
        
        .custom-duration {
            border-top: 1px solid rgba(251, 146, 60, 0.2);
            padding-top: 15px;
        }
        
        .custom-duration label {
            display: block;
            color: #fb923c;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .custom-input {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .custom-input input {
            width: 80px;
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            text-align: center;
        }
        
        .custom-input input:focus {
            border-color: #fb923c;
            outline: none;
            box-shadow: 0 0 0 3px rgba(251, 146, 60, 0.1);
        }
        
        .custom-input span {
            color: #666;
            font-weight: 500;
        }
        
        .apply-custom-btn {
            background: linear-gradient(135deg, #fcd34d 0%, #fb923c 50%, #ec4899 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .apply-custom-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(251, 146, 60, 0.4);
        }
        
        .start-time-section {
            border-top: 1px solid rgba(251, 146, 60, 0.2);
            padding-top: 15px;
            margin-top: 15px;
        }
        
        .start-time-section > label {
            display: block;
            color: #fb923c;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .start-time-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            color: #333;
            font-weight: 500;
        }
        
        .radio-option input[type="radio"] {
            margin: 0;
        }
        
        .time-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
            padding: 8px;
            background: rgba(251, 146, 60, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(251, 146, 60, 0.1);
        }
        
        .time-input-group input[type="time"] {
            padding: 6px 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 0.95rem;
            font-family: inherit;
        }
        
        .time-input-group input[type="time"]:focus {
            border-color: #fb923c;
            outline: none;
            box-shadow: 0 0 0 2px rgba(251, 146, 60, 0.1);
        }
        
        .time-input-group select {
            padding: 6px 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 0.95rem;
            background: white;
            cursor: pointer;
        }
        
        .time-input-group select:focus {
            border-color: #fb923c;
            outline: none;
            box-shadow: 0 0 0 2px rgba(251, 146, 60, 0.1);
        }

        /* Fast Completion State */
        .completion-state {
            text-align: center;
            animation: fadeInUp 0.6s ease;
        }
        
        .completion-header {
            margin-bottom: 30px;
        }
        
        .completion-header h2 {
            color: #28a745;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .completion-header .celebration {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .completion-summary {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.08), rgba(251, 146, 60, 0.08));
            border-radius: 20px;
            padding: 25px;
            margin: 25px 0;
            border: 2px solid #28a745;
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.15);
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .summary-stat {
            text-align: center;
        }
        
        .summary-stat .value {
            font-size: 2.2rem;
            font-weight: 700;
            color: #28a745;
            display: block;
            margin-bottom: 5px;
        }
        
        .summary-stat .label {
            font-size: 0.9rem;
            color: #666;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .milestones-achieved {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .milestones-achieved h4 {
            color: #28a745;
            font-size: 1.1rem;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .milestone-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .milestone-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }
        
        .milestone-item .icon {
            font-size: 1.3rem;
            width: 30px;
            text-align: center;
        }
        
        .milestone-item .info {
            flex: 1;
        }
        
        .milestone-item .title {
            font-weight: 600;
            color: #333;
            font-size: 0.95rem;
            margin-bottom: 2px;
        }
        
        .milestone-item .time {
            font-size: 0.8rem;
            color: #666;
        }
        
        .completion-actions {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 25px;
        }
        
        .refeed-notes-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 18px 30px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
        }
        
        .refeed-notes-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }
        
        .new-fast-btn {
            background: transparent;
            border: 2px solid #fb923c;
            color: #fb923c;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .new-fast-btn:hover {
            background: rgba(251, 146, 60, 0.1);
            transform: translateY(-1px);
        }
        
        /* Confetti Canvas */
        #confettiCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .timer-display {
                font-size: 2.5rem;
            }
            
            .control-buttons {
                flex-direction: column;
            }
            
            .preset-buttons {
                grid-template-columns: 1fr;
            }
            
            .summary-stats {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .completion-header h2 {
                font-size: 1.6rem;
            }
            
            .completion-header .celebration {
                font-size: 2.5rem;
            }
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(251, 146, 60, 0.2);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 8px 0 max(8px, env(safe-area-inset-bottom));
            z-index: 1000;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            color: #666;
            transition: all 0.3s ease;
            padding: 8px 12px;
            border-radius: 12px;
            min-width: 50px;
            position: relative;
        }
        
        .nav-item:hover {
            color: #fb923c;
            transform: translateY(-2px);
        }
        
        .nav-item.active {
            color: #fb923c;
            background: rgba(251, 146, 60, 0.1);
        }
        
        .nav-item.nav-primary {
            transform: scale(1.1);
            background: linear-gradient(135deg, #fcd34d 0%, #fb923c 50%, #ec4899 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(251, 146, 60, 0.3);
        }
        
        .nav-item.nav-primary:hover {
            transform: scale(1.15) translateY(-2px);
            box-shadow: 0 6px 20px rgba(251, 146, 60, 0.4);
            color: white;
        }
        
        .nav-item.nav-primary.active {
            color: white;
            background: linear-gradient(135deg, #fcd34d 0%, #fb923c 50%, #ec4899 100%);
        }
        
        .nav-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
            stroke-width: 2;
        }
        
        .nav-primary .nav-icon {
            width: 28px;
            height: 28px;
        }
        
        .nav-label {
            font-size: 10px;
            font-weight: 500;
            text-align: center;
            line-height: 1.2;
        }
        
        .nav-primary .nav-label {
            font-size: 11px;
            font-weight: 600;
        }
        
        
        @media (max-width: 768px) {
            .bottom-nav {
                padding: 6px 0 max(6px, env(safe-area-inset-bottom));
            }
            
            .nav-item {
                padding: 6px 8px;
            }
            
            .nav-icon {
                width: 20px;
                height: 20px;
                margin-bottom: 2px;
            }
            
            .nav-primary .nav-icon {
                width: 24px;
                height: 24px;
            }
            
            .nav-label {
                font-size: 9px;
            }
            
            .nav-primary .nav-label {
                font-size: 10px;
            }
            
            body {
                padding-bottom: 75px;
            }
            
            .timer-card {
                min-height: 450px;
                max-height: calc(100vh - 120px);
                padding: 20px;
            }
            
            .circular-timer {
                width: min(240px, 65vw);
                height: min(240px, 65vw);
                margin: 20px auto 15px;
            }
            
            html, body {
                overflow-x: hidden;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="welcome-message">
            <h1>Welcome back!</h1>
            <p>Ready for your next fasting session?</p>
        </div>
        
        <div class="timer-card">
            <!-- Pre-Fast State -->
            <div id="preFastState">
                <!-- New User Welcome State -->
                <div id="newUserWelcome" class="new-user-welcome" style="display: none;">
                    <div class="welcome-title">üéâ Welcome to Your Fasting Journey!</div>
                    <div class="welcome-subtitle">Ready to start your first fast?</div>
                </div>
                
                <!-- Schedule Setup State (for returning users) -->
                <div id="scheduleSetupState" class="schedule-setup-state" style="display: none;">
                    <div class="schedule-title">üìÖ Want to make fasting easier?</div>
                    <div class="schedule-subtitle">Set up a regular schedule to stay on track</div>
                    <button class="schedule-btn-secondary" onclick="showScheduleSetup()" style="margin-top: 15px;">Set My Schedule</button>
                </div>
                
                <!-- Scheduled Fast State -->
                <div id="scheduledFastInfo" class="scheduled-fast" style="display: none;">
                    <div class="scheduled-title">üóìÔ∏è Next Scheduled Fast</div>
                    <div class="scheduled-info">
                        <span id="scheduledFastDetails">Tomorrow at 8:00 PM ‚Ä¢ 24-hour fast</span><br>
                        <small style="opacity: 0.7;">Tap to modify schedule</small>
                    </div>
                </div>
                
                <button class="start-fast-btn" id="startFastBtn" onclick="startFast()">
                    Start Your First Fast
                </button>
                
                <div id="newUserHint" class="welcome-hint" style="display: none;">
                    Choose your duration below or start with 24 hours
                </div>
                
                
                <div class="customize-duration">
                    <button class="customize-btn" onclick="toggleDurationSelector()">
                        Customize Duration ‚öôÔ∏è
                    </button>
                </div>
                
                <div class="duration-selector" id="durationSelector" style="display: none;">
                    <div class="duration-presets">
                        <h4>Choose Duration</h4>
                        <div class="preset-buttons">
                            <button class="preset-btn active" data-hours="24" onclick="selectDuration(24)">
                                <span class="duration">24h</span>
                                <span class="description">Metabolic reset & fat burning</span>
                            </button>
                            <button class="preset-btn" data-hours="36" onclick="selectDuration(36)">
                                <span class="duration">36h</span>
                                <span class="description">Deep ketosis & mental clarity</span>
                            </button>
                            <button class="preset-btn" data-hours="48" onclick="selectDuration(48)">
                                <span class="duration">48h</span>
                                <span class="description">Peak autophagy & cellular renewal</span>
                            </button>
                            <button class="preset-btn" data-hours="72" onclick="selectDuration(72)">
                                <span class="duration">72h</span>
                                <span class="description">Extended therapeutic benefits</span>
                            </button>
                        </div>
                        
                        <div class="custom-duration">
                            <label for="customHours">Custom Duration:</label>
                            <div class="custom-input">
                                <input type="number" id="customHours" min="1" max="168" placeholder="24">
                                <span>hours</span>
                                <button class="apply-custom-btn" onclick="applyCustomDuration()">Apply</button>
                            </div>
                        </div>
                        
                        <div class="start-time-section">
                            <label>Start Time:</label>
                            <div class="start-time-options">
                                <label class="radio-option">
                                    <input type="radio" name="startTime" value="now" checked onchange="toggleStartTimeInputs()">
                                    <span>Start now</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="startTime" value="custom" onchange="toggleStartTimeInputs()">
                                    <span>Started at:</span>
                                </label>
                            </div>
                            <div class="time-input-group" id="timeInputGroup" style="display: none;">
                                <input type="time" id="startTimeInput" onchange="updateSelectedStartTime(); updateStartButtonText();">
                                <select id="startDateOffset" onchange="updateSelectedStartTime(); updateStartButtonText();">
                                    <option value="0">Today</option>
                                    <option value="1">Yesterday</option>
                                    <option value="2">2 days ago</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalFasts">3</div>
                        <div class="stat-label">Completed Fasts</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="longestFast">36h</div>
                        <div class="stat-label">Longest Fast</div>
                    </div>
                </div>
            </div>
            
            <!-- Active Fast State -->
            <div id="activeFastState" style="display: none;">
                <div class="status-text">
                    <span class="status-indicator fasting" id="statusIndicator"></span>
                    <span id="statusText">Fasting Active</span>
                </div>
                
                <div class="circular-timer">
                    <div class="timer-progress-outer" id="timerProgressOuter"></div>
                    <div class="timer-progress-inner" id="timerProgressInner"></div>
                    <div class="timer-progress-minute" id="timerProgressMinute"></div>
                    <div class="radar-pulse" id="radarPulse"></div>
                    
                    <!-- Milestone Markers -->
                    <div id="milestoneMarkers"></div>
                    
                    <div class="timer-inner">
                        <div class="timer-display" id="timerDisplay">12:30</div>
                        <div class="timer-label" id="timerLabel">ELAPSED</div>
                    </div>
                </div>
                
                <div class="time-display">
                    <div class="time-item">
                        <span class="time-label">Started</span>
                        <div class="time-value-container">
                            <span class="time-value" id="startTime">8:00 PM</span>
                            <button class="adjust-time-btn" id="adjustStartBtn" onclick="toggleStartTimeAdjustment()">
                                <small>adjust</small>
                            </button>
                        </div>
                    </div>
                    <div class="time-item" id="startTimeAdjustment" style="display: none;">
                        <div class="time-adjustment-controls">
                            <input type="time" id="adjustTimeInput">
                            <select id="adjustDateOffset">
                                <option value="0">Today</option>
                                <option value="1">Yesterday</option>
                                <option value="2">2 days ago</option>
                            </select>
                            <button class="apply-adjustment-btn" onclick="applyStartTimeAdjustment()">Apply</button>
                            <button class="cancel-adjustment-btn" onclick="cancelStartTimeAdjustment()">Cancel</button>
                        </div>
                    </div>
                    <div class="time-item">
                        <span class="time-label">Target End</span>
                        <span class="time-value" id="endTime">8:00 PM</span>
                    </div>
                </div>
                
                <div class="phase-info" id="phaseInfo">
                    <div class="phase-title" id="phaseTitle">Metabolic Shift</div>
                    <div class="phase-description" id="phaseDescription">
                        Your body is starting to switch from glucose to fat burning. Energy may fluctuate.
                    </div>
                </div>
                
                <div class="control-buttons">
                    <button class="btn btn-secondary" onclick="endFast()">
                        End Fast
                    </button>
                    <button class="btn btn-secondary" onclick="resetTimer()">
                        Reset
                    </button>
                </div>
            </div>
            
            <!-- Fast Completion State -->
            <div id="completionState" style="display: none;">
                <div class="completion-state">
                    <div class="completion-header">
                        <div class="celebration">üéâ</div>
                        <h2>Fast Complete!</h2>
                        <p style="color: #666; font-size: 1.1rem;">Congratulations on completing your fast!</p>
                    </div>
                    
                    <div class="completion-summary">
                        <div class="summary-stats">
                            <div class="summary-stat">
                                <span class="value" id="completionDuration">24:00</span>
                                <span class="label">Total Time</span>
                            </div>
                            <div class="summary-stat">
                                <span class="value" id="completionCalories">~1,800</span>
                                <span class="label">Est. Calories Burned</span>
                            </div>
                        </div>
                        
                        <div class="milestones-achieved">
                            <h4>üèÜ Milestones Achieved</h4>
                            <div class="milestone-list" id="completionMilestones">
                                <!-- Milestones will be populated here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="completion-actions">
                        <button class="refeed-notes-btn" onclick="openRefeedNotes()">
                            üìù Log Refeed Notes
                        </button>
                        <button class="new-fast-btn" onclick="startNewFast()">
                            Start New Fast
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Confetti Canvas -->
    <canvas id="confettiCanvas"></canvas>
    
    <script>
        // Timer state
        let isRunning = false;
        let fastStartTime = null;
        let elapsedTime = 0;
        let timerInterval = null;
        let fastDuration = 24; // Default 24-hour fast
        let selectedDuration = 24; // Selected duration for next fast
        let selectedStartTime = null; // Selected start time (null = start now)
        
        // Session management
        const sessionId = localStorage.getItem('fastingForecast_sessionId');
        let currentFastId = null;
        
        // Milestone definitions
        const milestones = [
            {
                hours: 12,
                title: "Glycogen Depletion Begins",
                message: "Your body is running low on stored glycogen and beginning to shift toward fat burning.",
                icon: "‚ö°"
            },
            {
                hours: 18,
                title: "Ketosis Transition",
                message: "Ketones are rising - you're switching to fat for fuel. Mental clarity often improves.",
                icon: "üî•"
            },
            {
                hours: 30,
                title: "Sustained Fat-Burning",
                message: "Fat is now your body's main energy source. You're in a deep metabolic state.",
                icon: "üí™"
            },
            {
                hours: 48,
                title: "Cellular Renewal (Autophagy)",
                message: "Your cells are recycling and repairing. Maximum therapeutic benefits activated.",
                icon: "‚ú®"
            }
        ];
        
        // Fasting phases with descriptions
        const phases = {
            0: {
                title: "Getting Started",
                description: "Your body is beginning to use stored glucose and transitioning away from constant feeding."
            },
            4: {
                title: "Early Adaptation", 
                description: "Blood sugar stabilizing. Initial hunger pangs are normal as your body adjusts."
            },
            8: {
                title: "Metabolic Shift",
                description: "Your body is starting to switch from glucose to fat burning. Energy may fluctuate."
            },
            12: {
                title: "Fat Burning Mode",
                description: "Ketone production increasing. You may start feeling more focused and energized."
            },
            16: {
                title: "Deep Ketosis",
                description: "Significant ketone production. Mental clarity improving, hunger often subsides."
            },
            24: {
                title: "Optimal Fat Burning",
                description: "Peak fat oxidation and ketone production. Maximum metabolic benefits activated."
            },
            36: {
                title: "Advanced Ketosis", 
                description: "Deep therapeutic ketosis. Enhanced autophagy and cellular repair processes."
            },
            48: {
                title: "Extended Benefits",
                description: "Maximum autophagy, growth hormone elevation, and metabolic optimization."
            }
        };
        
        // Create milestone markers on the outer ring
        function createMilestoneMarkers() {
            const container = document.getElementById('milestoneMarkers');
            // Clear any existing markers first
            container.innerHTML = '';
            const containerRadius = 140; // Distance from center to outer ring
            
            milestones.forEach(milestone => {
                // Only show milestones that are within the fast duration
                if (milestone.hours <= fastDuration) {
                    const marker = document.createElement('div');
                    marker.className = 'milestone-marker';
                    marker.dataset.hours = milestone.hours;
                    
                    // Calculate position on outer ring (12 o'clock = 0¬∞, clockwise)
                    const angle = (milestone.hours / fastDuration) * 360 - 90; // -90 to start at top
                    const radians = (angle * Math.PI) / 180;
                    const x = containerRadius + containerRadius * Math.cos(radians);
                    const y = containerRadius + containerRadius * Math.sin(radians);
                    
                    marker.style.left = x + 'px';
                    marker.style.top = y + 'px';
                    
                    // Add tooltip
                    const tooltip = document.createElement('div');
                    tooltip.className = 'milestone-tooltip';
                    tooltip.innerHTML = `<strong>${milestone.icon} ${milestone.title}</strong><br>${milestone.message}`;
                    marker.appendChild(tooltip);
                    
                    container.appendChild(marker);
                }
            });
        }
        
        // Track the last reached milestone to avoid repeated updates
        let lastReachedMilestone = null;
        
        // Update milestone states based on current progress
        function updateMilestoneStates() {
            const currentElapsedHours = elapsedTime / (1000 * 60 * 60);
            let currentMilestone = null;
            
            document.querySelectorAll('.milestone-marker').forEach(marker => {
                const milestoneHours = parseFloat(marker.dataset.hours);
                marker.classList.remove('reached', 'current');
                
                if (currentElapsedHours >= milestoneHours + 1) {
                    // Milestone completed (1 hour grace period)
                    marker.classList.add('reached');
                } else if (currentElapsedHours >= milestoneHours - 1 && currentElapsedHours < milestoneHours + 1) {
                    // Currently approaching or in milestone window
                    marker.classList.add('current');
                }
                
                // Check if we just reached this milestone
                if (currentElapsedHours >= milestoneHours && currentElapsedHours < milestoneHours + 1) {
                    // Find the milestone data
                    const milestone = milestones.find(m => m.hours === milestoneHours);
                    if (milestone) {
                        currentMilestone = milestone;
                    }
                }
            });
            
            // If we have a current milestone and it's different from the last one, update the display
            if (currentMilestone && currentMilestone !== lastReachedMilestone) {
                lastReachedMilestone = currentMilestone;
                updatePhaseInfoWithMilestone(currentMilestone);
            } else if (!currentMilestone && lastReachedMilestone) {
                // No current milestone, return to regular phase info
                lastReachedMilestone = null;
                const elapsedHours = Math.floor(elapsedTime / (1000 * 60 * 60));
                updatePhaseInfo(elapsedHours);
            } else if (!currentMilestone && !lastReachedMilestone) {
                // No milestone active, show regular phase info
                const phaseElapsedHours = Math.floor(elapsedTime / (1000 * 60 * 60));
                updatePhaseInfo(phaseElapsedHours);
            }
        }
        // Toggle duration selector visibility
        function toggleDurationSelector() {
            const selector = document.getElementById('durationSelector');
            const isVisible = selector.style.display !== 'none';
            
            if (isVisible) {
                selector.style.display = 'none';
            } else {
                selector.style.display = 'block';
            }
        }
        
        // Select a preset duration
        function selectDuration(hours) {
            selectedDuration = hours;
            
            // Update active state on buttons
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-hours="${hours}"]`).classList.add('active');
            
            // Clear custom input
            document.getElementById('customHours').value = '';
            
            // Update start button text
            updateStartButtonText();
        }
        
        // Apply custom duration
        function applyCustomDuration() {
            const customInput = document.getElementById('customHours');
            const customHours = parseInt(customInput.value);
            
            // Validation
            if (isNaN(customHours) || customHours < 1 || customHours > 168) {
                alert('Please enter a valid duration between 1 and 168 hours.');
                return;
            }
            
            selectedDuration = customHours;
            
            // Remove active state from preset buttons
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Update start button text
            updateStartButtonText();
        }
        
        // Toggle start time inputs visibility
        function toggleStartTimeInputs() {
            const startTimeRadios = document.querySelectorAll('input[name="startTime"]');
            const timeInputGroup = document.getElementById('timeInputGroup');
            const isCustomTime = Array.from(startTimeRadios).find(r => r.checked)?.value === 'custom';
            
            if (isCustomTime) {
                timeInputGroup.style.display = 'flex';
                // Set default to current time if not already set
                const startTimeInput = document.getElementById('startTimeInput');
                if (!startTimeInput.value) {
                    const currentTime = new Date();
                    startTimeInput.value = currentTime.toTimeString().slice(0, 5); // HH:MM format
                }
            } else {
                timeInputGroup.style.display = 'none';
                selectedStartTime = null;
            }
            
            updateSelectedStartTime();
            updateStartButtonText();
        }
        
        // Update selected start time based on inputs
        function updateSelectedStartTime() {
            const modeRadios = document.querySelectorAll('input[name="startTime"]');
            const selectedMode = Array.from(modeRadios).find(r => r.checked)?.value;
            
            if (selectedMode === 'now') {
                selectedStartTime = null;
            } else if (selectedMode === 'custom') {
                const customTimeInput = document.getElementById('startTimeInput');
                const dateOffset = parseInt(document.getElementById('startDateOffset').value);
                
                if (customTimeInput.value) {
                    const nowTime = new Date();
                    const [hours, minutes] = customTimeInput.value.split(':').map(Number);
                    
                    // Create date with selected time
                    const selectedDate = new Date(nowTime);
                    selectedDate.setHours(hours, minutes, 0, 0);
                    
                    // Apply date offset (0 = today, 1 = yesterday)
                    selectedDate.setDate(selectedDate.getDate() - dateOffset);
                    
                    // Validate - can't be in the future or more than 7 days ago
                    const maxBackdate = new Date(nowTime.getTime() - (7 * 24 * 60 * 60 * 1000)); // 7 days ago
                    
                    if (selectedDate > nowTime) {
                        selectedStartTime = null;
                        alert('Start time cannot be in the future!');
                        customTimeInput.value = '';
                    } else if (selectedDate < maxBackdate) {
                        selectedStartTime = null;
                        alert('Start time cannot be more than 7 days ago!');
                        customTimeInput.value = '';
                    } else {
                        selectedStartTime = selectedDate;
                    }
                }
            }
        }
        
        // Update start button text based on selected duration and start time
        function updateStartButtonText() {
            const btn = document.getElementById('startFastBtn');
            
            if (selectedStartTime) {
                const startTimeStr = selectedStartTime.toLocaleTimeString('en-US', {
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });
                btn.textContent = `Resume ${selectedDuration}h Fast (started ${startTimeStr})`;
            } else {
                btn.textContent = `Start ${selectedDuration}h Fast`;
            }
        }
        
        // Toggle start time adjustment controls
        function toggleStartTimeAdjustment() {
            const toggleAdjustmentRow = document.getElementById('startTimeAdjustment');
            const toggleAdjustBtn = document.getElementById('adjustStartBtn');
            
            if (toggleAdjustmentRow.style.display === 'none') {
                // Show adjustment controls
                toggleAdjustmentRow.style.display = 'block';
                toggleAdjustBtn.textContent = 'cancel';
                
                // Pre-populate with current start time
                const toggleTimeInput = document.getElementById('adjustTimeInput');
                const toggleDateOffset = document.getElementById('adjustDateOffset');
                
                toggleTimeInput.value = fastStartTime.toTimeString().slice(0, 5); // HH:MM
                
                // Calculate date offset
                const adjustToday = new Date();
                adjustToday.setHours(0, 0, 0, 0);
                const startDate = new Date(fastStartTime);
                startDate.setHours(0, 0, 0, 0);
                const daysDiff = Math.floor((adjustToday - startDate) / (24 * 60 * 60 * 1000));
                
                toggleDateOffset.value = Math.min(daysDiff, 2); // Cap at 2 days ago
            } else {
                // Hide adjustment controls
                cancelStartTimeAdjustment();
            }
        }
        
        // Apply start time adjustment
        function applyStartTimeAdjustment() {
            const adjustTimeInput = document.getElementById('adjustTimeInput');
            const adjustDateOffset = document.getElementById('adjustDateOffset');
            
            if (!adjustTimeInput.value) {
                alert('Please enter a start time.');
                return;
            }
            
            // Calculate new start time
            const adjustmentTime = new Date();
            const [hours, minutes] = adjustTimeInput.value.split(':').map(Number);
            const adjustmentDateOffset = parseInt(adjustDateOffset.value);
            
            const newStartTime = new Date(adjustmentTime);
            newStartTime.setHours(hours, minutes, 0, 0);
            newStartTime.setDate(newStartTime.getDate() - adjustmentDateOffset);
            
            // Validation
            const adjustmentMaxBackdate = new Date(adjustmentTime.getTime() - (7 * 24 * 60 * 60 * 1000));
            
            if (newStartTime > adjustmentTime) {
                alert('Start time cannot be in the future!');
                return;
            } else if (newStartTime < adjustmentMaxBackdate) {
                alert('Start time cannot be more than 7 days ago!');
                return;
            }
            
            // Update the fast start time
            fastStartTime = newStartTime;
            elapsedTime = Date.now() - fastStartTime.getTime();
            
            // Recalculate everything
            updateTimeDisplay();
            updateTimerDisplay();
            
            // Hide adjustment controls
            cancelStartTimeAdjustment();
        }
        
        // Cancel start time adjustment
        function cancelStartTimeAdjustment() {
            const cancelAdjustmentRow = document.getElementById('startTimeAdjustment');
            const cancelAdjustBtn = document.getElementById('adjustStartBtn');
            
            cancelAdjustmentRow.style.display = 'none';
            cancelAdjustBtn.innerHTML = '<small>adjust</small>';
        }
        
        // Start a fast
        async function startFast() {
            // Use selected duration for this fast
            fastDuration = selectedDuration;
            
            // Hide duration selector
            document.getElementById('durationSelector').style.display = 'none';
            
            document.getElementById('preFastState').style.display = 'none';
            document.getElementById('activeFastState').style.display = 'block';
            
            isRunning = true;
            // Use selected start time or current time
            fastStartTime = selectedStartTime || new Date();
            elapsedTime = selectedStartTime ? Date.now() - selectedStartTime.getTime() : 0;
            
            // Create fast entry in database
            await createFastEntry();
            
            // Create milestone markers
            createMilestoneMarkers();
            
            // Set start and end times
            updateTimeDisplay();
            
            // Initial display update
            updateTimerDisplay();
            
            // If backdated, immediately update milestone states to reflect elapsed time
            if (selectedStartTime) {
                updateMilestoneStates();
            }
            
            // Start the timer interval
            timerInterval = setInterval(() => {
                elapsedTime = Date.now() - fastStartTime.getTime();
                updateTimerDisplay();
                checkFastCompletion();
            }, 1000);
        }
        
        // End a fast
        async function endFast() {
            if (isRunning) {
                clearInterval(timerInterval);
                isRunning = false;
                
                // End fast entry in database
                await endFastEntry();
            }
            
            // Show completion state instead of going back to pre-fast
            showFastCompletion();
        }
        
        // Update timer display with elapsed/remaining logic
        function updateTimerDisplay() {
            const totalFastDuration = fastDuration * 60 * 60 * 1000; // Convert hours to milliseconds
            const remainingTime = Math.max(0, totalFastDuration - elapsedTime);
            const isShowingElapsed = elapsedTime <= totalFastDuration / 2;
            
            let displayTime, label;
            
            if (isShowingElapsed) {
                displayTime = elapsedTime;
                label = 'ELAPSED';
            } else {
                displayTime = remainingTime;
                label = remainingTime > 0 ? 'REMAINING' : 'COMPLETE';
            }
            
            const hours = Math.floor(displayTime / (1000 * 60 * 60));
            const minutes = Math.floor((displayTime % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((displayTime % (1000 * 60)) / 1000);
            
            // Show seconds for first hour, then switch to HH:MM
            const showSeconds = elapsedTime < (60 * 60 * 1000); // First 60 minutes
            
            if (showSeconds) {
                document.getElementById('timerDisplay').textContent = 
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            } else {
                document.getElementById('timerDisplay').textContent = 
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
            }
            
            document.getElementById('timerLabel').textContent = label;
            
            // Update triple-layer circular progress
            
            // Outer circle: Overall fast progress (24 hours)
            const overallProgressPercent = Math.min(100, (elapsedTime / totalFastDuration) * 100);
            const overallProgressDegrees = (overallProgressPercent / 100) * 360;
            document.getElementById('timerProgressOuter').style.background = 
                `conic-gradient(#ec4899 ${overallProgressDegrees}deg, #f0f0f0 ${overallProgressDegrees}deg)`;
            
            // Inner circle: Current hour progress (resets every hour)
            const millisecondsInHour = 60 * 60 * 1000;
            const currentHourProgress = (elapsedTime % millisecondsInHour) / millisecondsInHour;
            const hourProgressDegrees = currentHourProgress * 360;
            document.getElementById('timerProgressInner').style.background = 
                `conic-gradient(#fb923c ${hourProgressDegrees}deg, #f8f9fa ${hourProgressDegrees}deg)`;
            
            // Innermost circle: First minute and last minute logic
            const minuteElement = document.getElementById('timerProgressMinute');
            const radarPulse = document.getElementById('radarPulse');
            const millisecondsInMinute = 60 * 1000;
            // Use the remainingTime already calculated above
            
            if (elapsedTime <= millisecondsInMinute) {
                // First minute: Show progress and fade out pulse
                const minuteProgress = elapsedTime / millisecondsInMinute;
                const minuteProgressDegrees = minuteProgress * 360;
                
                minuteElement.classList.add('visible');
                minuteElement.style.background = 
                    `conic-gradient(#fcd34d ${minuteProgressDegrees}deg, #f8f9fa ${minuteProgressDegrees}deg)`;
                
                // Show radar pulse with fade out intensity over the minute (strong to weak)
                // Use a slower fade curve: stays strong until 75% through, then fades to 30%
                const firstMinutePulseIntensity = minuteProgress < 0.75 ? 
                    1 - (minuteProgress * 0.3) :  // Slow fade from 1.0 to 0.7 over first 75%
                    0.7 - ((minuteProgress - 0.75) / 0.25) * 0.4; // Faster fade from 0.7 to 0.3 over last 25%
                
                radarPulse.classList.add('visible');
                radarPulse.style.setProperty('--pulse-opacity', Math.max(0.3, firstMinutePulseIntensity));
                
            } else if (remainingTime <= millisecondsInMinute && remainingTime > 0) {
                // Last minute: Show progress and fade in pulse
                const lastMinuteProgress = (millisecondsInMinute - remainingTime) / millisecondsInMinute;
                const lastMinuteProgressDegrees = lastMinuteProgress * 360;
                
                minuteElement.classList.add('visible');
                minuteElement.style.background = 
                    `conic-gradient(#fcd34d ${lastMinuteProgressDegrees}deg, #f8f9fa ${lastMinuteProgressDegrees}deg)`;
                
                // Show radar pulse with fade in intensity over the last minute (weak to strong)
                // Start at 30% and build to full intensity more gradually
                const lastMinutePulseIntensity = lastMinuteProgress < 0.25 ? 
                    0.3 + (lastMinuteProgress / 0.25) * 0.4 : // Slow build from 0.3 to 0.7 over first 25%
                    0.7 + ((lastMinuteProgress - 0.25) / 0.75) * 0.3; // Build from 0.7 to 1.0 over last 75%
                    
                radarPulse.classList.add('visible');
                radarPulse.style.setProperty('--pulse-opacity', Math.min(1.0, lastMinutePulseIntensity));
                
            } else {
                // Hide minute ring and pulse during middle period
                minuteElement.classList.remove('visible');
                radarPulse.classList.remove('visible');
            }
            
            // Update milestone states and phase info
            updateMilestoneStates();
        }
        
        // Update start and end time display
        function updateTimeDisplay() {
            if (!fastStartTime) return;
            
            const startTime = fastStartTime;
            const endTime = new Date(fastStartTime.getTime() + (fastDuration * 60 * 60 * 1000));
            
            const formatDateTime = (date) => {
                const timeStr = date.toLocaleTimeString('en-US', { 
                    hour: 'numeric', 
                    minute: '2-digit',
                    hour12: true 
                });
                
                // Check if it's a different day to show date
                const today = new Date();
                const isToday = date.toDateString() === today.toDateString();
                const isTomorrow = date.toDateString() === new Date(today.getTime() + 24 * 60 * 60 * 1000).toDateString();
                
                if (isToday) {
                    return timeStr + ' (Today)';
                } else if (isTomorrow) {
                    return timeStr + ' (Tomorrow)';
                } else {
                    // Show abbreviated date for other days
                    const dateStr = date.toLocaleDateString('en-US', { 
                        month: 'short', 
                        day: 'numeric' 
                    });
                    return timeStr + ' (' + dateStr + ')';
                }
            };
            
            document.getElementById('startTime').textContent = formatDateTime(startTime);
            document.getElementById('endTime').textContent = formatDateTime(endTime);
        }
        
        // Update phase information based on elapsed hours
        function updatePhaseInfo(hours) {
            let currentPhase = phases[0];
            
            // Find the appropriate phase
            for (const phaseHour in phases) {
                if (hours >= parseInt(phaseHour)) {
                    currentPhase = phases[phaseHour];
                }
            }
            
            document.getElementById('phaseTitle').textContent = currentPhase.title;
            document.getElementById('phaseDescription').textContent = currentPhase.description;
        }
        
        // Update phase info container with milestone details
        function updatePhaseInfoWithMilestone(milestone) {
            document.getElementById('phaseTitle').textContent = `${milestone.icon} ${milestone.title}`;
            document.getElementById('phaseDescription').textContent = milestone.message;
        }
        
        
        
        // Reset timer
        function resetTimer() {
            if (isRunning) {
                clearInterval(timerInterval);
                isRunning = false;
            }
            
            // Clear milestone markers
            document.getElementById('milestoneMarkers').innerHTML = '';
            
            // Reset milestone tracking
            lastReachedMilestone = null;
            
            // Reset start time selection
            selectedStartTime = null;
            document.querySelector('input[name="startTime"][value="now"]').checked = true;
            document.getElementById('timeInputGroup').style.display = 'none';
            document.getElementById('startTimeInput').value = '';
            
            // Hide adjustment controls
            cancelStartTimeAdjustment();
            
            // Hide duration selector
            document.getElementById('durationSelector').style.display = 'none';
            
            // Reset to pre-fast state
            document.getElementById('activeFastState').style.display = 'none';
            document.getElementById('preFastState').style.display = 'block';
            
            elapsedTime = 0;
            fastStartTime = null;
        }
        
        // Load saved stats (placeholder for now)
        function loadStats() {
            // This would connect to user data in a real app
            document.getElementById('totalFasts').textContent = '0';
            document.getElementById('longestFast').textContent = '0h';
        }
        
        // Initialize user state and determine what to show
        async function initializeUserState() {
            try {
                const sessionId = localStorage.getItem('fastingForecast_sessionId');
                
                if (sessionId) {
                    // Check if user has any fasts in database
                    const response = await fetch(`/api/fasts?sessionId=${sessionId}&limit=1`);
                    if (response.ok) {
                        const fasts = await response.json();
                        
                        if (fasts.length === 0) {
                            // New user - show welcome state
                            showNewUserWelcome();
                        } else {
                            // User has completed fasts - check if they have actual scheduled fasts
                            // For now, we don't have scheduling feature, so assume no real schedule
                            const hasActualSchedule = false; // TODO: Replace when scheduling is implemented
                            
                            if (hasActualSchedule) {
                                // User has real scheduled fasts
                                showScheduledFastState();
                            } else {
                                // User has fasts but no schedule - encourage them to set up schedule
                                showScheduleSetupState();
                            }
                        }
                    } else {
                        // API error - default to new user welcome
                        showNewUserWelcome();
                    }
                } else {
                    // No session ID - definitely new user
                    showNewUserWelcome();
                }
            } catch (error) {
                console.error('Error checking user state:', error);
                // Default to new user welcome on error
                showNewUserWelcome();
            }
        }
        
        function showNewUserWelcome() {
            document.getElementById('newUserWelcome').style.display = 'block';
            document.getElementById('scheduleSetupState').style.display = 'none';
            document.getElementById('scheduledFastInfo').style.display = 'none';
            document.getElementById('newUserHint').style.display = 'block';
            
            // Show main start button
            document.getElementById('startFastBtn').style.display = 'block';
            
            // Update button text for new users
            document.getElementById('startFastBtn').textContent = 'Start Your First Fast';
        }
        
        function showScheduleSetupState() {
            document.getElementById('newUserWelcome').style.display = 'none';
            document.getElementById('scheduleSetupState').style.display = 'block';
            document.getElementById('scheduledFastInfo').style.display = 'none';
            document.getElementById('newUserHint').style.display = 'none';
            
            // Keep main start button visible as primary action
            document.getElementById('startFastBtn').style.display = 'block';
            document.getElementById('startFastBtn').textContent = 'Start Fast Now';
        }
        
        function showScheduledFastState() {
            document.getElementById('newUserWelcome').style.display = 'none';
            document.getElementById('scheduleSetupState').style.display = 'none';
            document.getElementById('scheduledFastInfo').style.display = 'block';
            document.getElementById('newUserHint').style.display = 'none';
            
            // Show main start button
            document.getElementById('startFastBtn').style.display = 'block';
            
            // Update button text for users with schedules
            document.getElementById('startFastBtn').textContent = 'Start 24h Fast';
            
            // TODO: Load actual scheduled fast data when scheduling feature is implemented
            // For now, keep the placeholder scheduled fast info
        }
        
        // Handle schedule setup button click
        function showScheduleSetup() {
            // TODO: Navigate to schedule setup page when implemented
            alert('üóìÔ∏è Schedule Setup Coming Soon!\n\nWe\'re building a smart scheduling system that will let you:\n\n‚Ä¢ Set regular fasting windows\n‚Ä¢ Plan around your calendar\n‚Ä¢ Get reminders and motivation\n‚Ä¢ Track your routine\n\nFor now, you can start individual fasts and we\'ll help you build the habit!');
        }
        
        // Confetti Animation
        function createConfetti() {
            const canvas = document.getElementById('confettiCanvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            const confettiPieces = [];
            const colors = ['#fcd34d', '#fb923c', '#ec4899', '#28a745', '#20c997'];
            
            // Create confetti pieces
            for (let i = 0; i < 150; i++) {
                confettiPieces.push({
                    x: Math.random() * canvas.width,
                    y: -10,
                    dx: (Math.random() - 0.5) * 4,
                    dy: Math.random() * 3 + 2,
                    rotation: Math.random() * 360,
                    rotationSpeed: (Math.random() - 0.5) * 10,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    shape: Math.random() > 0.5 ? 'rectangle' : 'circle',
                    size: Math.random() * 6 + 4
                });
            }
            
            let animationFrame;
            
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                for (let j = confettiPieces.length - 1; j >= 0; j--) {
                    const piece = confettiPieces[j];
                    
                    // Update position
                    piece.x += piece.dx;
                    piece.y += piece.dy;
                    piece.rotation += piece.rotationSpeed;
                    
                    // Add gravity
                    piece.dy += 0.15;
                    
                    // Apply air resistance
                    piece.dx *= 0.99;
                    
                    // Draw piece
                    ctx.save();
                    ctx.translate(piece.x, piece.y);
                    ctx.rotate(piece.rotation * Math.PI / 180);
                    ctx.fillStyle = piece.color;
                    
                    if (piece.shape === 'circle') {
                        ctx.beginPath();
                        ctx.arc(0, 0, piece.size / 2, 0, Math.PI * 2);
                        ctx.fill();
                    } else {
                        ctx.fillRect(-piece.size / 2, -piece.size / 2, piece.size, piece.size);
                    }
                    
                    ctx.restore();
                    
                    // Remove pieces that fall off screen
                    if (piece.y > canvas.height + 20) {
                        confettiPieces.splice(j, 1);
                    }
                }
                
                if (confettiPieces.length > 0) {
                    animationFrame = requestAnimationFrame(animate);
                } else {
                    // Hide canvas when animation is done
                    setTimeout(() => {
                        canvas.style.display = 'none';
                    }, 1000);
                }
            }
            
            canvas.style.display = 'block';
            animate();
        }
        
        // Calculate estimated calories burned during fasting
        function calculateCaloriesBurned(durationHours) {
            // Placeholder user profile (will be replaced with actual user data after onboarding)
            const userProfile = {
                weight: 160, // lbs
                bodyFatPercent: 25,
                activityLevel: 'sedentary' // sedentary, lightly_active, moderately_active, very_active, extremely_active
            };
            
            // Calculate lean body mass
            const weightKg = userProfile.weight * 0.453592;
            const leanBodyMassKg = weightKg * (1 - userProfile.bodyFatPercent / 100);
            
            // Calculate BMR using Katch-McArdle formula (based on lean body mass)
            const bmr = 370 + (21.6 * leanBodyMassKg);
            
            // Activity multipliers
            const activityMultipliers = {
                sedentary: 1.2,
                lightly_active: 1.375,
                moderately_active: 1.55,
                very_active: 1.725,
                extremely_active: 1.9
            };
            
            // Calculate TDEE
            const tdee = bmr * activityMultipliers[userProfile.activityLevel];
            const hourlyTdee = tdee / 24;
            
            // Apply fasting metabolic adjustments based on duration
            let totalCalories = 0;
            
            for (let hour = 0; hour < Math.ceil(durationHours); hour++) {
                let metabolicRate;
                
                if (hour < 12) {
                    metabolicRate = 0.95; // Minimal metabolic adaptation
                } else if (hour < 24) {
                    metabolicRate = 0.90; // Slight metabolic adaptation
                } else if (hour < 48) {
                    metabolicRate = 0.85; // Moderate metabolic adaptation
                } else {
                    metabolicRate = 0.80; // Significant metabolic adaptation
                }
                
                // For partial hours, calculate proportionally
                const hourFraction = hour < Math.floor(durationHours) ? 1 : (durationHours % 1);
                totalCalories += hourlyTdee * metabolicRate * hourFraction;
            }
            
            // Format with commas for readability
            return Math.round(totalCalories).toLocaleString();
        }
        
        // Get achieved milestones based on elapsed time
        function getAchievedMilestones(elapsedHours) {
            return milestones.filter(milestone => elapsedHours >= milestone.hours);
        }
        
        // Show fast completion state
        function showFastCompletion() {
            // Calculate final stats
            const finalElapsedHours = elapsedTime / (1000 * 60 * 60);
            const achievedMilestones = getAchievedMilestones(finalElapsedHours);
            
            // Update completion display
            const completionHours = Math.floor(finalElapsedHours);
            const completionMinutes = Math.floor((finalElapsedHours % 1) * 60);
            document.getElementById('completionDuration').textContent = 
                `${completionHours}:${String(completionMinutes).padStart(2, '0')}`;
            
            // Update calories
            document.getElementById('completionCalories').textContent = 
                `~${calculateCaloriesBurned(finalElapsedHours)}`;
            
            // Update milestones
            const milestonesContainer = document.getElementById('completionMilestones');
            milestonesContainer.innerHTML = '';
            
            if (achievedMilestones.length === 0) {
                milestonesContainer.innerHTML = '<p style="color: #666; font-style: italic;">Complete your first 12-hour milestone to see achievements here!</p>';
            } else {
                achievedMilestones.forEach(milestone => {
                    const milestoneEl = document.createElement('div');
                    milestoneEl.className = 'milestone-item';
                    milestoneEl.innerHTML = `
                        <div class="icon">${milestone.icon}</div>
                        <div class="info">
                            <div class="title">${milestone.title}</div>
                            <div class="time">Achieved at ${milestone.hours}h</div>
                        </div>
                    `;
                    milestonesContainer.appendChild(milestoneEl);
                });
            }
            
            // Hide active state and show completion
            document.getElementById('activeFastState').style.display = 'none';
            document.getElementById('completionState').style.display = 'block';
            
            // Trigger confetti animation
            createConfetti();
        }
        
        // Handle refeed notes CTA (placeholder)
        function openRefeedNotes() {
            // Placeholder - would open a modal or navigate to notes page
            alert('Refeed notes feature coming soon! üìù\n\nThis would allow you to log:\n‚Ä¢ How you feel post-fast\n‚Ä¢ Refeeding meal details\n‚Ä¢ Energy levels\n‚Ä¢ Any insights or observations');
        }
        
        // Start a new fast from completion screen
        function startNewFast() {
            // Hide completion state
            document.getElementById('completionState').style.display = 'none';
            
            // Reset all timer state
            if (isRunning) {
                clearInterval(timerInterval);
                isRunning = false;
            }
            
            // Clear milestone markers
            document.getElementById('milestoneMarkers').innerHTML = '';
            
            // Reset milestone tracking
            lastReachedMilestone = null;
            
            // Reset start time selection
            selectedStartTime = null;
            document.querySelector('input[name="startTime"][value="now"]').checked = true;
            document.getElementById('timeInputGroup').style.display = 'none';
            document.getElementById('startTimeInput').value = '';
            
            // Hide adjustment controls
            cancelStartTimeAdjustment();
            
            // Hide duration selector
            document.getElementById('durationSelector').style.display = 'none';
            
            // Show pre-fast state
            document.getElementById('preFastState').style.display = 'block';
            
            elapsedTime = 0;
            fastStartTime = null;
            
            // Update button text
            updateStartButtonText();
        }
        
        // Check for fast completion
        function checkFastCompletion() {
            if (!isRunning) return;
            
            const completionFastDuration = fastDuration * 60 * 60 * 1000;
            const completionRemainingTime = completionFastDuration - elapsedTime;
            
            // If fast is complete (remaining time <= 0)
            if (completionRemainingTime <= 0) {
                clearInterval(timerInterval);
                isRunning = false;
                showFastCompletion();
            }
        }
        
        // Initialize
        loadStats();
        
        // Bottom Navigation Functionality
        function updateActiveNavItem() {
            const currentPath = window.location.pathname;
            const navItems = document.querySelectorAll('.nav-item');
            
            navItems.forEach(item => {
                item.classList.remove('active');
                const href = item.getAttribute('href');
                
                // Set active state based on current path
                if (href === currentPath || (href === '/timer' && (currentPath === '/timer' || currentPath === '/timer.html'))) {
                    item.classList.add('active');
                }
            });
        }
        
        // Update navigation on page load
        document.addEventListener('DOMContentLoaded', () => {
            updateActiveNavItem();
            initializeUserState();
            
            // Add click handlers for navigation items
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    const href = item.getAttribute('href');
                    
                    // For now, prevent default navigation for pages that don't exist
                    if (href !== '/dashboard' && href !== '/timer' && href !== '/schedule') {
                        e.preventDefault();
                        
                        // Show a temporary message for unimplemented pages
                        const pageName = item.querySelector('.nav-label').textContent;
                        alert(`${pageName} page coming soon!`);
                    }
                });
            });
        });
        
        // Update active nav item when navigating (for SPA-style navigation in the future)
        window.addEventListener('popstate', updateActiveNavItem);
        
        // Database integration functions
        async function createFastEntry() {
            try {
                // Get session ID to link fast to user profile
                const sessionId = localStorage.getItem('fastingForecast_sessionId');
                console.log('Creating fast entry with sessionId:', sessionId);
                
                const fastData = {
                    start_time: fastStartTime.toISOString(),
                    notes: null,
                    weight: null,
                    is_manual: false,
                    sessionId: sessionId
                };
                
                console.log('Sending fast data:', fastData);
                
                const response = await fetch('/api/fasts/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(fastData)
                });
                
                if (response.ok) {
                    const fast = await response.json();
                    currentFastId = fast.id;
                    console.log('Fast entry created:', fast);
                } else {
                    console.error('Failed to create fast entry');
                }
            } catch (error) {
                console.error('Error creating fast entry:', error);
            }
        }
        
        async function endFastEntry() {
            if (!currentFastId) return;
            
            try {
                const endTime = new Date().toISOString();
                
                const response = await fetch(`/api/fasts/${currentFastId}/end`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ end_time: endTime })
                });
                
                if (response.ok) {
                    const fast = await response.json();
                    console.log('Fast entry completed:', fast);
                    currentFastId = null;
                } else {
                    console.error('Failed to end fast entry');
                }
            } catch (error) {
                console.error('Error ending fast entry:', error);
            }
        }
        
        // Check for active fast on page load
        async function checkForActiveFast() {
            try {
                const response = await fetch('/api/fasts/active');
                if (response.ok) {
                    const activeFast = await response.json();
                    if (activeFast) {
                        currentFastId = activeFast.id;
                        console.log('Found active fast:', activeFast);
                        // Could potentially restore timer state here if needed
                    }
                }
            } catch (error) {
                console.error('Error checking for active fast:', error);
            }
        }
        
        // Check for upcoming scheduled fast
        async function checkForUpcomingFast() {
            try {
                // Check for upcoming fast
                const upcomingResponse = await fetch(`/api/schedule/upcoming?sessionId=${sessionId}`);
                if (upcomingResponse.ok) {
                    const upcomingData = await upcomingResponse.json();
                    if (upcomingData.upcoming) {
                        showUpcomingFast(upcomingData.upcoming);
                    }
                }
                
                // Check if user has a schedule and hide setup prompt if they do
                const scheduleResponse = await fetch(`/api/schedule?sessionId=${sessionId}`);
                if (scheduleResponse.ok) {
                    const scheduleData = await scheduleResponse.json();
                    const scheduleSetupElement = document.getElementById('scheduleSetupState');
                    if (scheduleSetupElement) {
                        if (scheduleData.schedule) {
                            // User has a schedule, hide the setup prompt
                            scheduleSetupElement.style.display = 'none';
                        } else {
                            // User doesn't have a schedule, show the setup prompt
                            scheduleSetupElement.style.display = 'block';
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking for upcoming fast:', error);
            }
        }
        
        // Display upcoming fast information
        function showUpcomingFast(upcomingFast) {
            // Only show if no active timer (pre-timer page)
            if (isRunning) return;
            
            const startTime = new Date(upcomingFast.start_at_utc);
            const now = new Date();
            const hoursUntil = Math.round((startTime - now) / (1000 * 60 * 60));
            const isActionable = hoursUntil <= 6; // Within 6 hours = actionable with Start Early
            
            // Create upcoming fast display
            const upcomingDiv = document.getElementById('upcoming-fast-notice') || createUpcomingNotice();
            
            const dayName = startTime.toLocaleDateString('en-US', { weekday: 'short' });
            const timeStr = startTime.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
            
            // Format time until fast
            let timeUntilText = '';
            if (hoursUntil > 24) {
                const daysUntil = Math.round(hoursUntil / 24);
                timeUntilText = ` (in ${daysUntil} day${daysUntil === 1 ? '' : 's'})`;
            } else if (hoursUntil > 1) {
                timeUntilText = ` (in ${hoursUntil} hour${hoursUntil === 1 ? '' : 's'})`;
            } else if (hoursUntil === 1) {
                timeUntilText = ' (in 1 hour)';
            } else if (hoursUntil === 0) {
                timeUntilText = ' (starting now!)';
            }
            
            // Different styling and content based on actionability
            const label = isActionable ? 'Upcoming:' : 'Next:';
            const startEarlyButton = isActionable ? 
                `<button class="btn btn-start-early" onclick="startEarly('${upcomingFast.id}')">
                    Start Early
                </button>` : '';
            
            upcomingDiv.innerHTML = `
                <div class="upcoming-fast-content">
                    <div class="upcoming-text">
                        <strong>${label}</strong> ${dayName} ${timeStr}${timeUntilText}
                        <br><small>${upcomingFast.block_name || 'Scheduled Fast'} ‚Ä¢ ${upcomingFast.duration_hours}h</small>
                    </div>
                    ${startEarlyButton}
                </div>
            `;
            
            // Apply different CSS class based on actionability
            upcomingDiv.className = isActionable ? 'upcoming-fast-notice actionable' : 'upcoming-fast-notice informational';
            upcomingDiv.style.display = 'block';
        }
        
        // Create upcoming fast notice element (pre-timer page only)
        function createUpcomingNotice() {
            const upcomingDiv = document.createElement('div');
            upcomingDiv.id = 'upcoming-fast-notice';
            upcomingDiv.className = 'upcoming-fast-notice';
            upcomingDiv.style.display = 'none';
            
            // Insert before START FAST NOW button on pre-timer page
            const startButton = document.querySelector('.start-fast-btn') || 
                              document.querySelector('#startFastBtn') ||
                              document.querySelector('button[onclick="startFast()"]');
            if (startButton) {
                startButton.parentNode.insertBefore(upcomingDiv, startButton);
            } else {
                // Final fallback: add to body
                document.body.appendChild(upcomingDiv);
            }
            
            return upcomingDiv;
        }
        
        // Handle start early action
        async function startEarly(upcomingId) {
            try {
                console.log('Starting early for upcoming fast:', upcomingId);
                
                // Show a confirmation dialog first per spec
                const confirmEarly = confirm('Do you want to start your scheduled fast early? This will update today\'s plan.');
                if (!confirmEarly) {
                    return;
                }
                
                // Call the start early API
                const response = await fetch('/api/schedule/start-early', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        upcomingId: upcomingId
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Set the fast ID for tracking
                    currentFastId = result.fastId;
                    
                    // Start the timer UI
                    startTimer();
                    
                    // Hide the upcoming notice
                    const upcomingDiv = document.getElementById('upcoming-fast-notice');
                    if (upcomingDiv) {
                        upcomingDiv.style.display = 'none';
                    }
                    
                    console.log('Scheduled fast started early:', result);
                } else {
                    const error = await response.json();
                    alert('Failed to start early: ' + (error.error || 'Unknown error'));
                }
                
            } catch (error) {
                console.error('Error starting early:', error);
                alert('Failed to start early. Please try again.');
            }
        }
        
        // Check for active fast and upcoming fast when page loads
        checkForActiveFast();
        checkForUpcomingFast();
    </script>
    
    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="/schedule" class="nav-item" data-page="schedule">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
            <span class="nav-label">Schedule</span>
        </a>
        
        <a href="/dashboard" class="nav-item" data-page="dashboard">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="20" x2="18" y2="10"/>
                <line x1="12" y1="20" x2="12" y2="4"/>
                <line x1="6" y1="20" x2="6" y2="14"/>
            </svg>
            <span class="nav-label">Dashboard</span>
        </a>
        
        <a href="/timer" class="nav-item nav-primary active" data-page="timer">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="13" r="9"/>
                <polyline points="12,7 12,13 16,15"/>
                <path d="M9,2 L15,2"/>
                <path d="M12,2 L12,6"/>
            </svg>
            <span class="nav-label">Timer</span>
        </a>
        
        <a href="/learning" class="nav-item" data-page="learning">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
            </svg>
            <span class="nav-label">Learning Hub</span>
        </a>
        
        <a href="/more" class="nav-item" data-page="more">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="1"/>
                <circle cx="19" cy="12" r="1"/>
                <circle cx="5" cy="12" r="1"/>
            </svg>
            <span class="nav-label">More</span>
        </a>
    </nav>
</body>
</html>